<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo Homeopático | Catálogo Senior 2026</title>
    <meta name="keywords"
        content="homeopatia, homeopatía, productos hoemopáticos, comprar homeopatia medellin, precios medicamentos naturales colombia, distribuidor esencias florales latinoamerica, farmacia homeopatica certificada">
    <meta name="author" content="Mundo Homeopático">
    <meta name="description"
        content="Catálogo oficial de Mundo Homeopático 2026. Lista de precios de farmacia, multipotencias, esencias florales y red de distribuidores en Colombia.">

    <!-- Open Graph (WhatsApp, Facebook) -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mundohomeopatico.com/">
    <meta property="og:title" content="Mundo Homeopático - Lista de Precios 2026">
    <meta property="og:description"
        content="Consulta nuestra lista de precios actualizada y red de sedes en tiempo real.">
    <meta property="og:image" content="https://mundohomeopatico.com/img/logo-mundo-homeopatico.webp">

    <!-- SEO & GEO ROBUSTO - Mundo Homeopático 2026 -->
    <link rel="canonical" href="https://mundohomeopatico.com/">

    <!-- Geo Tags (Posicionamiento Local) -->
    <meta name="geo.region" content="CO-ANT" />
    <meta name="geo.placename" content="Medellín" />
    <meta name="geo.position" content="6.2608861;-75.5602183" />
    <meta name="ICBM" content="6.2608861, -75.5602183" />

    <!-- Twitter Cards (Social SEO) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Mundo Homeopático - Lista de Precios 2026">
    <meta name="twitter:description"
        content="Consulta nuestra lista de precios actualizada y red de sedes en tiempo real.">
    <meta name="twitter:image" content="https://mundohomeopatico.com/img/logo-mundo-homeopatico.webp">

    <!-- JSON-LD (Estructura de Negocio Local Principal) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Pharmacy",
      "name": "Mundo Homeopático",
      "image": "https://mundohomeopatico.com/img/logo-mundo-homeopatico.webp",
      "@id": "https://mundohomeopatico.com",
      "url": "https://mundohomeopatico.com",
      "telephone": "+573176680750",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "Carrera 49 # 64-06", 
        "addressLocality": "La Candelaria, Medellín",
        "addressRegion": "Antioquia",
        "postalCode": "050012",
        "addressCountry": "CO"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": 6.2608861,
        "longitude": -75.5602183
      },
      "openingHoursSpecification": {
        "@type": "OpeningHoursSpecification",
        "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
        "opens": "08:00",
        "closes": "18:00"
      },
      "sameAs": [
        "https://www.instagram.com/mundohomeopatico",
        "https://wa.me/573176680750"
      ]
    }
    </script>

    <!-- 
    ★ ARQUITECTURA MONOLÍTICA ESTRUCTURADA ★
    Este proyecto está diseñado intencionalmente como un SOLO ARCHIVO (index.html) para maximizar 
    la compatibilidad con GitHub Pages, facilitar el mantenimiento por IA y eliminar fricción de despliegue.
    
    ESTRUCTURA DE REGIONES (Usar "Fold" en el editor):
    1. INFRAESTRUCTURA (Meta & Libs)
    2. SISTEMA DE DISEÑO (CSS Scoped)
    3. ESTRUCTURA DE INTERFAZ (HTML Semántico)
    4. LÓGICA DE NEGOCIO (JS Modular)
    
    NO SEPARAR EN ARCHIVOS EXTERNOS sin una justificación técnica crítica (>3000 líneas).
    -->

    <!-- //#region 1. INFRAESTRUCTURA PROYECTO -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Karla:wght@400;500;700&family=Mulish:wght@400;600;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- //#endregion -->

    <style>
        /* 
        ==========================================================================
        ★ SISTEMA DE DISEÑO & ESTANDARIZACIÓN (FUENTE ÚNICA DE VERDAD) ★
        ==========================================================================
        
        IMPORTANTE PARA AGENTES DE IA Y DESARROLLADORES:
        Este proyecto utiliza un sistema de DESIGN TOKENS definido en :root. 
        NO utilizes valores "hardcoded" (ej. 24px, #ccc, 10px padding) directamente en las clases.
        SIEMPRE usa las variables semánticas definidas a continuación.
        
        LÓGICA DE VARIABLES:
        1. Branding & Colores: --primary, --secondary, etc.
        2. tokens de Componentes (--p-*): Padding específico para Header, Sidebar, Tablas.
        3. tokens Visuales: --border-*, --radius-*, --shadow-*.
        4. Tipografía: --fw-*, --lh-*.

        Si necesitas cambiar el espaciado de una tabla, NO edites la clase .data-grid.
        EDITA la variable --p-table-cell en :root.
        ==========================================================================
        
        ARQUITECTURA & REGLAS DE COHERENCIA:
        1. SEPARACIÓN DE RESPONSABILIDADES:
           - HTML: Solo estructura y semántica (ej: .main-header). NO usar utilidades de estilo si existe una clase semántica.
           - CSS: Controla TODO el aspecto visual y el layout. Responde a estados (.is-open, .active).
           - JS: Controla la lógica y el estado. Solo añade/quita clases de estado, NO inyecta estilos inline ni clases de utilidad.
        
        2. ESTADOS:
           - Usar .is-open, .is-active, .has-error para variantes.
           - Evitar style.display = 'none' en JS; usar clases de estado.
        ==========================================================================
        */

        /* //#region 2. SISTEMA DE DISEÑO (CSS) */
        :root {
            /* Branding: Paleta "Earthy Sophistication" 2026 */
            --bg-main: #F0F7F0;
            /* Verde Salvia Hielo (Main Background) */
            --bg-surface: #ffffff;
            /* Superficies (Cards/Sidebar) */
            --slate-50: var(--bg-main);
            /* Mapping legacy variable */

            --primary: #9CAF88;
            /* Verde Salvia */
            --primary-dark: #8A9D76;
            --primary-light: #E8F0E4;
            --primary-vibrant: #00C16C;
            /* Verde Tech Moderno (Vibrante) */

            --secondary: #1A292F;
            /* Azul Marino Profundo (Texto/Titulos) */
            --text-body: #4A5568;
            /* Gris suave legible */
            --accent: #D1835C;
            /* Terracota Suave (CTA) */

            --border-soft: #DEBDA6;
            /* Taupe Cálido */
            --border-color: var(--border-soft);

            /* Compatibilidad Legacy */
            --slate-100: #F3F4F6;
            --slate-200: #E2E8F0;
            --slate-400: #94A3B8;
            --text-primary: var(--secondary);

            /* Grid System (Medidas Matemáticas de imagen adjunta) */
            --sidebar-w: 280px;
            --radius: 24px;
            /* Radio de curvatura estándar */

            /* SISTEMA DE ESPACIADO ESTANDARIZADO (Escala 4px/8px) */
            --space-xs: 0.25rem;
            /* 4px */
            --space-s: 0.5rem;
            /* 8px */
            --space-m: 1rem;
            /* 16px */
            --space-l: 1.5rem;
            /* 24px */
            --space-xl: 2rem;
            /* 32px */
            --space-xxl: 4rem;
            /* 64px */

            /* SISTEMA TIPOGRÁFICO (Nueva Propuesta 2026: Mulish + Karla) */
            --font-heading: 'Mulish', sans-serif;
            --font-body: 'Karla', sans-serif;
            /* Compatibilidad hacia atrás */
            --font-display: var(--font-heading);

            /* ESCALA TIPOGRÁFICA (Design Specs v2) */
            --font-xs: 12px;
            /* Sidebar Agrupadores / Table Headers */
            --font-sm: 14px;
            /* Sidebar N2/N3 / Table Content / Buttons */
            --font-base: 15px;
            /* Sidebar L1 / Precios */
            --font-md: 16px;
            /* Table Titles / Descripciones N1 */
            --font-lg: 18px;
            /* Agrupadores Panel Principal */
            --font-xl: 24px;
            /* Títulos N1 */
            --font-2xl: 34px;
            /* H1 Página Principal */

            --header-h: 80px;
            --mobile-header-h: 64px;

            /* DISTRIBUIDORES - SISTEMA ESTANDARIZADO REESTRUCTURACION */
            --dist-card-bg: white;
            --dist-card-border: var(--slate-200);
            --dist-card-radius: 1rem;
            --dist-primary-bg: linear-gradient(to bottom right, #ecfdf5, white);
            --dist-primary-border: var(--primary);
            --dist-primary-radius: 1.5rem;
            --dist-whatsapp-bg: #22c55e;
            --dist-whatsapp-hover: #16a34a;
            --btn-py: 0.75rem;
            --btn-px: 1rem;

            /* TOKENS SEMÁNTICOS */
            --p-header-v: 0.8rem;
            --p-header-h: clamp(1rem, 5%, 2rem);
            --p-sidebar: 2rem;

            --p-nav-item-v: 0.75rem;
            --p-nav-item-h: 1.25rem;

            --p-card: 2.5rem;
            --align-offset: 24px;

            --border-color-soft: var(--slate-200);
            --border-color-strong: #747775;
            --border-width-std: 1px;

            --fw-bold: 700;
            --lh-title: 1.2;

            /* TOKENS DE TABLAS */
            --p-table-cell: 12px 16px;

            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --radius-full: 999px;

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-soft: 0 20px 40px -10px rgba(26, 41, 47, 0.08);
            /* Sombra Suave Premium */
        }

        body {
            font-family: var(--font-body);
            background: var(--slate-50);
            color: var(--secondary);
            -webkit-font-smoothing: antialiased;
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        h1,
        h2,
        h3,
        h4,
        .font-display {
            font-family: var(--font-heading);
        }

        .app-layout {
            display: block;
            width: 100%;
            min-height: 100vh;
            background: var(--slate-50);
        }

        /* Estructura SPA Global */
        .main-header {
            height: var(--header-h);
            background: #fff;
            border-bottom: 1px solid var(--slate-200);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0;
            box-shadow: var(--shadow-sm);
        }

        .main-sidebar {
            width: var(--sidebar-w);
            height: calc(100vh - var(--header-h));
            position: fixed;
            top: var(--header-h);
            left: 0;
            background: #fff;
            border-right: var(--border-width-std) solid var(--border-color-soft);
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 90;
            padding: 0.75rem 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .main-sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .main-sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .main-sidebar::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border-radius: 10px;
        }

        .main-sidebar::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }

        #sidebar-catalog-view,
        #sidebar-contact-view {
            padding: 0;
        }

        .main-content-wrapper {
            margin-left: var(--sidebar-w);
            margin-top: var(--header-h);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        html {
            scroll-padding-top: calc(var(--header-h) + 20px);
        }

        .banner-wrapper {
            position: relative;
            display: block;
            background: #fffbeb;
            border-bottom: 1px solid #fef3c7;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 400px;
            overflow: hidden;
            opacity: 1;
            flex-shrink: 0;
        }

        .banner-wrapper.collapsed {
            max-height: 0;
            border: none;
            opacity: 0;
            pointer-events: none;
        }

        .btn-base {
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.8em;
            border-radius: 999px;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            --button-height: 2.8em;
            height: var(--button-height);
            padding: 0.35em;
        }

        .btn-base:has(> i:last-child),
        .btn-base:has(> svg:last-child) {
            padding-left: 1.5em;
            padding-right: 0.35em;
        }

        .btn-base i:last-child {
            margin-left: auto;
        }

        .btn-base:has(> i:first-child),
        .btn-base:has(> svg:first-child) {
            padding-left: 0.35em;
            padding-right: 1.5em;
        }

        .btn-base i,
        .btn-base svg {
            width: 2.1em;
            height: 2.1em;
            padding: 0.55em;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            stroke-width: 2.5px;
            flex-shrink: 0;
            display: block;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--secondary);
            /* Azul Noche (Sobrio en reposo) */
            color: white;
            font-size: var(--font-sm);
            letter-spacing: 0.05em;
            border-radius: 999px;
            min-height: 44px;
            /* Zona táctil mínima */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary:hover {
            background: var(--primary-vibrant);
            transform: translateY(-1px);
            box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:hover i {
            background-color: rgba(0, 0, 0, 0.2);
            transform: rotate(-15deg) scale(1.05);
        }

        /* Sidebar Labels */
        .sidebar-label-l1 {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            margin-top: 1.5rem;
            font-size: var(--font-base);
            /* 15px */
            font-weight: 600;
            /* SemiBold */
            color: var(--secondary);
            text-transform: none;
            letter-spacing: -0.01em;
            width: 100%;
        }

        #sidebar-menu>.sidebar-label-l1:first-child {
            margin-top: 0;
            border-top: none;
        }

        .sidebar-subtitle-context {
            font-size: var(--font-sm);
            /* 14px */
            color: #64748b;
            font-weight: 500;
            /* Medium */
            padding: 4px 0.75rem;
            margin-top: 4px;
            margin-bottom: 2px;
            text-transform: none;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0.6rem 0.75rem;
            margin: 2px 0;
            width: 100%;
            font-size: var(--font-sm);
            /* 14px */
            font-weight: 500;
            color: #334155;
            text-decoration: none;
            cursor: pointer;
            border: none;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }

        .sidebar-link:hover {
            background-color: var(--slate-100);
            color: var(--secondary);
            font-weight: 500;
        }

        .sidebar-link.active {
            background-color: var(--emerald-50);
            color: var(--primary-vibrant);
            /* Texto vivo al seleccionar */
            font-weight: 600;
        }

        .sidebar-link i,
        .sidebar-item-accordion i {
            width: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            text-align: center;
        }

        .sidebar-item-accordion {
            width: 100%;
            display: flex;
            justify-content: start;
            align-items: center;
            gap: 12px;
            padding: 0.6rem 0.75rem;
            /* Mismo padding */
            margin: 2px 0;
            font-size: var(--font-sm);
            font-weight: 500;
            /* Medium */
            color: #334155;
            /* Slate-700 (Unificado con Links) */
            background: transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .sidebar-item-accordion:hover {
            background: var(--slate-100);
            color: var(--secondary);
        }

        .sidebar-accordion-content {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 1px solid transparent;
            margin-left: 22px;
            margin-bottom: 0;
        }

        .sidebar-accordion-content.is-open {
            grid-template-rows: 1fr;
            border-left-color: var(--slate-200);
            margin-bottom: 8px;
        }

        .sidebar-accordion-inner {
            overflow: hidden;
            padding-left: 24px;
            padding-top: 4px;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.2s ease;
        }

        .sidebar-accordion-content.is-open .sidebar-accordion-inner {
            opacity: 1;
            transform: translateY(0);
        }

        .sidebar-link.child-link {
            font-size: var(--font-xs);
            /* 12px */
            color: #64748b;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            /* Radio más pequeño para hijos */
            transition: all 0.2s ease;
        }

        /* Hover para hijos (Sombreado igual al padre) */
        .sidebar-link.child-link:hover {
            background-color: var(--slate-100);
            color: var(--secondary);
            font-weight: 500;
        }

        /* Active para hijos (Seleccionado) */
        .sidebar-link.child-link.active {
            background-color: var(--emerald-50);
            color: var(--primary-vibrant);
            font-weight: 600;
        }

        @media (max-width: 768px) {

            .sidebar-link,
            .sidebar-item-accordion {
                padding: 1rem;
                /* ZONA DEL PULGAR: Hit area mas grande */
                margin: 4px 0;
            }

            .sidebar-link.child-link {
                padding: 12px 16px;
                /* Mejor toque en sub-items */
            }
        }

        .sidebar-n2-parent {
            padding: var(--space-s) 0 var(--space-xs) 0;
            font-size: var(--font-sm);
            font-weight: 800;
            color: var(--slate-400);
            letter-spacing: 0.05em;
        }

        .catalog-card {
            background: var(--bg-surface);
            border-radius: 16px;
            /* 1rem Soft Rounded */
            border: 1px solid var(--border-soft);
            padding: var(--p-card);
            box-shadow: var(--shadow-soft);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .catalog-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(26, 41, 47, 0.12);
            /* Lift effect */
        }

        .data-grid-container,
        .notes-container {
            border-radius: var(--radius-md);
            border: 1px solid #e0e0e0;
            background: white;
            margin-top: 0.5rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .notes-container {
            padding: 1rem;
        }

        .data-grid {
            border-collapse: collapse;
            width: 100%;
        }

        .data-grid th {
            background: white;
            padding: var(--p-table-cell);
            text-align: left;
            font-size: var(--font-xs);
            /* 12px */
            font-weight: 700;
            /* Bold */
            color: #6B7280;
            /* Gris Specs */
            text-transform: uppercase;
            border-bottom: 1px solid #747775;
            /* Header Strong */
            letter-spacing: 0.05em;
        }

        .data-grid td {
            padding: var(--p-table-cell);
            border-bottom: 1px solid #c7c7c7;
            font-size: var(--font-sm);
            /* 14px */
            font-weight: 400;
            /* Regular */
            color: #202124;
            vertical-align: middle;
        }

        /* PRICE CELL: Columna de precio destacada */
        .data-grid td:nth-last-child(1),
        .data-grid td.price-cell {
            font-weight: 600;
            /* SemiBold */
            font-size: var(--font-base);
            /* 15px */
            color: #111827;
        }

        .data-grid tr:last-child td {
            border-bottom: none;
        }

        .data-grid tr:hover td {
            background-color: var(--slate-100);
            cursor: pointer;
        }

        .data-grid th.text-right,
        .data-grid td.text-right {
            text-align: right;
        }

        .data-grid th.text-right,
        .data-grid td.text-right {
            text-align: right;
            padding-right: 24px;
        }

        /* Anchos FIJOS para columnas de precios (Alineación consistente) */
        .data-grid th:nth-child(2),
        .data-grid td:nth-child(2) {
            width: 160px;
            min-width: 160px;
            max-width: 160px;
            white-space: nowrap;
        }

        .data-grid th:nth-child(3),
        .data-grid td:nth-child(3) {
            width: 160px;
            min-width: 160px;
            max-width: 160px;
            white-space: nowrap;
        }

        /* Ajuste para el nombre del producto (Negrita suave como Drive) */
        .product-name {
            font-weight: 500;
            color: #202124;
        }

        /* BARRA DE PROGRESO SUPERIOR (Estilo YouTube/GitHub) */
        .top-progress-bar {
            position: absolute;
            /* Cambiado a Absolute dentro del header */
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            z-index: 200;
            width: 0;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 1px 4px rgba(16, 185, 129, 0.4);
            /* Transición solo para opacidad y cierre */
            transition: opacity 0.3s ease;
        }


        @keyframes progressLoading {
            0% {
                width: 0%;
            }

            10% {
                width: 15%;
            }

            30% {
                width: 45%;
            }

            60% {
                width: 75%;
            }

            100% {
                width: 95%;
            }
        }

        .top-progress-bar.loading {
            opacity: 1;
            /* Animación de 2.5s que se queda en el 95% (forwards) */
            animation: progressLoading 2.5s cubic-bezier(0.2, 0.5, 0.2, 1) forwards;
        }

        .top-progress-bar.complete {
            width: 100% !important;
            opacity: 0;
            font-weight: 500;
            transition: all 0.2s;
        }

        /* 
           MATH BUTTONS: Alineación Óptica Avanzada 
           Referencia: Technology Checkmark Image
        */
        .btn-math {
            --py: 0.65rem;
            /* Padding vertical base (ajustable) */
            --font-size: 0.875rem;
            /* o var(--font-sm) */

            /* Fórmula Mágica: Calcula el padding lateral basado en la geometría de la fuente */
            /* 1lh = Line Height, 1cap = Cap Height (Altura de mayúscula) */
            /* Fallback para 1cap si no soportado: 0.7em */
            --px: calc(var(--py) + (1.5em - 0.7em) / 2);

            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            /* Espacio entre texto e icono */

            font-size: var(--font-size);
            line-height: 1.5;
            /* 1lh */
            padding: var(--py) var(--px);

            border-radius: 0.5rem;
            /*Rounded-lg*/
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.01em;
        }

        /* Icono a la derecha: Ajuste matemático para equidistancia al borde */
        /* Margen negativo para anular el exceso de px y dejar solo py de espacio visual */
        .btn-math.icon-right i,
        .btn-math.icon-right svg {
            margin-right: calc(var(--py) - var(--px));
            /* A veces el gap suma, así que ajustamos sutilmente */
            margin-left: 0.25rem;
        }

        /* Icono a la izquierda */
        .btn-math.icon-left i,
        .btn-math.icon-left svg {
            margin-left: calc(var(--py) - var(--px));
            margin-right: 0.25rem;
        }

        /* Variantes de Color (Abstracción) */
        /* Variantes de Color para Botones Matemáticos */
        .btn-emerald {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
        }

        .btn-emerald:hover {
            background-color: #059669;
            /* emerald-600 */
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(16, 185, 129, 0.3);
        }

        .btn-slate {
            background-color: var(--slate-200);
            color: var(--slate-600);
        }

        .btn-slate:hover {
            background-color: var(--primary);
            /* Verde Institucional igual que 'Sitio web' */
            color: #fff;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            /* Glow verde sutil */
        }

        .btn-emerald-soft {
            background-color: #d1fae5;
            /* emerald-100 */
            color: #065f46;
            /* emerald-800 */
        }

        .btn-emerald-soft:hover {
            background-color: #a7f3d0;
            /* emerald-200 */
        }

        /* Botón Oscuro -> Verde (Estilo "Como Antes" + Math) */
        .btn-dark-pill {
            background-color: var(--secondary);
            /* Dark default */
            color: white;
            border-radius: 9999px;
            /* Pill shape (redondeado como antes) */
            box-shadow: 0 4px 6px -1px rgba(15, 23, 42, 0.1);
        }

        .btn-dark-pill:hover {
            background-color: var(--primary);
            /* Green on hover */
            box-shadow: 0 6px 12px -2px rgba(16, 185, 129, 0.3);
            /* Green glow */
            transform: translateY(-1px);
        }

        /* Botón con Flecha Dinámica (Micro-interacción Premium) */
        .btn-dynamic-arrow {
            --primary-color: var(--secondary);
            --secondary-color: #fff;
            --hover-color: var(--primary);
            --arrow-width: 10px;
            --arrow-stroke: 2px;
            box-sizing: border-box;
            border: 0;
            border-radius: 999px;
            color: var(--secondary-color);
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            display: inline-flex;
            transition: 0.2s all;
            align-items: center;
            gap: 0.6em;
            font-weight: 700;
            cursor: pointer;
            font-size: var(--font-sm);
            line-height: 1;
        }

        .btn-dynamic-arrow .arrow-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-dynamic-arrow .arrow {
            margin-top: 1px;
            width: var(--arrow-width);
            background: var(--primary-color);
            height: var(--arrow-stroke);
            position: relative;
            transition: 0.2s;
        }

        .btn-dynamic-arrow .arrow::before {
            content: "";
            box-sizing: border-box;
            position: absolute;
            border: solid var(--secondary-color);
            border-width: 0 var(--arrow-stroke) var(--arrow-stroke) 0;
            display: inline-block;
            top: -3px;
            right: 3px;
            transition: 0.2s;
            padding: 3px;
            transform: rotate(-45deg);
        }

        .btn-dynamic-arrow:hover {
            background-color: var(--hover-color);
            transform: translateY(-1px);
            box-shadow: 0 10px 20px -10px var(--primary);
        }

        .btn-dynamic-arrow:hover .arrow {
            background: var(--secondary-color) !important;
        }

        .btn-dynamic-arrow:hover .arrow:before {
            right: 0;
        }

        /* From Uiverse.io by alshahwan - Adaptado a UI/UX Mundo Homeopático */
        .btn-uiverse {
            background-color: var(--slate-200);
            /* Igualando al btn-slate */
            border: none;
            /* Eliminamos borde para limpiar el estilo */
            /* Gris neutro como el buscador */
            padding: 0 1.5rem;
            /* Ajuste padding lateral */
            position: relative;
            width: 100%;
            height: 3.2rem;
            transition: all 0.3s ease;
            font-size: 15px;
            /* Ligeramente más pequeño para elegancia */
            border-radius: 0.75rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
            /* Alineamos contenido a la izquierda */
            text-decoration: none;
            overflow: hidden;
            gap: 12px;
            /* Espacio entre icono y texto */
        }

        .btn-uiverse p {
            margin: 0;
            padding: 0;
            transition: color 0.3s ease;
            color: #64748b;
            /* Texto gris pizarra medio */
            font-weight: 600;
        }

        .btn-uiverse svg,
        .btn-uiverse i {
            /* Agrego soporte para i (Lucide) */
            margin: 0;
            padding: 0;
            opacity: 1;
            /* Siempre visible */
            transition: all 0.3s ease;
            height: 1.1em;
            width: 1.1em;
            color: #64748b;
            /* Color base igual al texto */
        }

        .btn-uiverse:hover p {
            color: #fff;
        }

        .btn-uiverse:hover svg,
        .btn-uiverse:hover i {
            color: #fff;
            transform: scale(1.1);
            /* Efecto sutil */
        }

        .btn-uiverse:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Colores Específicos de Interacción */
        .btn-uiverse.btn-inst:hover {
            background-color: #E1306C;
            /* Rosa Instagram */
            border-color: #E1306C;
            box-shadow: 0 4px 12px rgba(225, 48, 108, 0.3);
        }

        .btn-uiverse.btn-web:hover {
            background-color: var(--primary);
            /* Verde Institucional */
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* RENDERIZADOR SEMÁNTICO (Clases para JS) */


        .section-container {
            margin-top: 3rem;
            /* Reduced from 5rem */
        }

        .section-title-l1 {
            font-size: 1.75rem;
            /* Mobile first: 28px */
            font-weight: 900;
            color: var(--secondary);
            margin-bottom: 0.5rem;
            line-height: 1;
            letter-spacing: -0.05em;
        }

        @media (min-width: 768px) {
            .section-title-l1 {
                font-size: 2.25rem;
                /* Desktop: 36px */
            }
        }

        .section-desc-l1 {
            font-size: var(--font-sm);
            color: #64748b;
            font-weight: 500;
            margin-left: 0;
            padding-left: var(--align-offset);
            /* 24px Exactos */
            margin-bottom: 1.5rem;
            /* Compactado de 2rem */
            max-width: 90%;
            /* Ampliado para aprovechar ventana */
            line-height: 1.6;
        }

        .group-container {
            margin-bottom: 1.5rem;
            /* Compactado de 2rem */
            margin-left: 0;
            padding-left: var(--align-offset);
            /* 24px Exactos */
        }

        .group-header {
            margin-bottom: 0.75rem;
            /* Compactado de 1rem */
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--slate-100);
            margin-right: 2rem;
        }

        .group-title {
            font-size: 1.125rem;
            /* 18px Estandarizado */
            font-weight: 500;
            /* No Bold */
            color: var(--secondary);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Subtítulos Intermedios (Contextuales) - ESTILO LIMPIO */
        .subtitulo-container {
            margin-bottom: 1.5rem;
            padding-left: var(--align-offset);
            /* 24px Exactos */
            margin-top: -0.5rem;
        }

        .subtitulo-title {
            font-size: 1.125rem;
            /* 18px Estandarizado */
            font-weight: 500;
            /* No Bold */
            color: var(--secondary);
            margin-bottom: 0.25rem;
            letter-spacing: 0.05em;
            /* Removed uppercase */
            opacity: 0.9;
        }

        .subtitulo-desc {
            font-size: var(--font-sm);
            color: #64748b;
            line-height: 1.6;
            max-width: 90%;
            /* Ampliado para aprovechar ventana */
            font-weight: 500;
        }

        .l2-container {
            margin-bottom: 2rem;
            margin-top: 2rem;
            /* Proximidad mejorada: Antes 4rem */
            scroll-margin-top: 8rem;
        }

        .l2-title {
            font-size: 1.875rem;
            font-weight: 900;
            color: var(--secondary);
            margin-bottom: 0.25rem;
            /* Pegado a su contenido */
        }

        .distributor-card {
            background: linear-gradient(135deg, #065f46 0%, #10b981 100%);
            color: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            margin-top: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Bloques móviles antiguos eliminados para evitar conflictos */

        .professional-only {
            display: none !important;
        }

        body.professional-mode .professional-only {
            display: table-cell !important;
        }

        /* Bloque profesional móvil antiguo eliminado */

        .animate-fade-in {
            animation: fadeIn 0.7s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none !important;
        }

        /* 
        ==========================================================================
        ★ OPTIMIZACIÓN MÓVIL (MOBILE-FIRST RESPONSIVENESS) ★
        ==========================================================================
        Basado en especificaciones de codigo_mobile.txt
        */
        @media (max-width: 1024px) {
            :root {
                --header-h: var(--mobile-header-h);
                --sidebar-w: 280px;
                --align-offset: 16px;
                --p-card: 1.5rem;
            }

            body {
                overflow-x: hidden;
            }

            .main-header {
                height: var(--header-h);
            }

            .header-content {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            .header-content h1 {
                font-size: 1rem;
                line-height: 1.1;
                display: none;
                /* Ocultar texto en móviles muy pequeños */
            }

            @media (min-width: 380px) {
                .header-content h1 {
                    display: block;
                }
            }

            .header-content img {
                height: 2rem;
            }

            .main-sidebar {
                top: 0;
                height: 100vh;
                z-index: 2100;
                transform: translateX(-102%);
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 20px 0 50px rgba(0, 0, 0, 0.2);
                border-right: none;
                padding-top: 2rem;
            }

            .main-sidebar.is-open {
                transform: translateX(0);
            }

            .main-content-wrapper {
                margin-left: 0 !important;
                margin-top: var(--header-h);
                width: 100%;
                overflow-x: hidden;
            }

            /* Fix Search Bar on Mobile */
            .search-container {
                margin-top: 1rem;
            }

            /* Responsive Tables */
            .data-grid-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin-left: -1rem;
                margin-right: -1rem;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }

            .data-grid {
                min-width: 600px;
                /* Asegura que la tabla no se colapse pero sea scrollable */
                border-collapse: separate;
            }

            .data-grid th,
            .data-grid td {
                padding: 12px 10px;
                white-space: normal;
            }

            /* Reset fixed widths in mobile for better flow */
            .data-grid th:nth-child(2),
            .data-grid td:nth-child(2),
            .data-grid th:nth-child(3),
            .data-grid td:nth-child(3) {
                width: 90px !important;
                min-width: 90px !important;
                max-width: 90px !important;
            }

            .catalog-card {
                padding: 1.25rem;
                border-radius: var(--radius-md);
            }

            #navToggleButton {
                font-size: 11px;
                padding: 0.6rem 1rem;
            }

            #navButtonText {
                display: none;
                /* Hide text, keep icon or show shorter text */
            }

            #navButtonText::before {
                content: 'Sedes';
                display: inline;
            }

            /* Section Titles */
            .section-title-l1 {
                font-size: 1.5rem;
                padding: 0 1rem;
            }

            .section-desc-l1 {
                padding-left: 1rem;
                max-width: 100%;
            }

            .group-container,
            .subtitulo-container {
                padding-left: 1rem;
            }

            .group-header {
                margin-right: 1rem;
            }

            /* Footer Mobile */
            .footer-grid {
                grid-template-columns: 1fr !important;
                text-align: center;
                gap: 2rem;
            }
        }

        /* Overlay fix */
        #mobileOverlay {
            transition: opacity 0.4s ease;
            pointer-events: none;
            opacity: 0;
            z-index: 2000;
        }

        #mobileOverlay.show {
            opacity: 1;
            pointer-events: auto;
            display: block !important;
        }



        /* //#endregion */

        /* //#region Componentes Estandarizados */
        .search-container {
            position: relative;
            margin-bottom: var(--space-m);
        }

        .search-input {
            width: 100%;
            padding: var(--space-s) var(--space-m) var(--space-s) 2.5rem;
            background: var(--slate-100);
            border: var(--border-width-std) solid var(--border-color-soft);
            border-radius: var(--radius-sm);
            font-size: var(--font-sm);
            font-weight: 500;
            outline: none;
            transition: all 0.2s;
            color: var(--secondary);
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            background: white;
        }

        /* Saludo de Usuario */
        #userGreeting:not(.hidden) {
            min-width: 320px;
            /* Ancho amplio para nombres largos */
            white-space: nowrap;
            /* Evita saltos de línea */
            display: flex !important;
            /* CRÍTICO: Mantiene todo en línea horizontal */
            flex-direction: row !important;
            gap: 16px !important;
            /* Espacio cómodo entre nombre y botón */
            justify-content: flex-end !important;
            /* Alineado a la DERECHA para consistencia */
        }

        #greetingText {
            white-space: nowrap;
            /* Mantiene el nombre en una sola línea */
            overflow: hidden;
            text-overflow: ellipsis;
            /* Si es MUY largo, muestra ... */
            max-width: 250px;
            /* Máximo antes de cortarse con ... */
        }

        /* Botón de Salir (Logout) */
        .logout-button {
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
            padding: 6px 12px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            color: #64748b !important;
            border-radius: 8px !important;
            transition: all 0.2s !important;
            background: none !important;
            border: none !important;
            cursor: pointer !important;
            flex-shrink: 0;
            /* No se comprime */
        }

        .logout-button:hover {
            color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }

        .logout-button i {
            width: 14px !important;
            height: 14px !important;
        }

        /* SEARCH DROPDOWN (Predictivo) */
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color-soft);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }

        .search-dropdown:not(.hidden) {
            display: block;
        }

        .search-result-item {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--slate-50);
            transition: background-color 0.2s;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background-color: var(--slate-50);
        }

        .search-highlight {
            color: var(--primary);
            font-weight: bold;
        }

        /* COMPONENTES ATÓMICOS */
        .user-greeting {
            margin-left: var(--space-xl);
            display: flex;
            align-items: center;
            gap: var(--space-s);
            padding: var(--space-xs) var(--space-m);
            background: var(--slate-50);
            border-radius: var(--radius-full);
            border: var(--border-width-std) solid var(--slate-100);
        }

        .user-greeting span {
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--secondary);
            letter-spacing: -0.01em;
        }

        .logout-btn {
            color: var(--slate-400);
            transition: color 0.2s;
        }

        .logout-btn:hover {
            color: var(--secondary);
        }

        .category-divider {
            height: 1px;
            background: var(--border-color-soft);
            margin-bottom: var(--space-s);
            margin-left: calc(-1 * var(--p-sidebar));
            width: var(--sidebar-w);
        }

        .contact-card {
            background: white;
            padding: 1.5rem;
            /* Equivalent to p-6 */
            border-radius: var(--radius-md);
            border: 1px solid var(--slate-100);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            height: 100%;
            /* Ensure uniform height in grid */
            position: relative;
            overflow: hidden;
        }

        /* Modern Glass/Glow Effect on Hover */
        .contact-card:hover {
            box-shadow: 0 20px 40px -12px rgba(16, 185, 129, 0.15), 0 0 0 1px rgba(16, 185, 129, 0.1);
            /* Sombra esmeralda difusa */
            transform: translateY(-4px);
            background: linear-gradient(to bottom right, #ffffff, #f0fdf4);
            /* Sutil gradiente blanco -> verde muy pálido */
            border-color: transparent;
            /* El borde lo maneja el box-shadow */
        }

        /* REMOVIDO: Línea superior verde (old style) */
        .contact-card::before {
            display: none;
        }

        .contact-card-icon {
            width: 2.75rem;
            height: 2.75rem;
            background: var(--slate-50);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate-400);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .contact-card:hover .contact-card-icon {
            background: var(--emerald-50);
            color: var(--primary);
        }

        /* DISTRIBUIDORES - SISTEMA REESTRUCTURACION */
        .dist-card-principal {
            background: var(--dist-primary-bg);
            border: 2px solid var(--dist-primary-border);
            border-radius: var(--dist-primary-radius);
            padding: 2rem;
            margin-bottom: 3rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .dist-principal-contact-wrapper .dist-contact-container {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 0 !important;
        }

        .dist-card {
            background-color: var(--dist-card-bg);
            border: 1px solid var(--dist-card-border);
            border-radius: var(--dist-card-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .dist-card:hover {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transform: translateY(-2px);
        }

        .dist-card-header {
            background-color: var(--slate-50);
            border-bottom: 1px solid var(--slate-100);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }

        .dist-card>div:last-child {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .dist-card>div:last-child>.dist-contact-container {
            margin-top: auto;
            padding-top: 1rem;
        }

        .dist-btn-whatsapp {
            background-color: var(--dist-whatsapp-bg);
            color: white !important;
            font-weight: 700;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            text-decoration: none;
            font-size: 0.875rem;
        }

        .dist-btn-whatsapp:hover {
            background-color: var(--dist-whatsapp-hover);
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .dist-tag-phone {
            background-color: var(--slate-100);
            color: var(--slate-700);
            padding: 0.5rem 0.75rem;
            border-radius: 10px;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.8;
        }

        @media (max-width: 640px) {
            .dist-card-principal {
                padding: 1.5rem;
            }

            .dist-principal-contact-wrapper .dist-contact-container {
                grid-template-columns: 1fr;
            }
        }

        /* //#endregion */
        /* YOUTUBE FACADE (Mejora de rendimiento) */
        .youtube-facade {
            position: relative;
            cursor: pointer;
            overflow: hidden;
            background-color: #000;
            border-radius: inherit;
            /* Heredar borde del contenedor */
        }

        .youtube-facade img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s;
        }

        .youtube-facade:hover img {
            opacity: 0.8;
        }

        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 68px;
            height: 48px;
            background-color: rgba(33, 33, 33, 0.8);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .play-button::before {
            content: "";
            border-style: solid;
            border-width: 10px 0 10px 18px;
            border-color: transparent transparent transparent white;
        }

        .youtube-facade:hover .play-button {
            background-color: #f00;
            /* YouTube Red */
        }

        /* RENDERIZADOR DE LISTAS DINÁMICAS (PILLS) */
        .special-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .list-pill {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: default;
        }

        .list-pill::before {
            content: '';
            width: 6px;
            height: 6px;
            background-color: var(--primary);
            border-radius: 50%;
            flex-shrink: 0;
        }

        .list-pill:hover {
            background: white;
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }

        /* ESTILOS DE NOTAS INTELIGENTES (Smart Grid Notes) */
        .note-text {
            font-size: var(--font-sm);
            color: #4b5563;
            /* slate-600 */
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .note-grid-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px 24px;
            /* Gap vertical 8px, Horizontal 24px */
            list-style: none;
            padding: 0;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .note-grid-list li {
            position: relative;
            padding-left: 14px;
            font-size: var(--font-xs);
            /* 11px aprox según tokens, o hardcodeamos 12px si muy chico */
            font-size: 12px;
            color: #334155;
            /* slate-700 */
            font-weight: 500;
            display: flex;
            align-items: flex-start;
        }

        .note-grid-list li::before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary);
            /* Verde */
            font-weight: bold;
            font-size: 1.2em;
            line-height: 1;
            top: 0px;
        }

        /* ANIMATED REFRESH BUTTON (Uiverse Adaptation) */
        .btn-animated-refresh {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* Alineado a la izquierda como el buscador */
            gap: 12px;
            width: 100%;
            background-color: white;
            color: var(--secondary);
            /* Texto oscuro normal */
            border: 1px solid #cbd5e1;
            /* slate-300 exacto como search-input */
            border-radius: 0.5rem;
            /* rounded-lg (8px) exacto como search-input */
            padding: 0.75rem 1rem;
            /* Padding similar */
            font-size: 0.875rem;
            /* text-sm exacto */
            font-weight: 500;
            /* Peso similar al placeholder */
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .btn-animated-refresh:hover {
            background-color: var(--slate-50);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
            border-color: var(--primary-vibrant);
            color: var(--primary-vibrant);
        }

        .btn-animated-refresh:hover i {
            color: var(--primary-vibrant);
        }
    </style>
</head>

<body>
    <!-- //#endregion 3. ESTRUCTURA DE INTERFAZ (HTML) -->

    <div class="app-layout">
        <!-- HEADER GLOBAL FIXED -->
        <header class="main-header">
            <div class="header-content px-8 w-full flex justify-between items-center h-full">
                <!-- IZQUIERDA: Identidad + Toggle -->
                <div class="flex items-center gap-4">
                    <!-- Logo Principal (Traído del Sidebar) -->
                    <a href="#" onclick="Navigation.goTo('catalog')"
                        class="flex items-center gap-3 transition-opacity hover:opacity-80">
                        <img src="img/logo-mundo-homeopatico.webp" alt="Logo" class="h-10 w-auto"
                            onerror="this.src='https://placehold.co/120x40?text=MH LOGO'">
                        <h1 class="font-black text-xl tracking-tight text-secondary leading-none">Mundo<br>Homeopático
                        </h1>
                    </a>

                    <!-- Toggle Móvil -->
                    <button onclick="UIHandlers.toggleSidebar()" class="btn-mobile-toggle md:hidden ml-4">
                        <i data-lucide="menu"></i>
                    </button>
                </div>

                <!-- DERECHA: Navegación Superior -->
                <div class="flex items-center gap-6">
                    <!-- Saludo User (Desktop Only) -->
                    <div id="userGreeting"
                        class="hidden md:flex items-center text-sm font-medium text-slate-600 animate-fade-in">
                        <div class="flex items-center gap-2">
                            <i data-lucide="user-circle" class="w-4 h-4 text-emerald-500"></i>
                            <span id="greetingText"></span>
                        </div>
                        <button onclick="UIHandlers.logout()" class="logout-button" title="Cerrar sesión">
                            <i data-lucide="log-out"></i>
                            <span>Salir</span>
                        </button>
                    </div>

                    <!-- Botón Navegación (Micro-interacción Premium) -->
                    <button id="navToggleButton" onclick="Navigation.toggle()" class="btn-dynamic-arrow">
                        <span id="navButtonText">Sedes y contacto</span>
                        <div class="arrow-wrapper">
                            <div class="arrow"></div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Barra de Progreso Global (Adherida al header) -->
            <div id="topProgressBar" class="top-progress-bar"></div>
        </header>

        <!-- SIDEBAR FIXED -->
        <aside id="mainSidebar" class="main-sidebar pb-10">




            <!-- VISTA: CATÁLOGO -->
            <div id="sidebar-catalog-view" class="flex flex-col h-full animate-fade-in">

                <!-- Saludo User (Mobile Only - Inside Sidebar) -->
                <div id="sidebarUserGreeting"
                    class="hidden flex-col gap-2 mb-4 p-4 bg-slate-50 rounded-xl border border-slate-100 md:hidden animate-fade-in">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600">
                            <i data-lucide="user" class="w-4 h-4"></i>
                        </div>
                        <div class="flex flex-col">
                            <span
                                class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Bienvenido</span>
                            <span id="sidebarGreetingText"
                                class="text-sm font-bold text-slate-700 leading-tight"></span>
                        </div>
                    </div>
                    <button onclick="UIHandlers.logout()"
                        class="w-full mt-2 flex items-center justify-center gap-2 py-2 text-xs font-semibold text-red-500 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                        <i data-lucide="log-out" class="w-3 h-3"></i>
                        Cerrar sesión
                    </button>
                    <div class="w-full h-px bg-slate-200 mt-2"></div>
                </div>
                <!-- Zona Superior: Buscador y Accesos -->
                <div class="flex-shrink-0">
                    <div class="search-container relative">
                        <i data-lucide="search"
                            class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="mainSearch" placeholder="Buscar..." aria-label="Buscar productos"
                            class="search-input w-full pl-10 pr-10 py-3 bg-white border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all shadow-sm hover:border-slate-400"
                            autocomplete="off">
                        <!-- Botón Limpiar (X) -->
                        <button id="clearSearchBtn" onclick="UIHandlers.clearSearch()"
                            class="hidden absolute right-3 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-all"
                            aria-label="Borrar búsqueda">
                            <i data-lucide="x" class="w-3.5 h-3.5"></i>
                        </button>
                        <!-- Dropdown de Resultados Predictivos -->
                        <div id="searchDropdown" class="search-dropdown hidden animate-fade-in"></div>
                    </div>
                </div>

                <button onclick="UIHandlers.showPasswordModal()" class="btn-animated-refresh mt-4 mb-6">
                    <i data-lucide="users" class="w-4 h-4 text-slate-400 transition-colors"></i>
                    Farmacias y médicos
                </button>

                <div class="category-divider flex-shrink-0"></div>

                <!-- Zona de Navegación (Scrollable) -->
                <nav id="sidebar-menu" class="space-y-1 flex-grow"></nav>
            </div>

            <!-- VISTA: CONTACTO (CONTEXTUAL) -->
            <div id="sidebar-contact-view" class="hidden flex-col h-full animate-fade-in">
                <!-- Zona Superior: Espacio para nuevos botones -->
                <div id="sidebar-contact-top-actions" class="flex-shrink-0 mb-6 flex flex-col items-center gap-4">
                    <!-- From Uiverse.io by alshahwan -->
                    <!-- From Uiverse.io by alshahwan -->
                    <a href="https://www.instagram.com/mundohomeopatico/" target="_blank"
                        class="btn-animated-refresh hover:!border-pink-500 hover:!text-pink-600 hover:!bg-pink-50">
                        <i data-lucide="instagram" class="w-4 h-4 text-slate-400 transition-colors"></i>
                        Instagram
                    </a>

                    <a href="https://mundohomeopatico.com/" target="_blank" class="btn-animated-refresh">
                        <i data-lucide="globe" class="w-4 h-4 text-slate-400 transition-colors"></i>
                        Sitio web
                    </a>
                </div>

                <div class="category-divider flex-shrink-0"></div>

                <!-- Menú de Navegación de Contacto -->
                <nav class="space-y-1 overflow-y-auto mb-6">
                    <a href="#videoSection" class="sidebar-link group mt-4"
                        onclick="document.getElementById('videoSection')?.scrollIntoView({behavior:'smooth'})">
                        <i data-lucide="play-circle"
                            class="w-4 h-4 text-slate-400 group-hover:text-primary transition-colors"></i>
                        <span>Video institucional</span>
                    </a>

                    <a href="#distributorsSection" class="sidebar-link group"
                        onclick="document.getElementById('distributorsSection')?.scrollIntoView({behavior:'smooth'})">
                        <i data-lucide="map-pin"
                            class="w-4 h-4 text-slate-400 group-hover:text-primary transition-colors"></i>
                        <span>Sedes principales</span>
                    </a>

                    <a href="#faqSection" class="sidebar-link group"
                        onclick="document.getElementById('faqSection')?.scrollIntoView({behavior:'smooth'})">
                        <i data-lucide="help-circle"
                            class="w-4 h-4 text-slate-400 group-hover:text-primary transition-colors"></i>
                        <span>Preguntas frecuentes</span>
                    </a>
                </nav>

                <!-- CTA Card (Abajo) -->
                <div class="flex-shrink-0 mt-auto mb-4">
                    <div class="distributor-promo-card p-5 bg-emerald-50/50 rounded-2xl border border-emerald-100/80">
                        <h3 class="font-bold text-lg text-emerald-900 mb-1">Sé distribuidor</h3>
                        <p class="text-xs text-slate-500 mb-4 leading-relaxed font-medium">Distribuye nuestros productos
                            homeopáticos.</p>

                        <a id="btn-whatsapp-sidebar" href="https://wa.me/573176680750" target="_blank"
                            class="btn-animated-refresh justify-center !py-2.5 !text-xs !bg-white hover:!bg-emerald-50 hover:!border-emerald-300 hover:!text-emerald-700">
                            <i data-lucide="message-circle" class="w-4 h-4 text-emerald-500"></i>
                            WhatsApp
                        </a>
                    </div>
                </div>
            </div>

            <!-- Pie de Autoría (Común a ambas vistas) -->
            <div id="author-credit"
                class="sidebar-footer mt-auto pt-6 opacity-0 transition-opacity duration-1000 flex-shrink-0">
                <p class="text-[9px] font-black text-slate-300 tracking-[0.3em] text-center leading-loose">
                    Desarrollado por<br>
                    <a id="author-link" href="#" target="_blank"
                        class="text-slate-400 hover:text-emerald-500 transition-colors font-bold border-b border-transparent hover:border-emerald-500"></a>
                </p>
            </div>
        </aside>

        <!-- WRAPPER DE CONTENIDO (Offset por Header y Sidebar) -->
        <div class="main-content-wrapper">
            <!-- Barra de Progreso Global & Banner de Notificaciones -->
            <div id="bannerWrapper" class="banner-wrapper collapsed">
                <div
                    class="w-full px-8 py-4 flex items-center gap-4 text-amber-900 text-[11px] font-bold tracking-wide animate-fade-in">
                    <i data-lucide="megaphone" class="w-5 h-5 flex-shrink-0 text-amber-500"></i>
                    <p id="bannerText" class="flex-grow text-left"></p>
                    <button onclick="UIHandlers.closeBanner()"
                        class="p-2 hover:bg-amber-100 rounded-full transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- PANEL CENTRAL SPA -->
            <!-- Fix Footer: Flex Column para empujar footer -->
            <main id="view-catalog" class="flex-grow p-6 lg:p-8 lg:pl-16 min-w-0 flex flex-col">
                <div class="mb-6 animate-fade-in">
                    <h2 class="text-4xl md:text-6xl font-black tracking-tighter mb-3 text-secondary">Lista de precios
                    </h2>
                    <p class="text-slate-400 font-medium text-sm">Precios actualizados 2026</p>
                </div>
                <!-- Contenedor crece para ocupar espacio -->
                <div id="tables-container" class="space-y-32 flex-grow">
                    <div class="h-64 bg-white rounded-[3rem] animate-pulse border border-slate-100 mb-10"></div>
                </div>
            </main>

            <main id="view-contact" class="hidden flex-grow p-6 lg:p-8 lg:pl-16 min-w-0 flex flex-col">
                <div class="mb-6 animate-fade-in">
                    <h2 class="text-4xl md:text-6xl font-black tracking-tighter mb-3 text-secondary">Sedes y contacto
                    </h2>
                    <p class="text-slate-400 font-medium text-sm">Red nacional de distribución</p>
                </div>

                <div class="flex-grow">
                    <section id="videoSection" class="mb-16 scroll-mt-40">
                        <div class="mb-6">
                            <h3 class="text-2xl md:text-3xl font-black text-secondary tracking-tight mb-2">
                                Excelencia en la elaboración homeopática</h3>
                            <p class="section-desc-l1 text-left">Procesos secuenciales limpios y fórmulas innovadoras
                                bajo estándares farmacéuticos internacionales.</p>
                        </div>
                        <div id="videoContainer"
                            class="aspect-video w-full rounded-[2rem] bg-slate-200 overflow-hidden shadow-2xl border-4 border-white animate-fade-in">
                            <!-- Aquí se inyectará el iframe si es necesario, o placeholder -->
                            <div class="w-full h-full flex items-center justify-center text-slate-400 bg-slate-100">
                                <i data-lucide="play" class="w-12 h-12 opacity-50"></i>
                            </div>
                        </div>
                    </section>

                    <section id="distributorsSection" class="scroll-mt-40 mb-16">
                        <h3 class="text-2xl font-black text-secondary mb-8 tracking-tight flex items-center gap-3">
                            <i data-lucide="map-pin" class="w-6 h-6 text-primary flex-shrink-0"></i>
                            <span>Sede principal</span>
                        </h3>

                        <!-- Contenedor Sede Principal (Dinámico) -->
                        <div id="sede-principal-container"></div>

                        <!-- Separador Estandarizado -->
                        <div class="mt-16 mb-8">
                            <h3 class="text-xl font-bold text-slate-400 flex items-center gap-2">
                                <i data-lucide="users" class="w-5 h-5"></i>
                                Distribuidores autorizados
                            </h3>
                        </div>

                        <div id="distributors-grid" class="grid md:grid-cols-2 lg:grid-cols-2 gap-6">
                            <!-- Dinámico: RenderEngine llenará esto -->
                        </div>
                    </section>

                    <section id="faqSection" class="mt-16 mb-16">
                        <h3 class="text-2xl font-black text-secondary mb-8 tracking-tight">Preguntas
                            frecuentes</h3>
                        <div id="faq-container" class="grid gap-4 w-full">
                            <!-- Dinámico: RenderEngine llenará esto -->
                        </div>
                    </section>
                </div>
            </main>

            <!-- FOOTER GLOBAL UNIFICADO (Fuera del padding del main) -->
            <footer class="mt-auto border-t border-slate-200 bg-white py-6 px-8">
                <div class="w-full flex flex-col md:flex-row justify-between items-center gap-8">
                    <!-- Bloque Izquierdo: Copyright -->
                    <div class="flex items-center gap-4 text-slate-400">
                        <img src="img/logo-mundo-homeopatico.webp" alt="Logo"
                            class="h-8 opacity-40 grayscale hover:grayscale-0 transition-all cursor-pointer">
                        <div class="text-left">
                            <p class="text-[11px] font-bold tracking-tight">Mundo Homeopático © 2026</p>
                            <p class="text-[10px] text-slate-400 hidden md:block">Precios sujetos a cambios.</p>
                        </div>
                    </div>

                    <!-- Bloque Derecho: Redes -->
                    <div class="flex justify-center gap-6">
                        <a id="footer-whatsapp-link" href="https://wa.me/573176680750" target="_blank" title="WhatsApp"
                            class="text-slate-400 hover:text-emerald-500 transition-colors transform hover:scale-110">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                        </a>
                        <a href="https://www.instagram.com/mundohomeopatico" target="_blank" title="Instagram"
                            class="text-slate-400 hover:text-pink-500 transition-colors transform hover:scale-110">
                            <i data-lucide="instagram" class="w-5 h-5"></i>
                        </a>
                        <a href="https://www.mhmundohomeopatico.com" target="_blank" title="Sitio Web"
                            class="text-slate-400 hover:text-secondary transition-colors transform hover:scale-110">
                            <i data-lucide="globe" class="w-5 h-5"></i>
                        </a>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    <!-- //#endregion -->

    <!-- //#region 4. LÓGICA DE NEGOCIO (JS) -->
    <!-- MODAL DE ACCESO PROFESIONAL (Distribuidores) -->
    <div id="passwordModal"
        class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-[2rem] p-10 max-w-md w-full shadow-2xl border border-slate-100 mx-4">
            <div class="text-center mb-8">
                <div
                    class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="lock" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-black text-secondary tracking-tight">Acceso restringido</h3>
                <p class="text-slate-500 text-sm font-medium mt-2">Por favor digite su contraseña</p>
            </div>

            <div class="space-y-4">
                <div class="relative">
                    <i data-lucide="key-round" class="absolute left-4 top-4 w-5 h-5 text-slate-300"></i>
                    <input type="password" id="professionalPassword" placeholder="Contraseña..."
                        aria-label="Contraseña de acceso"
                        class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition-all font-medium"
                        onkeyup="if(event.key==='Enter') UIHandlers.validateLogin()">
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="UIHandlers.closeModal()"
                        class="flex-1 py-4 px-6 bg-slate-100 text-slate-600 font-bold rounded-2xl hover:bg-slate-200 transition-all">
                        Cancelar
                    </button>
                    <button onclick="UIHandlers.validateLogin()"
                        class="flex-[2] py-4 px-6 bg-emerald-500 text-white font-bold rounded-2xl shadow-lg shadow-emerald-500/20 hover:bg-emerald-600 hover:-translate-y-0.5 transition-all">
                        Acceder
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay Móvil -->
    <div id="mobileOverlay" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[150] md:hidden"
        onclick="UIHandlers.toggleSidebar()"></div>

    <script>

        const APP_CONFIG = {
            SHEETS: {
                PRICES: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=1411473006&single=true&output=csv',
                NAV: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=1582460222&single=true&output=csv',
                AUTH: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=1372762576&single=true&output=csv',
                AUTHOR: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=2047819342&single=true&output=csv',
                VIDEO: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=1360742312&single=true&output=csv',
                BANNER: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=593525669&single=true&output=csv',
                FAQ: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=1434563192&single=true&output=csv',
                DIST: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=486540156&single=true&output=csv'
            },
            PROXY: 'https://corsproxy.io/?',
            PROXY_BACKUP: 'https://corsproxy.io/?',
            ICONS: {
                CATEGORY: {
                    "lineamh": "microscope",
                    "homeopatia": "leaf",
                    "oligoelementos": "atom",
                    "exclusivos": "star",
                    "farmacia": "flask-conical"
                },
                ITEM: {
                    "esenciasflorales": "flower-2",
                    "oligoelementos": "atom",
                    "oligoelementosk7": "atom",
                    "alimentosfuncionales": "apple",
                    "cbd": "droplets",
                    "aceitesesenciales": "sparkles",
                    "oficinales": "flask-conical",
                    "multipotenias": "layers",
                    "magistrales": "scroll"
                }
            }
        };

        const STATE = { prices: [], nav: [], faq: [], dist: [], currentView: 'catalog', isPro: localStorage.getItem('mh_pro_v2') === 'true', userName: localStorage.getItem('mh_user_v2') || '' };

        const escapeHtml = (unsafe) => {
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        const renderText = (txt) => {
            if (!txt) return '';
            // Renderizado robusto de texto enriquecido (Seguro por escapeHtml primero)
            return escapeHtml(txt).replace(/\^/g, '<br>').replace(/\\n/g, '<br>').trim();
        };

        const Formatters = {
            formatPhone(phone) {
                if (!phone) return '';
                const cleaned = String(phone).replace(/\D/g, '');
                if (cleaned.length === 10) {
                    return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)} ${cleaned.slice(6)}`;
                }
                return String(phone);
            },
            whatsapp(phone) {
                if (!phone) return '';
                const cleaned = String(phone).replace(/\D/g, '');
                if (cleaned.startsWith('57')) return cleaned;
                if (cleaned.length === 10) return '57' + cleaned;
                return cleaned;
            }
        };

        const UIHandlers = {
            isInteracting: false,
            isManualScroll: false,
            interactionTimeout: null,

            init() {
                if (STATE.isPro) document.body.classList.add('professional-mode');
                this.updateGreeting();

                // Configurar Buscador con Debounce
                const inp = document.getElementById('mainSearch');
                if (inp) {
                    // Optimización: Debouncing (300ms) para performance y UX fluida
                    // Evita congelamientos al renderizar en cada tecla (Best Practice)
                    let searchTimeout;
                    inp.addEventListener('input', (e) => {
                        const q = e.target.value.toLowerCase().trim();
                        // Toggle Clear Button
                        const btn = document.getElementById('clearSearchBtn');
                        if (btn) btn.style.display = q.length > 0 ? 'block' : 'none';

                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(() => {
                            this.search(q);
                        }, 300);
                    });

                    // Cerrar dropdown al hacer click fuera
                    document.addEventListener('click', (e) => {
                        if (!inp.parentElement.contains(e.target)) {
                            this.toggleDropdown(false);
                        }
                    });

                    // Reactivar dropdown al hacer focus si hay texto
                    inp.addEventListener('focus', () => {
                        if (inp.value.trim().length > 0) this.search(inp.value.trim());
                    });
                }
            },

            updateGreeting() {
                const headGreeting = document.getElementById('userGreeting');
                const sideGreeting = document.getElementById('sidebarUserGreeting');
                const headText = document.getElementById('greetingText');
                const sideText = document.getElementById('sidebarGreetingText');

                if (STATE.isPro && STATE.userName) {
                    // Update Texts
                    if (headText) headText.textContent = STATE.userName;
                    if (sideText) sideText.textContent = STATE.userName;

                    // Show Containers (Absolute Force Logic)
                    if (headGreeting) {
                        // Desktop: Oculto en Móvil (hidden), Flex en Desktop (md:flex)
                        headGreeting.className = "hidden md:flex items-center text-sm font-medium text-slate-600 animate-fade-in";
                    }

                    if (sideGreeting) {
                        // Mobile: Flex en Movil (flex), Oculto en Desktop (md:hidden)
                        sideGreeting.className = "flex flex-col gap-2 mb-4 p-4 bg-slate-50 rounded-xl border border-slate-100 md:hidden animate-fade-in";
                    }

                } else {
                    if (headGreeting) headGreeting.classList.add('hidden');
                    if (sideGreeting) sideGreeting.classList.add('hidden');
                }
            },

            // BÚSQUEDA PRO ENFOCADA (Títulos y Productos SOLAMENTE)
            search(q) {
                if (q.length === 0) {
                    // Restaurar todo
                    document.querySelectorAll('.catalog-card').forEach(c => c.classList.remove('hidden'));
                    document.querySelectorAll('tr').forEach(tr => tr.style.display = '');
                    this.toggleDropdown(false);
                    document.getElementById('noResultsMessage')?.remove();
                    return;
                }

                const matches = [];
                let hasResults = false;

                // 1. Mapa de Coincidencias por Sección (Para mostrar/ocultar contenedores padre)
                const visibleSections = new Set();

                // 2. Búsqueda eficiente en los DATOS (STATE.prices)
                // Esto es mucho más rápido y preciso que buscar en el DOM
                STATE.prices.forEach(p => {
                    if (!p) return;

                    // Criterios de Búsqueda Estrictos (Solo Títulos y Producto)
                    const textCriterias = [
                        p.producto,
                        p.nivel_1,
                        p.nivel_2,
                        p.nivel_3 // Títulos de categorías
                    ];

                    const isMatch = textCriterias.some(t => t && t.toLowerCase().includes(q));

                    if (isMatch) {
                        // Guardar para el Dropdown
                        // Priorizamos mostrar el Producto si coincide, si no, la Categoría que coincidió
                        let matchName = p.producto;
                        let matchType = 'Producto';

                        if (!p.producto.toLowerCase().includes(q)) {
                            // Si no coincidió el producto, fue una categoría
                            matchName = [p.nivel_3, p.nivel_2, p.nivel_1].find(t => t && t.toLowerCase().includes(q)) || matchName;
                            matchType = 'Categoría';
                        }

                        // Añadir a resultados del dropdown (si no es duplicado conceptual)
                        matches.push({
                            id: p.id, // ID único del producto/fila
                            name: matchName,
                            section: p.nivel_3 || p.nivel_2 || 'Catálogo',
                            type: matchType
                        });

                        // Marcar ID para visualización
                        visibleSections.add(p.id);
                    }
                });

                // 3. Actualizar DOM basado en resultados
                // Primero ocultamos todo
                document.querySelectorAll('.catalog-card').forEach(card => card.classList.add('hidden'));

                // Luego mostramos lo relevante
                if (visibleSections.size > 0) {
                    hasResults = true;

                    // Recorrer todas las tablas y filas para filtrar
                    document.querySelectorAll('.catalog-card').forEach(card => {
                        let cardHasVisibleRows = false;

                        card.querySelectorAll('tbody tr').forEach(tr => {
                            // Hack: Obtenemos el ID del producto inyectado en un atributo data (si existiera) o inferimos
                            // Como no tenemos ID en el TR en este renderizado simple, buscamos por texto EXACTO del producto
                            const prodNameEl = tr.querySelector('.product-name div:first-child');
                            if (!prodNameEl) return;

                            const prodName = prodNameEl.textContent.trim();
                            // Buscar si este producto está en nuestra lista de matches (por nombre, ya que por ID es difícil sincronizar con el DOM actual)
                            const isRowMatch = matches.some(m => m.name === prodName && m.type === 'Producto');

                            // O si la categoría de la tarjeta coincidió (matches de tipo Categoría) -> mostrar todo el bloque
                            const sectionTitle = card.querySelector('h5')?.textContent || '';
                            const isSectionMatch = matches.some(m => m.type === 'Categoría' && sectionTitle.includes(m.name));

                            if (isRowMatch || isSectionMatch) {
                                tr.style.display = '';
                                cardHasVisibleRows = true;
                            } else {
                                tr.style.display = 'none';
                            }
                        });

                        if (cardHasVisibleRows) {
                            card.classList.remove('hidden');
                        }
                    });
                }

                // 4. Mensaje "Sin Resultados"
                const noResultsMsg = document.getElementById('noResultsMessage');
                if (!hasResults) {
                    if (!noResultsMsg) {
                        const msg = document.createElement('div');
                        msg.id = 'noResultsMessage';
                        msg.className = 'text-center p-8 text-slate-400 font-medium animate-fade-in';
                        msg.innerHTML = `<i data-lucide="search-x" class="w-12 h-12 mx-auto mb-2 opacity-50"></i><p>No encontramos coincidencias para "${escapeHtml(q)}"</p>`;
                        document.getElementById('tables-container').appendChild(msg);
                        if (window.lucide) window.lucide.createIcons();
                    }
                } else {
                    noResultsMsg?.remove();
                }

                // 5. Actualizar Dropdown (Deduplicado)
                // Filtramos duplicados para que el dropdown no muestre 50 veces "Arnica" si hay 50 presentaciones
                const seen = new Set();
                const uniqueMatches = [];
                matches.forEach(m => {
                    const key = m.name + m.section;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueMatches.push(m);
                    }
                });

                this.updateSearchDropdown(uniqueMatches, q);
            },

            clearSearch() {
                const inp = document.getElementById('mainSearch');
                const btn = document.getElementById('clearSearchBtn');
                if (inp) {
                    inp.value = '';
                    inp.focus();
                }
                if (btn) btn.style.display = 'none';
                this.search('');
            },

            // FUNCIONES DEL DROPDOWN PREDICTIVO
            toggleDropdown(show) {
                const d = document.getElementById('searchDropdown');
                if (d) show ? d.classList.remove('hidden') : d.classList.add('hidden');
            },

            updateSearchDropdown(items, query) {
                const dropdown = document.getElementById('searchDropdown');
                if (!dropdown) return;

                const limit = 6;
                const shown = items.slice(0, limit);

                if (shown.length === 0) {
                    this.toggleDropdown(false);
                    return;
                }

                let html = shown.map(item => {
                    const regex = new RegExp(`(${query})`, 'gi');
                    const highlightedName = item.name.replace(regex, '<span class="search-highlight">$1</span>');

                    return `<div class="search-result-item" onclick="UIHandlers.scrollToElement(this)">
                        <div class="text-[11px] font-bold text-slate-700 leading-tight pointer-events-none">${highlightedName}</div>
                        <div class="hidden item-name">${item.name}</div>
                    </div>`;
                }).join('');

                if (items.length > limit) {
                    html += `<div class="p-2 text-[10px] text-center text-emerald-600 font-bold bg-emerald-50 cursor-default">
                        +${items.length - limit} resultados más...
                    </div>`;
                }

                dropdown.innerHTML = html;
                this.toggleDropdown(true);
            },

            scrollToElement(sender) {
                const targetName = sender.querySelector('.item-name')?.textContent;
                if (!targetName) return;

                // Buscar el elemento en el DOM visible
                // Preferimos una fila de tabla (tbody tr) que contenga el nombre exacto
                const rows = Array.from(document.querySelectorAll('tbody tr'));
                const targetEl = rows.find(r => {
                    const nameDiv = r.querySelector('.product-name div:first-child');
                    return nameDiv && nameDiv.textContent === targetName;
                });

                if (targetEl) {
                    this.toggleDropdown(false);
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight visual
                    targetEl.classList.add('bg-emerald-100');
                    setTimeout(() => targetEl.classList.remove('bg-emerald-100'), 2000);

                    if (window.innerWidth < 1024) this.toggleSidebar();
                } else {
                    // Fallback: Si es una categoría, buscar el título
                    const headers = Array.from(document.querySelectorAll('h5'));
                    const targetHeader = headers.find(h => h.textContent.includes(targetName));
                    if (targetHeader) {
                        this.toggleDropdown(false);
                        targetHeader.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        if (window.innerWidth < 1024) this.toggleSidebar();
                    }
                }
            },

            updateGreeting() {
                const hour = new Date().getHours();
                const greet = hour < 12 ? "Buenos días" : hour < 18 ? "Buenas tardes" : "Buenas noches";
                const gt = document.getElementById('greetingText');
                if (gt) gt.textContent = `${greet}${STATE.userName ? ', ' + STATE.userName : ''}`;
                document.getElementById('userGreeting')?.classList.toggle('hidden', !STATE.isPro);
            },
            toggleSidebar: () => {
                document.getElementById('mainSidebar').classList.toggle('is-open');
                document.getElementById('mobileOverlay').classList.toggle('show');
            },

            // LÓGICA DE ACORDEÓN PURA Y SIMPLE
            toggleAccordion: (btn) => {
                // Búsqueda ROBUSTA del contenido del acordeón
                const content = btn.parentElement.querySelector('.sidebar-accordion-content');
                const isOpen = content.classList.contains('is-open');

                // Pausar Observer para evitar conflicto de scroll
                UIHandlers.isInteracting = true;

                // 1. Cerrar todos los acordeones (Comportamiento Exclusivo)
                document.querySelectorAll('.sidebar-accordion-content').forEach(nav => {
                    nav.classList.remove('is-open');
                });
                document.querySelectorAll('.sidebar-item-accordion').forEach(b => {
                    b.querySelector('.lucide-chevron-down')?.classList.remove('rotate-180');
                    b.classList.remove('bg-slate-100', 'text-secondary');
                });

                // 2. Si estaba cerrado, abrir SOLO este
                if (!isOpen) {
                    content.classList.add('is-open');
                    btn.querySelector('.lucide-chevron-down')?.classList.add('rotate-180');
                    btn.classList.add('bg-slate-100', 'text-secondary');

                    // Scroll suave eliminado para evitar "pestañeo" visual
                    // La interacción es más natural si el menú no salta bajo el puntero
                }

                // 3. Refrescar iconos
                if (window.lucide) window.lucide.createIcons();

                // 4. Reactivar Observer tras la transición
                clearTimeout(UIHandlers.interactionTimeout);
                UIHandlers.interactionTimeout = setTimeout(() => {
                    UIHandlers.isInteracting = false;
                }, 1000);
            },

            closeBanner: () => {
                const wrapper = document.getElementById('bannerWrapper');
                if (wrapper) wrapper.classList.add('collapsed');
                localStorage.setItem('mh_banner_closed', 'true');
                document.body.classList.remove('has-banner');
            },
            showPasswordModal: () => {
                const modal = document.getElementById('passwordModal');
                if (!modal) return;

                // Técnica de Blindaje: Remover hidden y forzar display flex
                modal.classList.remove('hidden');
                modal.style.display = 'flex'; // Inline override para garantizar visibilidad

                // Enfocar input para UX inmediata
                setTimeout(() => document.getElementById('professionalPassword')?.focus(), 100);
            },
            closeModal: () => {
                const modal = document.getElementById('passwordModal');
                if (!modal) return;

                modal.classList.add('hidden');
                modal.style.display = ''; // Limpiar override
            },
            validateLogin: async () => {
                const passInput = document.getElementById('professionalPassword');
                const pass = passInput.value.trim();

                // Feedback de carga
                // FIX: El botón NO está dentro del parentElement del input, debemos buscarlo en el modal completo
                const modal = document.getElementById('passwordModal');
                const btn = modal.querySelector('button[onclick*="validateLogin"]');
                const originalText = btn ? btn.innerHTML : '';
                if (btn) btn.innerHTML = '<span class="animate-pulse">Verificando...</span>';

                try {
                    // ESTRATEGIA HÍBRIDA: Memoria (Rápida) -> Red (Fallback)
                    let auth = STATE.auth;

                    // Si por alguna razón no cargó al inicio, intentamos cargarla ahora
                    if (!auth || auth.length === 0) {
                        try {
                            auth = await DataService.fetchCSV(APP_CONFIG.SHEETS.AUTH);
                            STATE.auth = auth; // Guardar para futuro
                        } catch (err) { console.warn("Fallo carga auth on-demand", err); }
                    }

                    // ESCENARIO 1: Modo Offline / Bloqueo Local / Base Vacía
                    if (!auth || auth.length === 0) {
                        console.warn("⚠️ Base de datos de usuarios no disponible. Usando mecanismo offline.");

                        if (pass === 'MH2026') {
                            localStorage.setItem('mh_pro_v2', 'true');
                            localStorage.setItem('mh_user_v2', 'Administrador Offline');
                            location.reload();
                        } else {
                            alert("MODO OFFLINE: Conexión limitada. Por favor use la clave maestra o recargue la página cuando tenga mejor señal.");
                            btn.innerHTML = originalText;
                        }
                        return;
                    }

                    // ESCENARIO 2: Validación en Memoria (Instantánea)
                    // Búsqueda insensible a mayúsculas/minúsculas
                    // NOTA: La columna en Google Sheets es "contraseñas" (PLURAL con ñ)
                    const user = auth.find(r => {
                        const p = (r.contraseñas || r.password || r.clave || r.contrasena || r.contraseña || "").toString().trim();
                        return p.toLowerCase() === pass.toLowerCase();
                    });

                    if (user || pass === 'MH2026') {
                        localStorage.setItem('mh_pro_v2', 'true');
                        localStorage.setItem('mh_user_v2', user?.nombre || user?.usuario || 'Administrador');
                        location.reload();
                    } else {
                        // Pequeño delay artificial para deterred fuerza bruta y dar peso a la UI
                        setTimeout(() => {
                            alert("La contraseña ingresada no es válida.");
                            if (btn) btn.innerHTML = originalText;
                            passInput.value = "";
                            passInput.focus();
                        }, 500);
                    }

                } catch (e) {
                    console.error("Error Auth Crítico:", e);
                    alert("Error verificando credenciales. Intente nuevamente.");
                    if (btn) btn.innerHTML = originalText;
                }
            },


            // NAVEGACIÓN MANUAL (OPTIMIZADA PARA ACORDEONES)
            initNavigation() {
                // Delegación de eventos con PRIORIDAD a los links
                // Usamos capture phase (true) para interceptar el evento ANTES que otros handlers
                document.addEventListener('click', (e) => {
                    // PASO 1: Verificar si el click fue en un link con data-tid
                    const link = e.target.closest('.sidebar-link[data-tid]');

                    if (link) {
                        // CRÍTICO: Detener propagación inmediatamente para evitar que
                        // el click active el acordeón padre o cualquier otro handler
                        e.preventDefault();
                        e.stopImmediatePropagation(); // stopIMMEDIATE para bloquear TODOS los handlers

                        const tid = link.getAttribute('data-tid');
                        if (!tid) return; // Safety check

                        // Bloqueo temporal del Observer para evitar "saltos" de active state
                        UIHandlers.isManualScroll = true;
                        clearTimeout(UIHandlers.scrollTimeout);

                        // Scroll directo sin complicaciones
                        const targetId = `sec-${tid}`;
                        const target = document.getElementById(targetId);

                        if (target) {
                            // Ajuste Dinámico para el header fijo
                            const headerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-h')) || 80;
                            const elementPosition = target.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerH - 20; // 20px extra de aire

                            window.scrollTo({
                                top: offsetPosition,
                                behavior: "smooth"
                            });

                            // FEEDBACK VISUAL: Resaltar la sección destino
                            target.classList.add('bg-emerald-50/50', 'transition-colors', 'duration-500');
                            setTimeout(() => {
                                target.classList.remove('bg-emerald-50/50');
                            }, 1500);
                        } else {
                            console.warn(`⚠️ Sección no encontrada: ${targetId}`);
                        }

                        // UX Básico: Marcar activo inmediatamente
                        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');

                        // Liberar bloqueo del Observer después de la animación de scroll (aprox 1s)
                        UIHandlers.scrollTimeout = setTimeout(() => {
                            UIHandlers.isManualScroll = false;
                        }, 1000);

                        // En móvil cerrar sidebar
                        if (window.innerWidth < 1024) UIHandlers.toggleSidebar();
                    }
                }, true); // TRUE = Capture phase (intercepta ANTES que bubble handlers)
            },

            // FAQ ACORDEÓN EXCLUSIVO (Lógica migrada de proyecto modular)
            toggleFaq(button) {
                const content = button.nextElementSibling;
                const icon = button.querySelector('[data-lucide="chevron-down"]');
                const isHidden = content.classList.contains('hidden');

                // 1. Cerrar TODOS los items primero
                document.querySelectorAll('.faq-answer-container').forEach(c => c.classList.add('hidden'));
                document.querySelectorAll('.faq-trigger [data-lucide="chevron-down"]').forEach(i => i.style.transform = 'rotate(0deg)');
                document.querySelectorAll('.faq-trigger').forEach(b => b.setAttribute('aria-expanded', 'false'));

                // 2. Abrir SOLO el seleccionado si estaba cerrado
                if (isHidden) {
                    content.classList.remove('hidden');
                    if (icon) icon.style.transform = 'rotate(180deg)';
                    button.setAttribute('aria-expanded', 'true');
                }
            },

            // CONTROL DE BARRA DE CARGA
            showLoading(active) {
                const bar = document.getElementById('topProgressBar');
                if (!bar) return;

                if (active) {
                    bar.classList.remove('complete');
                    // Forzar reflow para reiniciar la animación si se llama seguido
                    void bar.offsetWidth;
                    bar.classList.add('loading');
                } else {
                    bar.classList.remove('loading');
                    bar.classList.add('complete');

                    // Resetear después de la animación de desaparición
                    setTimeout(() => {
                        bar.classList.remove('complete');
                        bar.style.width = '0';
                    }, 500);
                }
            },

            // CARGA DIFERIDA DE VIDEO (Click-to-Load)
            loadVideo(btn) {
                const videoId = btn.dataset.videoId;
                if (!videoId) return;

                // Evitar múltiples clicks
                btn.onclick = null;
                btn.classList.remove('cursor-pointer'); // Feedback visual

                // Reemplazar fachada con iframe real con autoplay
                btn.innerHTML = `<iframe class="w-full h-full" 
                    src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1" 
                    title="Video corporativo"
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                    allowfullscreen></iframe>`;
            },

            // LOGOUT: Limpieza total y recarga
            logout() {
                localStorage.clear();
                location.reload();
            },

        };

        const Navigation = {
            toggle() {
                // Lógica de Toggle simplificada
                if (STATE.currentView === 'catalog') this.goTo('contact');
                else this.goTo('catalog');
            },
            goTo(viewId) {
                // Actualizar Estado
                STATE.currentView = viewId;

                // Referencias DOM
                const views = {
                    catalog: document.getElementById('view-catalog'),
                    contact: document.getElementById('view-contact')
                };
                const sidebars = {
                    catalog: document.getElementById('sidebar-catalog-view'),
                    contact: document.getElementById('sidebar-contact-view')
                };
                const btn = document.getElementById('navToggleButton');

                // Hard-Switch de Vistas
                // Cambiar visibilidad de vistas y sidebars
                const banner = document.getElementById('bannerWrapper');

                if (viewId === 'contact') {
                    views.catalog.classList.add('hidden');
                    views.contact.classList.remove('hidden');
                    sidebars.catalog.classList.add('hidden');
                    sidebars.contact.classList.remove('hidden');
                    if (banner) banner.classList.add('hidden'); // Ocultar banner en contacto
                } else {
                    views.contact.classList.add('hidden');
                    views.catalog.classList.remove('hidden');
                    sidebars.contact.classList.add('hidden');
                    sidebars.catalog.classList.remove('hidden');
                    if (banner) banner.classList.remove('hidden'); // Restaurar banner en catálogo
                }

                // Actualizar Botón (Solo texto para evitar saltos)
                const navButtonText = document.getElementById('navButtonText');
                if (navButtonText) {
                    navButtonText.textContent = (viewId === 'contact') ? 'Lista de precios' : 'Sedes y contacto';
                }

                // Actualizar ícono si fuera necesario (aquí es el mismo, pero lo mantenemos robusto)
                if (window.lucide) window.lucide.createIcons();

                // Refrescar iconos tras inyectar nuevo HTML
                if (window.lucide) window.lucide.createIcons();

                document.getElementById('mainSidebar').classList.remove('open');
                document.getElementById('mobileOverlay').classList.add('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        const DataService = {
            // Lista de Proxies para Failover (Rotación optimizada)
            proxies: [
                url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, // INTENTO 1: CodeTabs (Alta disponibilidad)
                url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`, // INTENTO 2: AllOrigins
                url => `https://corsproxy.io/?${encodeURIComponent(url)}`, // INTENTO 3: CORSProxy.io
                url => url, // INTENTO 4: Directo (Backup)
                url => `https://thingproxy.freeboard.io/fetch/${url}` // INTENTO 5: ThingProxy
            ],

            async fetchCSV(url) {
                // Añadir Cache-Busting para evitar Error 400 de Google por peticiones repetidas
                const separator = url.includes('?') ? '&' : '?';
                const freshUrl = `${url}${separator}cb=${Date.now()}`;

                for (let i = 0; i < this.proxies.length; i++) {
                    const proxyFn = this.proxies[i];
                    const fetchUrl = proxyFn(freshUrl);

                    try {
                        const controller = new AbortController();
                        // Aumentado a 15s para dar margen a conexiones lentas
                        const timeoutId = setTimeout(() => controller.abort(), 15000);

                        const response = await fetch(fetchUrl, {
                            signal: controller.signal,
                            cache: 'no-store' // Forzar al navegador a no usar caché
                        });
                        clearTimeout(timeoutId);

                        if (!response.ok) throw new Error(`HTTP ${response.status}`);

                        const text = await response.text();

                        // Validación de integridad
                        if (!text || text.length < 5 || text.includes('<!DOCTYPE html>')) {
                            throw new Error('Respuesta inválida o bloqueada');
                        }

                        return this.parseCSV(text);

                    } catch (error) {
                        const errorMsg = error.name === 'AbortError' ? 'Timeout (15s)' : error.message;
                        console.warn(`⚠️ Intento ${i + 1} falló: ${errorMsg}. Probando alternativa...`);

                        if (i === this.proxies.length - 1) {
                            console.error('❌ Error Crítico: No se pudo conectar con la base de datos.');

                            // UX: Detectar si el usuario abrió el archivo directamente
                            if (window.location.protocol === 'file:') {
                                alert("🛑 ERROR DE CONEXIÓN\n\nEstás abriendo el archivo directamente (Protocolo file://).\nPor seguridad, el navegador bloquea la descarga de datos.\n\nSOLUCIÓN:\nAbre una terminal en esta carpeta y ejecuta:\nnpx serve\n\nLuego abre: http://localhost:3000");
                            } else {
                                alert("⚠️ No se pudo conectar con la base de datos.\nVerifica tu conexión a internet o intenta recargar.");
                            }

                            return [];
                        }
                    }
                }
                return [];
            },

            parseCSV(str) {
                const arr = [];
                let quote = false;
                let col = 0, row = 0;
                let c = 0;

                // Pre-allocating rows
                arr[row] = [];
                arr[row][col] = "";

                for (c = 0; c < str.length; c++) {
                    let cc = str[c], nc = str[c + 1];
                    arr[row] = arr[row] || [];
                    arr[row][col] = arr[row][col] || "";

                    if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
                    if (cc == '"') { quote = !quote; continue; }
                    if (cc == ',' && !quote) { ++col; continue; }
                    if (cc == '\r' && !quote && nc == '\n') { ++row; col = 0; ++c; continue; }
                    if (cc == '\n' && !quote) { ++row; col = 0; continue; }
                    if (cc == '\r' && !quote) { ++row; col = 0; continue; }
                    arr[row][col] += cc;
                }

                // Normalización de cabeceras
                const headers = arr[0].map(h => {
                    let clean = h.trim().toLowerCase().replace(/\s+/g, '_').replace(/^"|"$/g, '');
                    if (clean === 'tablas_id') return 'tabla_id'; // Compatibilidad
                    return clean;
                });

                return arr.slice(1).filter(r => r.some(cell => cell && cell.trim().length > 0)).map(row => {
                    const obj = {};
                    headers.forEach((h, i) => {
                        let val = row[i] || "";
                        // Limpieza extra de comillas envolventes si parser falló un poco
                        if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                        obj[h] = val.trim();
                    });
                    return obj;
                });
            },

            normalizeYT(url) {
                if (!url) return '';
                const id = url.match(/(?:v=|\/embed\/|youtu\.be\/|\/v\/|\/e\/|watch\?v%3D)([^#\&\?]*).*/);
                return id ? `https://www.youtube.com/embed/${id[1]}` : url;
            },

            slugify(text) {
                if (!text) return "unknown";
                return text.toString()
                    .toLowerCase()
                    .replace(/\u00FC|\u00DC/g, 'u') // Diéresis
                    .replace(/\u00F1|\u00D1/g, 'n') // Ñ
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "") // Quitar acentos
                    .replace(/[^a-z0-9]+/g, '-')     // Solo alfanuméricos y guiones
                    .replace(/^-+|-+$/g, '')         // Limpiar bordes
                    .trim();
            }
        };



        const RenderEngine = {
            renderAll() {
                this.renderCatalog();
                this.renderContactItems();
                this.renderFAQ();
                if (window.lucide) window.lucide.createIcons();
            },
            renderCatalog() {
                try {
                    console.log("🚀 RenderEngine: Starting Catalog Architecture v3.0 (Modular)");
                    const sidebar = document.getElementById('sidebar-menu');
                    const panel = document.getElementById('tables-container');

                    if (!sidebar || !panel) {
                        console.error("Elementos UI críticos no encontrados");
                        return;
                    }

                    // 1. CAPTURA DE ESTADO PREVIO (Persistencia Acordeones)
                    const openGroups = new Set();
                    document.querySelectorAll('.sidebar-item-accordion').forEach(btn => {
                        if (btn.querySelector('.rotate-180') || btn.getAttribute('aria-expanded') === 'true') {
                            const label = btn.querySelector('span')?.textContent.trim();
                            if (label) openGroups.add(label);
                        }
                    });

                    // 2. Obtener Datos
                    if (!STATE.nav.length) {
                        if (panel.innerHTML.trim() === '') {
                            panel.innerHTML = `<div class="p-20 text-center animate-fade-in text-slate-400">Cargando catálogo...</div>`;
                        }
                        return;
                    }

                    // 3. FASE DE ARQUITECTO: CONSTRUIR LA JERARQUÍA
                    const tree = this.buildHierarchy(STATE.nav);

                    // 4. FASE DE PINTOR: RENDERIZADO MODULAR
                    const sHtml = this.generateSidebarHTML(tree, openGroups);
                    const pHtml = this.generateContentHTML(tree);

                    // 5. INYECCIÓN PROTEGIDA
                    if (!sHtml) {
                        console.error("RenderEngine: Sidebar HTML vacío");
                        panel.innerHTML = `<div class="p-8 text-center text-red-500">Error rendering UI</div>`;
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        sidebar.innerHTML = sHtml;
                        panel.innerHTML = pHtml;
                        this.initObserver();
                    }

                } catch (err) {
                    console.error("Error Crítico UI:", err);
                    const panel = document.getElementById('tables-container');
                    if (panel) panel.innerHTML = `<div class="p-8 text-center text-red-500">Error Fatal de Interfaz: ${err.message}</div>`;
                }
            },

            // --- GENERADOR DEL SIDEBAR (Menú de Navegación) ---
            generateSidebarHTML(tree, openGroups) {
                let html = '';
                // Fallback si no se pasa el Set
                const activeGroups = openGroups || new Set();

                tree.forEach(section => {
                    // Nivel 1: Título de Sección
                    html += `<div class="sidebar-label-l1">${section.title}</div>`;

                    section.children.forEach(node => {
                        // Nivel 2: Subtítulo
                        if (node.type === 'subtitle') {
                            html += `<div class="sidebar-subtitle-context">${node.title}</div>`;

                            if (node.children) {
                                node.children.forEach(child => this.appendSidebarNode(html, child, activeGroups, (h) => html += h));
                            }
                        }
                        // Nivel Directo
                        else {
                            this.appendSidebarNode(html, node, activeGroups, (h) => html += h);
                        }
                    });
                });
                return html;
            },

            // --- HELPER INTERNO PARA NODOS DEL SIDEBAR ---
            appendSidebarNode(currentHtml, node, openGroups, appendFn) {
                let fragment = '';

                // CASO A: GRUPO
                if (node.type === 'group') {
                    const isOpen = openGroups.has(node.title);
                    const openClass = isOpen ? 'is-open' : '';
                    const rotateClass = isOpen ? 'rotate-180' : '';
                    const activeClass = isOpen ? 'bg-slate-100 text-secondary' : '';

                    fragment += `<div class="mb-1">
                        <button class="sidebar-item-accordion group ${activeClass}" aria-expanded="${isOpen}" onclick="UIHandlers.toggleAccordion(this)">
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-300 group-hover:text-primary transition-colors ${rotateClass}"></i>
                            <span class="text-left tracking-wide">${node.title}</span>
                        </button>
                        <div class="sidebar-accordion-content ${openClass}">
                            <nav class="sidebar-accordion-inner space-y-1">`;

                    node.items.forEach(item => {
                        fragment += `<a href="#sec-${item.id}" data-tid="${item.id}" class="sidebar-link child-link">${item.label}</a>`;
                    });
                    fragment += `</nav></div></div>`;
                }
                // CASO B: ITEM SUELTO
                else if (node.type === 'item') {
                    const iconSlug = DataService.slugify(node.label).replace(/-/g, '');

                    let iconName = "circle";
                    const keywordMap = { 'gotas': 'droplet', 'jarabe': 'flask-conical', 'crema': 'sparkles', 'unguento': 'sparkles', 'gel': 'droplets', 'capsulas': 'pill', 'glóbulos': 'circle-dot', 'oficinales': 'flask-conical', 'esencias': 'flower-2', 'floral': 'flower-2', 'alimento': 'apple', 'shampoo': 'droplets', 'locion': 'spray-can', 'spray': 'spray-can' };

                    const exactMatch = Object.keys(APP_CONFIG.ICONS.ITEM).find(k => iconSlug.includes(k) || k.includes(iconSlug));
                    if (exactMatch) iconName = APP_CONFIG.ICONS.ITEM[exactMatch];
                    else {
                        const k = Object.keys(keywordMap).find(key => iconSlug.includes(key));
                        if (k) iconName = keywordMap[k];
                    }

                    fragment += `<div class="mb-1 space-y-1 mt-2">
                                <a href="#sec-${node.id}" data-tid="${node.id}" class="sidebar-link group">
                                    <i data-lucide="${iconName}" class="w-4 h-4 text-slate-400 group-hover:text-primary transition-colors"></i>
                                    <span>${node.label}</span>
                                </a>
                              </div>`;
                }
                appendFn(fragment);
            },

            // --- GENERADOR DEL CONTENIDO (Panel Principal) ---
            generateContentHTML(tree) {
                let html = '';

                tree.forEach(section => {
                    // NIVEL 1: SECCIÓN
                    html += `<div class="section-container mb-24 w-full">
                                <h1 class="text-4xl font-black text-secondary mb-4 tracking-tighter w-full">${renderText(section.displayTitle)}</h1>
                                <p class="text-slate-500 mb-10 text-lg font-normal w-full max-w-none leading-relaxed">${renderText(section.desc)}</p>
                                <div class="section-content">`;

                    section.children.forEach(node => {
                        // NIVEL 2: SUBTÍTULO
                        if (node.type === 'subtitle') {
                            // CONTENEDOR FLUSH-LEFT (Sin Clases Custom)
                            html += `<div class="mb-16 pl-0 ml-0">
                                        <h2 class="text-2xl font-bold text-slate-800 mb-6 pl-0 ml-0">${renderText(node.title)}</h2>
                                        ${node.desc ? `<p class="text-slate-500 mb-8 font-normal w-full max-w-none pl-0 ml-0">${renderText(node.desc)}</p>` : ''}`;

                            if (node.children) {
                                html += `<div class="space-y-12 pl-0 ml-0">`; // Eliminada clase 'subtitle-children'
                                node.children.forEach(child => this.appendContentNode(html, child, (h) => html += h));
                                html += `</div>`;
                            }
                            html += `</div>`;
                        }
                        // Opción 2: Nodo directo
                        else {
                            html += `<div class="mb-12 pl-0 ml-0">`;
                            this.appendContentNode(html, node, (h) => html += h);
                            html += `</div>`;
                        }
                    });

                    html += `</div></div>`; // Fin section-container
                });
                return html;
            },

            // --- HELPER INTERNO PARA NODOS DE CONTENIDO ---
            appendContentNode(currentHtml, node, appendFn) {
                let fragment = '';

                // CASO A: GRUPO
                if (node.type === 'group') {
                    // CONTENEDOR GRUPO FLUSH-LEFT
                    fragment += `<div class="mb-12 pl-0 ml-0">
                                    <div class="mb-6 pb-2 border-b border-slate-100 flex items-baseline gap-3 pl-0 ml-0">
                                        <h3 class="text-xl font-bold text-emerald-800 pl-0 ml-0">${renderText(node.title)}</h3>
                                        <p class="text-sm text-slate-400 font-normal">${renderText(node.desc)}</p>
                                    </div>
                                    <div class="pl-0 ml-0">`; // Container de items FLUSH

                    node.items.forEach(item => {
                        fragment += this.renderItemPanel(item);
                    });
                    fragment += `</div></div>`;
                }
                // CASO B: ITEM
                else if (node.type === 'item') {
                    fragment += this.renderItemPanel(node);
                }
                appendFn(fragment);
            },

            // --- FASE 1: EL ARQUITECTO (Construcción Jerárquica corregida) ---
            buildHierarchy(rows) {
                const tree = [];
                const sectionMap = new Map();

                rows.forEach(row => {
                    const l1 = (row.nivel_1 || "").trim();
                    if (!l1) return;

                    // 1. NIVEL 1 (SECCIÓN) - Garantizar unicidad
                    if (!sectionMap.has(l1)) {
                        const sectionNode = {
                            type: 'section',
                            title: l1.charAt(0).toUpperCase() + l1.slice(1).toLowerCase(),
                            rawTitle: l1,
                            displayTitle: row.nivel_1_titulo || l1,
                            desc: row.nivel_1_descripcion || '',
                            children: [],
                            subtitleMap: new Map(), // Para rastrear subtítulos únicos dentro de esta sección
                            itemMap: new Map()      // Para rastrear items (N2/N3) sueltos únicos
                        };
                        sectionMap.set(l1, sectionNode);
                        tree.push(sectionNode);
                    }

                    const activeSection = sectionMap.get(l1);

                    // 2. NIVEL SUBTÍTULO
                    const sub = (row.subtitulo || "").trim();
                    let activeSubtitle = null;

                    if (sub && sub !== 'undefined') {
                        if (!activeSection.subtitleMap.has(sub)) {
                            const subtitleNode = {
                                type: 'subtitle',
                                title: sub,
                                desc: row.subtitulo_descripcion || '',
                                groupMap: new Map(), // Para rastrear grupos únicos dentro de este subtítulo
                                children: []        // Para mantener el orden de inserción de grupos/items
                            };
                            activeSection.subtitleMap.set(sub, subtitleNode);
                            activeSection.children.push(subtitleNode);
                        }
                        activeSubtitle = activeSection.subtitleMap.get(sub);
                    }

                    // 3. NIVEL AGRUPADOR (ACORDEÓN)
                    const agp = (row.agrupador || "").trim();
                    let activeGroup = null;

                    if (agp) {
                        const parent = activeSubtitle || activeSection;
                        const containerMap = activeSubtitle ? activeSubtitle.groupMap : activeSection.itemMap;

                        // Si el "agp" no existe en el contenedor actual, lo creamos
                        if (!containerMap.has(agp)) {
                            const groupNode = {
                                type: 'group',
                                title: agp,
                                desc: row.agrupador_descripcion || '',
                                items: [],
                                itemSet: new Set() // Para evitar productos duplicados exactos en el mismo grupo
                            };
                            containerMap.set(agp, groupNode);

                            if (activeSubtitle) {
                                activeSubtitle.children.push(groupNode);
                            } else {
                                activeSection.children.push(groupNode);
                            }
                        }
                        activeGroup = containerMap.get(agp);
                    }

                    // 4. NIVEL ITEM (HOJA)
                    const titleShort = row.nivel_3 || row.nivel_2 || "Item";

                    // ESTRATEGIA DE ID ÚNICO (Jerárquico)
                    // Genera IDs tipo "agrupador-item" (ej: "pomadas-arnica") para evitar colisiones 
                    // cuando un mismo nombre de producto existe en diferentes categorías.
                    let context = agp || sub || l1 || "global";
                    let identifier = row.tabla_id || titleShort;

                    // Optimización: Si el identifier ya empieza con el context (duplicidad manual), lo simplificamos
                    // Esto maneja casos donde el usuario ya puso "Pomadas Arnica" en el nombre.
                    if (identifier.toLowerCase().startsWith(context.toLowerCase())) {
                        context = "";
                    }

                    const rawId = context ? `${context}-${identifier}` : identifier;
                    const cleanId = DataService.slugify(rawId);

                    const itemNode = {
                        type: 'item',
                        id: cleanId,
                        label: titleShort,
                        originalRow: row,
                        tablaId: row.tabla_id
                    };

                    // Asignación con control de duplicados
                    if (activeGroup) {
                        if (!activeGroup.itemSet.has(cleanId)) {
                            activeGroup.items.push(itemNode);
                            activeGroup.itemSet.add(cleanId);
                        }
                    } else {
                        const container = activeSubtitle || activeSection;
                        // Solo añadimos si el item no existe ya en este nivel (basado en su cleanId)
                        if (!activeSection.itemMap.has(cleanId)) {
                            activeSection.itemMap.set(cleanId, itemNode);
                            if (activeSubtitle) {
                                activeSubtitle.children.push(itemNode);
                            } else {
                                activeSection.children.push(itemNode);
                            }
                        }
                    }
                });

                return tree;
            },

            // --- HELPER DE RENDERIZADO VISUAL ---
            renderItemPanel(node) {
                const row = node.originalRow;

                // Filtrado de Precios ESTRICTO (Igualdad exacta con tabla_id)
                let precios = [];
                if (row.tabla_id) {
                    const target = row.tabla_id.toLowerCase().trim();
                    precios = STATE.prices.filter(p => (p.tabla_id || "").toLowerCase().trim() === target);
                } else {
                    // Fallback LEGACY: Solo si no hay tabla_id explícito
                    // Usamos slugify para coincidencia aproximada, pero esto no debería ocurrir en data nueva
                    const filterName = node.label.toLowerCase();
                    precios = STATE.prices.filter(p => (p.tabla_id || "").toLowerCase().includes(DataService.slugify(filterName)));
                }

                let html = `<div id="sec-${node.id}" class="l2-container mb-10">`;

                // Título del Item Nivel 2 (si existe)
                const dispTitle = row.nivel_2_titulo || row.nivel_2;
                if (dispTitle) {
                    html += `<h4 class="l2-title">${renderText(dispTitle)}</h4>
                             <p class="text-sm text-slate-400 font-normal mb-4">${renderText(row.nivel_2_descripcion)}</p>`;
                }

                html += this.createTable(row, precios);
                html += `</div>`;
                return html;
            },

            createTable(meta, items) {
                // NOTA: El ID de sección se maneja en renderItemPanel. Esta función solo genera la tabla.

                // LÓGICA DE PARSEO DE NOTAS AVANZADO (Smart Grid + Blocks)
                const rawNotas = items.map(i => i.notas).filter(n => n && n.trim().length > 0);

                // Procesamiento de Bloques HTML
                const processedBlocks = [];

                rawNotas.forEach(raw => {
                    // 1. Separar por Bloques (^)
                    const blocks = raw.split('^').map(b => b.trim());

                    blocks.forEach(block => {
                        if (block.length === 0) {
                            // Bloque vacío = Salto de línea extra
                            processedBlocks.push('<br>');
                            return;
                        }

                        // 2. Detectar Listas (|)
                        if (block.includes('|')) {
                            const listItems = block.split('|').map(i => i.trim()).filter(i => i.length > 0);
                            if (listItems.length > 0) {
                                processedBlocks.push(`<ul class="note-grid-list">${listItems.map(item => `<li>${item}</li>`).join('')}</ul>`);
                            }
                        } else {
                            processedBlocks.push(`<p class="note-text">${block}</p>`);
                        }
                    });
                });

                // Deduplicar bloques idénticos (por si varios productos tienen la misma nota base)
                const uniqueBlocks = [...new Set(processedBlocks)];

                const showTitle = !!meta.nivel_3;
                const titleLong = meta.nivel_3_titulo || meta.nivel_3;

                return `<section class="mb-8">
                    ${showTitle ? `<h5 class="text-xl font-black text-secondary mb-3 section-title-n3">${renderText(titleLong)}</h5>
                                   <p class="text-xs text-slate-400 mb-6 font-normal tracking-tight">${renderText(meta.nivel_3_descripcion)}</p>` : ''}

                    ${items.length ? `<div class="data-grid-container">
                        <table class="data-grid">
                            <thead>
                                <tr>
                                    <th class="pl-4">Presentación</th>
                                    <th class="text-right professional-only text-emerald-600">Precio farmacia</th>
                                    <th class="text-right pr-4">Precio público</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(p => `
                                <tr class="hover:bg-slate-100 transition-colors">
                                    <td class="pl-4 product-name">
                                        <div class="font-medium text-secondary text-sm">${renderText(p.producto)}</div>
                                        <div class="text-[10px] text-slate-500 font-bold tracking-tight">${renderText(p.presentacion)}</div>
                                    </td>
                                    <td class="text-right professional-only font-bold text-emerald-600" data-label="Farmacia">${this.formatPrice(p.precio_farmacia)}</td>
                                    <td class="text-right font-black text-secondary pr-4" data-label="Público">${this.formatPrice(p.precio_publico)}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>` : '<p class="text-xs text-slate-500 italic pl-4">Catálogo en actualización</p>'}

                    ${uniqueBlocks.length ? `<div class="mt-4 notes-container">
                        <p class="text-[11px] font-black text-slate-700 tracking-widest mb-3"><i data-lucide="info" class="w-3.5 h-3.5 inline mr-1 text-emerald-500"></i> Información adicional:</p>
                        <div class="space-y-4">
                            ${uniqueBlocks.join('')}
                    </div>
                    </div>` : ''}
                </section>`;
            },

            // --- RENDERIZADO DE DISTRIBUIDORES (BUSINESS CARD SYSTEM) ---
            renderContactItems() {
                const sedePrincipalContainer = document.getElementById('sede-principal-container');
                const distributorsGrid = document.getElementById('distributors-grid');
                if (!distributorsGrid || !sedePrincipalContainer) return;

                if (!STATE.dist.length) {
                    distributorsGrid.innerHTML = '<p class="text-slate-500 italic col-span-2 text-center">Cargando la red de distribuidores...</p>';
                    return;
                }

                // Separar Sede Principal y Red de Distribución basado en la columna 'sedes' o 'sede'
                const hqs = STATE.dist.filter(d => (d.sedes || d.sede || d.tipo || "").toLowerCase().includes('principal'));
                const dists = STATE.dist.filter(d => !(d.sedes || d.sede || d.tipo || "").toLowerCase().includes('principal'));

                // 1. Renderizar Sede(s) Principal(es)
                if (hqs.length > 0) {
                    sedePrincipalContainer.innerHTML = hqs.map(hq => this.generateDistributorHTML(hq, true)).join('');

                    // Actualizar WhatsApp Global (Sidebar/Footer) basado en la primera sede
                    const mainWA = hqs[0].whatsapp_1;
                    if (mainWA) {
                        const cleanNum = Formatters.whatsapp(mainWA);
                        const msg = encodeURIComponent("Hola Mundo Homeopático, requiero información sobre productos y precios.");
                        [document.getElementById('btn-whatsapp-sidebar'), document.getElementById('footer-whatsapp-link')].forEach(btn => {
                            if (btn) btn.href = `https://wa.me/${cleanNum}?text=${msg}`;
                        });
                    }
                }

                // 2. Renderizar Distribuidores Autorizados
                distributorsGrid.innerHTML = dists
                    .filter(d => d.sede || d.sedes) // Validar que tenga al menos nombre de sede (Soporte dual)
                    .map(d => this.generateDistributorHTML(d, false))
                    .join('');

                if (window.lucide) window.lucide.createIcons();
            },

            generateDistributorHTML(dist, isHQ = false) {
                const { logo, departamento, direccion, horarios, nombre_distribuidor, nombre_persona } = dist;
                // Soporte dual para columna 'sede' o 'sedes' desde Google Sheets
                const sede = dist.sede || dist.sedes || "Distribuidor Autorizado";

                // Procesar botones de contacto (WhatsApp, Celular, Fijo)
                const contactButtons = this.generateContactButtons(dist, isHQ);

                if (isHQ) {
                    return `
                        <div class="dist-card-principal animate-fade-in">
                            <div class="grid lg:grid-cols-2 gap-8">
                                <div>
                                    <div class="flex items-center gap-5 mb-8">
                                        <div class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center p-2 shadow-sm border border-emerald-50">
                                            <img src="img/${logo || 'logo-mundo-homeopatico'}.webp" 
                                                 class="w-full h-full object-contain" 
                                                 alt="${sede}"
                                                 onerror="this.src='img/logo-mundo-homeopatico.webp'">
                                        </div>
                                        <div>
                                            <h3 class="text-2xl font-black text-secondary tracking-tight mb-1">${renderText(sede)}</h3>
                                            <p class="text-emerald-600 font-bold uppercase tracking-widest text-[11px]">${renderText(departamento)}</p>
                                        </div>
                                    </div>
                                    <div class="space-y-4 mb-8">
                                        ${direccion ? `<p class="flex items-start gap-4 text-slate-600 font-medium">
                                            <i data-lucide="map-pin" class="text-primary mt-1 w-5 h-5 flex-shrink-0"></i>
                                            <span>${renderText(direccion)}</span>
                                        </p>` : ''}
                                        ${horarios ? `<p class="flex items-start gap-4 text-slate-500 text-sm">
                                            <i data-lucide="clock" class="text-primary mt-1 w-5 h-5 flex-shrink-0"></i>
                                            <span>${renderText(horarios)}</span>
                                        </p>` : ''}
                                    </div>
                                    <div class="dist-principal-contact-wrapper">
                                        <div class="dist-contact-container grid grid-cols-2 gap-3">
                                            ${contactButtons}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col h-full">
                                    <div class="flex-grow min-h-[300px] rounded-2xl overflow-hidden border border-slate-200 shadow-sm relative bg-slate-100 mb-4">
                                        <iframe 
                                            width="100%" 
                                            height="100%" 
                                            style="border:0; min-height: 100%;" 
                                            loading="lazy" 
                                            allowfullscreen 
                                            src="https://maps.google.com/maps?q=${encodeURIComponent((direccion || 'Medellín') + ' ' + (departamento || 'Antioquia'))}&t=&z=15&ie=UTF8&iwloc=&output=embed">
                                        </iframe>
                                    </div>
                                    <a href="${dist.mapa || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((direccion || '') + ', ' + (departamento || ''))}`}" 
                                       target="_blank" 
                                       class="btn-animated-refresh w-full justify-center">
                                        <span>Cómo llegar</span>
                                        <i data-lucide="map-pin" class="w-4 h-4 ml-2"></i>
                                    </a>
                                </div>
                            </div>
                        </div>`;
                }

                return `
                    <div class="dist-card animate-fade-in">
                        <div class="dist-card-header">
                            <img src="img/${logo || 'logo-mundo-homeopatico'}.webp" 
                                 class="w-10 h-10 object-contain" 
                                 alt="${sede}"
                                 onerror="this.src='img/logo-mundo-homeopatico.webp'">
                            <h4 class="font-bold text-secondary text-base leading-tight">${renderText(sede)}</h4>
                        </div>
                        <div class="p-6">
                            ${nombre_distribuidor ? `<p class="font-bold text-slate-700 mb-1 text-sm">${renderText(nombre_distribuidor)}</p>` : ''}
                            ${nombre_persona ? `<p class="text-xs text-slate-500 mb-3 font-medium">${renderText(nombre_persona)}</p>` : ''}
                            
                            <div class="space-y-2 text-xs text-slate-500 mb-4">
                                <p class="flex items-center gap-2"><i data-lucide="map" class="w-3.5 h-3.5 opacity-50"></i>${renderText(departamento)}</p>
                                ${direccion ? `<p class="flex items-center gap-2"><i data-lucide="map-pin" class="w-3.5 h-3.5 opacity-50"></i>${renderText(direccion)}</p>` : ''}
                            </div>
                            
                            <div class="dist-contact-container flex flex-wrap gap-2 mt-auto">
                                ${contactButtons}
                            </div>
                        </div>
                    </div>`;
            },

            generateContactButtons(data, fullWidth = false) {
                let html = '';
                const btnExtras = fullWidth ? 'w-full justify-center text-center' : '';

                // WhatsApps (1-4)
                [1, 2, 3, 4].forEach(i => {
                    const wa = data[`whatsapp_${i}`];
                    if (wa) {
                        html += `
                            <a href="https://wa.me/${Formatters.whatsapp(wa)}" target="_blank" class="dist-btn-whatsapp ${btnExtras}">
                                <i data-lucide="message-circle" class="w-4 h-4"></i>
                                <span>${Formatters.formatPhone(wa)}</span>
                            </a>`;
                    }
                });

                // Móviles (1-2)
                [1, 2].forEach(i => {
                    const mov = data[`movil_${i}`];
                    if (mov) {
                        html += `
                            <div class="dist-tag-phone ${btnExtras}">
                                <i data-lucide="smartphone" class="w-4 h-4"></i>
                                <span>${Formatters.formatPhone(mov)}</span>
                            </div>`;
                    }
                });

                // Fijos (1-2)
                [1, 2].forEach(i => {
                    const fij = data[`telefono_fijo_${i}`];
                    if (fij) {
                        html += `
                            <div class="dist-tag-phone ${btnExtras}">
                                <i data-lucide="phone" class="w-4 h-4"></i>
                                <span>${renderText(fij)}</span>
                            </div>`;
                    }
                });

                return html;
            },

            renderFAQ() {
                const faqCont = document.getElementById('faq-container');
                if (faqCont && STATE.faq.length) {
                    // FAQ CONTROLADO: Botones + JS para comportamiento exclusivo
                    faqCont.innerHTML = STATE.faq.map((f, index) => {
                        // Búsqueda Flexible de Columnas (Smart Key Search)
                        const keys = Object.keys(f);
                        const qKey = keys.find(k => k.toLowerCase().includes('pregunta')) || 'pregunta';
                        const aKey = keys.find(k => k.toLowerCase().includes('respuesta') || k.toLowerCase().includes('answer')) || 'respuesta';

                        const q = f[qKey] || "Pregunta pendiente";
                        const a = f[aKey] || "Respuesta en proceso...";
                        return `<div class="bg-white rounded-lg border border-slate-100 overflow-hidden transition-all duration-300 hover:shadow-md">
                            <button onclick="UIHandlers.toggleFaq(this)" class="faq-trigger w-full flex justify-between items-center p-6 text-left" aria-expanded="false">
                                <span class="font-bold text-sm text-secondary pr-4">${renderText(q)}</span>
                                <i data-lucide="chevron-down" class="w-5 h-5 text-slate-300 transition-transform duration-300 flex-shrink-0"></i>
                            </button>
                            <div class="faq-answer-container hidden px-6 pb-6 pt-0">
                                <div class="text-xs text-slate-500 font-normal leading-relaxed border-t border-slate-50 pt-4 animate-fade-in">
                                    ${renderText(a)}
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                } else if (faqCont) {
                    faqCont.innerHTML = '<p class="text-slate-500 italic">Cargando preguntas frecuentes...</p>';
                }
            },
            formatPrice: (v) => {
                if (!v || v === '-') return '-';
                const num = parseInt(String(v).replace(/\D/g, ''));
                if (isNaN(num)) return '-';
                // Formato colombiano: separador de miles = punto, sin decimales
                return `$${num.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            },
            initObserver() {
                // OBSERVER MEJORADO: Margen ajustado para detectar mejor el centro de la pantalla
                const obs = new IntersectionObserver((es) => {
                    // SI ES SCROLL MANUAL O INTERACCIÓN EN SIDEBAR, IGNORAR AL OBSERVER
                    if (UIHandlers.isManualScroll || UIHandlers.isInteracting) return;

                    es.forEach(e => {
                        if (e.isIntersecting) {
                            // Quitar active de todo
                            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                            // Poner active al correspondiente
                            const link = document.querySelector(`.sidebar-link[data-tid="${e.target.id.replace('sec-', '')}"]`);
                            if (link) {
                                link.classList.add('active');
                                // ELIMINADO: Auto-apertura de acordeón desde el Observer.
                                // Causa conflicto cuando el usuario explora el menú mientras ve otra sección.
                            }
                        }
                    });
                }, {
                    root: null, // viewport
                    rootMargin: '-20% 0px -60% 0px', // Zona activa en el centro-superior de la pantalla
                    threshold: 0
                });

                document.querySelectorAll('section[id]').forEach(s => obs.observe(s));
            }
        };



        document.addEventListener('DOMContentLoaded', async () => {

            UIHandlers.init();
            UIHandlers.initNavigation(); // Activar el nuevo motor de clicks

            // Sincronización Inteligente: Cargar Caché -> Renderizar -> Fetch Background -> Actualizar
            const keys = {
                prices: 'mh_cache_prices',
                nav: 'mh_cache_nav',
                faq: 'mh_cache_faq',
                dist: 'mh_cache_dist',
                banner: 'mh_cache_banner'
            };

            // Flag para evitar doble render
            let hasRenderedFromCache = false;

            // 1. Renderizado Inmediato desde Caché (si existe)
            try {
                const cachedPrices = localStorage.getItem(keys.prices);
                const cachedNav = localStorage.getItem(keys.nav);
                const cachedFaq = localStorage.getItem(keys.faq);
                const cachedDist = localStorage.getItem(keys.dist);
                const cachedBanner = localStorage.getItem(keys.banner);

                if (cachedPrices && cachedNav) {
                    STATE.prices = JSON.parse(cachedPrices);
                    STATE.nav = JSON.parse(cachedNav);
                    STATE.faq = cachedFaq ? JSON.parse(cachedFaq) : [];
                    STATE.dist = cachedDist ? JSON.parse(cachedDist) : [];
                    RenderEngine.renderAll();
                    hasRenderedFromCache = true;
                }

                // Mostrar banner desde caché inmediatamente si existe
                if (cachedBanner && localStorage.getItem('mh_banner_closed') !== 'true') {
                    const bannerTextEl = document.getElementById('bannerText');
                    if (bannerTextEl) {
                        bannerTextEl.innerHTML = escapeHtml(cachedBanner).replace(/\^/g, '<br>');
                        document.getElementById('bannerWrapper')?.classList.remove('collapsed');
                        document.body.classList.add('has-banner');
                    }
                }
            } catch (e) { console.error('Error leyendo caché', e); }

            // 2. Carga Inmediata del Banner (Prioridad Visual)
            DataService.fetchCSV(APP_CONFIG.SHEETS.BANNER).then(d => {
                const bannerMsg = d?.[0]?.banner || d?.[0]?.mensaje || "";
                if (bannerMsg) {
                    localStorage.setItem(keys.banner, bannerMsg);
                    if (localStorage.getItem('mh_banner_closed') === 'true') return;
                    const bannerTextEl = document.getElementById('bannerText');
                    if (bannerTextEl) {
                        document.getElementById('bannerWrapper')?.classList.remove('collapsed');
                        bannerTextEl.innerHTML = escapeHtml(bannerMsg).replace(/\^/g, '<br>');
                        document.body.classList.add('has-banner');
                    }
                }
            }).catch(e => console.warn("Banner fetch error", e));

            // 3. Carga diferida de otros recursos no críticos
            setTimeout(() => {
                DataService.fetchCSV(APP_CONFIG.SHEETS.AUTHOR).then(d => {
                    if (d && d[0]) {
                        const l = document.getElementById('author-link');
                        if (l) { l.textContent = d[0].nombre || ""; l.href = d[0].url || "#"; }
                        document.getElementById('author-credit')?.classList.remove('opacity-0');
                    }
                }).catch(() => { });

                DataService.fetchCSV(APP_CONFIG.SHEETS.VIDEO).then(d => {
                    if (d && d.length > 0) {
                        // Búsqueda Robusta: Escanear todas las columnas por una URL de YouTube válida
                        const row = d[0];
                        const url = Object.values(row).find(v => v && typeof v === 'string' && (v.includes('youtube.com') || v.includes('youtu.be')));

                        if (url) {
                            // Regex universal para ID de YouTube
                            const match = url.match(/(?:v=|\/embed\/|youtu\.be\/|\/v\/|\/e\/|watch\?v%3D|watch\?v=)([^#\&\?]*).*/);
                            const videoId = match && match[1] ? match[1] : null;

                            if (!videoId) return;

                            const container = document.getElementById('videoContainer');
                            if (container) {
                                // Usar data-attributes para evitar problemas de comillas en inline JS
                                container.innerHTML = `<div class="youtube-facade w-full h-full group" 
                                    data-video-id="${videoId}"
                                    onclick="UIHandlers.loadVideo(this)">
                                    <img src="https://img.youtube.com/vi/${videoId}/maxresdefault.jpg" 
                                        alt="Video de Calidad"
                                        class="w-full h-full object-cover transition-opacity duration-300 group-hover:opacity-80"
                                        onerror="this.src='https://img.youtube.com/vi/${videoId}/hqdefault.jpg'">
                                    <div class="play-button shadow-2xl"></div>
                                </div>`;
                            }
                        }
                    }
                }).catch(() => { });
            }, 800);

            // 4. Fetch de datos PRINCIPALES (Estrategia Stale-While-Revalidate OPTIMIZADA)
            // LÓGICA: Solo hacemos fetch de red si:
            //   A) No hay caché (primera visita)
            //   B) Es un refresh manual (F5/Ctrl+R) - detectado via Performance API
            const isManualRefresh = performance.navigation?.type === 1 ||
                (performance.getEntriesByType?.('navigation')?.[0]?.type === 'reload');
            const shouldFetchFresh = !hasRenderedFromCache || isManualRefresh;

            if (shouldFetchFresh) {
                try {
                    // Solo mostramos barra de carga si NO hay nada que mostrar (primera carga)
                    if (!hasRenderedFromCache) UIHandlers.showLoading(true);

                    const [p, n, f, dist, auth] = await Promise.all([
                        DataService.fetchCSV(APP_CONFIG.SHEETS.PRICES),
                        DataService.fetchCSV(APP_CONFIG.SHEETS.NAV),
                        DataService.fetchCSV(APP_CONFIG.SHEETS.FAQ),
                        DataService.fetchCSV(APP_CONFIG.SHEETS.DIST),
                        DataService.fetchCSV(APP_CONFIG.SHEETS.AUTH)
                    ]);

                    // Actualizar Estado y Caché
                    if (p.length) { STATE.prices = p; localStorage.setItem(keys.prices, JSON.stringify(p)); }
                    if (n.length) { STATE.nav = n; localStorage.setItem(keys.nav, JSON.stringify(n)); }
                    if (f.length) { STATE.faq = f; localStorage.setItem(keys.faq, JSON.stringify(f)); }
                    if (dist.length) { STATE.dist = dist; localStorage.setItem(keys.dist, JSON.stringify(dist)); }
                    if (auth && auth.length) { STATE.auth = auth; }

                    // Finalizar Barra de Carga
                    UIHandlers.showLoading(false);

                    // Actualizar UI con datos frescos
                    if (p.length && n.length) {
                        // En refresh manual, SIEMPRE re-renderizamos para mostrar cambios
                        if (isManualRefresh || !hasRenderedFromCache) {
                            RenderEngine.renderAll();
                        }
                    } else if (!hasRenderedFromCache) {
                        // Solo alertamos si no teníamos nada que mostrar
                        alert("¡Atención! No se pudieron descargar los datos de Google Sheets. Verifica tu conexión a internet.");
                    }
                } catch (error) {
                    console.error('Error en sincronización:', error);
                    UIHandlers.showLoading(false);
                    if (STATE.prices.length === 0) {
                        document.getElementById('tables-container').innerHTML = `<div class="p-8 text-center text-red-500 font-bold">Error de conexión. Intente recargar.</div>`;
                    }
                }
            } else {
                // Caché válido + navegación normal = NO hacer fetch
                // Cargar AUTH en background silencioso (para login)
                DataService.fetchCSV(APP_CONFIG.SHEETS.AUTH).then(auth => {
                    if (auth && auth.length) STATE.auth = auth;
                }).catch(() => { }); // Silenciar errores
            }
        });
    </script>
</body>

</html>