<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo Homeopático | Catálogo Senior 2026</title>
    <meta name="description"
        content="Catálogo oficial de Mundo Homeopático 2026. Lista de precios de farmacia, multipotencias, esencias florales y red de distribuidores en Colombia.">

    <!-- Open Graph (WhatsApp, Facebook) -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mundohomeopatico.com/">
    <meta property="og:title" content="Mundo Homeopático - Catálogo 2026">
    <meta property="og:description"
        content="Consulta nuestra lista de precios actualizada y red de sedes en tiempo real.">
    <meta property="og:image" content="img/logo-mundo-homeopatico.webp">

    <!-- 
    ★ ARQUITECTURA MONOLÍTICA ESTRUCTURADA ★
    Este proyecto está diseñado intencionalmente como un SOLO ARCHIVO (index.html) para maximizar 
    la compatibilidad con GitHub Pages, facilitar el mantenimiento por IA y eliminar fricción de despliegue.
    
    ESTRUCTURA DE REGIONES (Usar "Fold" en el editor):
    1. INFRAESTRUCTURA (Meta & Libs)
    2. SISTEMA DE DISEÑO (CSS Scoped)
    3. ESTRUCTURA DE INTERFAZ (HTML Semántico)
    4. LÓGICA DE NEGOCIO (JS Modular)
    
    NO SEPARAR EN ARCHIVOS EXTERNOS sin una justificación técnica crítica (>3000 líneas).
    -->

    <!-- //#region 1. INFRAESTRUCTURA PROYECTO -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- //#endregion -->

    <style>
        /* 
        ==========================================================================
        ★ SISTEMA DE DISEÑO & ESTANDARIZACIÓN (FUENTE ÚNICA DE VERDAD) ★
        ==========================================================================
        
        IMPORTANTE PARA AGENTES DE IA Y DESARROLLADORES:
        Este proyecto utiliza un sistema de DESIGN TOKENS definido en :root. 
        NO utilizes valores "hardcoded" (ej. 24px, #ccc, 10px padding) directamente en las clases.
        SIEMPRE usa las variables semánticas definidas a continuación.
        
        LÓGICA DE VARIABLES:
        1. Branding & Colores: --primary, --secondary, etc.
        2. tokens de Componentes (--p-*): Padding específico para Header, Sidebar, Tablas.
        3. tokens Visuales: --border-*, --radius-*, --shadow-*.
        4. Tipografía: --fw-*, --lh-*.

        Si necesitas cambiar el espaciado de una tabla, NO edites la clase .data-grid.
        EDITA la variable --p-table-cell en :root.
        ==========================================================================
        
        ARQUITECTURA & REGLAS DE COHERENCIA:
        1. SEPARACIÓN DE RESPONSABILIDADES:
           - HTML: Solo estructura y semántica (ej: .main-header). NO usar utilidades de estilo si existe una clase semántica.
           - CSS: Controla TODO el aspecto visual y el layout. Responde a estados (.is-open, .active).
           - JS: Controla la lógica y el estado. Solo añade/quita clases de estado, NO inyecta estilos inline ni clases de utilidad.
        
        2. ESTADOS:
           - Usar .is-open, .is-active, .has-error para variantes.
           - Evitar style.display = 'none' en JS; usar clases de estado.
        ==========================================================================
        */

        /* //#region 2. SISTEMA DE DISEÑO (CSS) */
        :root {
            /* Branding: Abstracción de colores del logo */
            --primary: #10b981;
            /* Verde Institucional */
            --primary-dark: #059669;
            --secondary: #0f172a;
            /* Azul Pizarra (Identidad Visual) */
            --primary-light: #ecfdf5;

            /* Escala de Grises y Superficies */
            --slate-50: #f8fafc;
            --bg-secondary: #f8fafc;
            --border-color: #cbd5e1;
            /* slate-300 for better contrast */
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-400: #94a3b8;
            --text-primary: #0f172a;

            /* Grid System (Medidas Matemáticas de imagen adjunta) */
            --sidebar-w: 280px;
            /* Navigation Area Width */
            --radius: 24px;
            /* Radio de curvatura estándar */

            /* SISTEMA DE ESPACIADO ESTANDARIZADO (Escala 4px/8px) */
            --space-xs: 0.25rem;
            /* 4px */
            --space-s: 0.5rem;
            /* 8px */
            --space-m: 1rem;
            /* 16px */
            --space-l: 1.5rem;
            /* 24px */
            --space-xl: 2rem;
            /* 32px */
            --space-xxl: 4rem;
            /* 64px */

            /* SISTEMA TIPOGRÁFICO ESTANDARIZADO */
            --font-xs: 10px;
            --font-sm: 13px;
            /* Sidebar & Metadata */
            --font-base: 16px;
            /* Body text */
            --font-lg: 18px;
            /* Subtitles */
            --font-xl: 24px;
            /* Section Titles */
            --font-display: 3.75rem;
            /* 60px - Hero Titles */
            --header-h: 80px;
            /* Altura Estándar Dashboard (Más compacta que 96/112) */

            /* TOKENS SEMÁNTICOS (Estandarización de Componentes) */
            --p-header-v: 0.8rem;
            --p-header-h: clamp(1rem, 5%, 2rem);
            --p-sidebar: 2rem;
            /* Espacio superior sidebar */
            --p-nav-item-v: 0.75rem;
            --p-nav-item-h: 1rem;

            --p-card: 2.5rem;
            /* Padding interno de tarjetas */

            /* Alineación Maestra */
            --align-offset: 24px;

            /* TOKENS DE BORDES (Estandarización Visual) */
            --border-color-soft: var(--slate-200);
            --border-color-strong: #747775;
            --border-width-std: 1px;

            /* TOKENS DE TIPOGRAFÍA (Peso e Interlineado) */
            --fw-bold: 700;
            --lh-title: 1.2;

            /* TOKENS DE TABLAS */
            --p-table-cell: 12px 16px;

            /* TOKENS DE RADIO (Curvatura) */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --radius-full: 999px;

            /* TOKENS DE ELEVACIÓN (Sombras) */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Atkinson Hyperlegible', sans-serif;
            background: var(--slate-50);
            color: var(--secondary);
            -webkit-font-smoothing: antialiased;
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        .app-layout {
            display: block;
            /* Layout bloque para soporte fixed */
            width: 100%;
            min-height: 100vh;
            background: var(--slate-50);
        }

        /* Estructura SPA Global */
        .main-header {
            height: var(--header-h);
            background: #fff;
            border-bottom: 1px solid var(--slate-200);
            /* Línea sutil de separación */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            /* Capa superior absoluta */
            display: flex;
            align-items: center;
            padding: 0;
            box-shadow: var(--shadow-sm);
            /* Sombra suave para elevación */
        }

        .main-sidebar {
            width: var(--sidebar-w);
            height: calc(100vh - var(--header-h));
            position: fixed;
            top: var(--header-h);
            /* Anclado bajo el header */
            left: 0;
            background: #fff;
            border-right: var(--border-width-std) solid var(--border-color-soft);
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 90;
            /* Bajo el header */
            padding: var(--p-sidebar) 0;
            /* Padding vertical interno */

            display: flex;
            flex-direction: column;
            padding-left: 0;
            /* Reset for precise control */
            padding-right: 0;
        }

        .main-sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .main-sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .main-sidebar::-webkit-scrollbar-thumb {
            background: var(--slate-200);
            border-radius: var(--radius-full);
        }

        .main-sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--slate-300);
        }

        /* Alineación Maestra Sidebar (Coordenada X=40px) */
        /* El logo en header tiene px-10 (40px). 
           Los items del sidebar tienen padding interno de 12px.
           Necesitamos 28px de margen externo + 12px padding interno = 40px visuales.
        */
        #sidebar-catalog-view,
        #sidebar-contact-view {
            padding: 0 28px;
            /* 28px + 12px de item = 40px alineado con logo */
        }

        .main-content-wrapper {
            margin-left: var(--sidebar-w);
            /* Espacio para sidebar */
            margin-top: var(--header-h);
            /* Espacio para header */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Ajuste de Scroll para Anclas */
        html {
            scroll-padding-top: calc(var(--header-h) + 20px);
        }

        /* Banner Dinámico Fluido */
        .banner-wrapper {
            position: sticky;
            top: var(--header-h);
            /* Sigue debajo del header contextual */
            z-index: 30;
            background: #fffbeb;
            border-bottom: 1px solid #fef3c7;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 200px;
            overflow: hidden;
            opacity: 1;
        }

        .banner-wrapper.collapsed {
            max-height: 0;
            border: none;
            opacity: 0;
            pointer-events: none;
        }

        /* DISEÑO DEFINITIVO BOTÓN SLOT (Referencia: "Continue ->") */
        .btn-base {
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            /* Texto izquierda, Slot derecha */
            gap: 0.8em;
            /* Separación visual entre texto y slot */
            border-radius: 999px;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            /* Lógica de Padding Asimétrico "Flush" Inteligente */
            --button-height: 2.8em;
            height: var(--button-height);

            /* Valores por defecto */
            padding: 0.35em;
        }

        /* CASO 1: Icono a la DERECHA (Contacto ->) */
        .btn-base:has(> i:last-child),
        .btn-base:has(> svg:last-child) {
            padding-left: 1.5em;
            /* Aire texto */
            padding-right: 0.35em;
            /* Flush icono */
        }

        /* Fallback para navegadores viejos que no soporten :has (opcional, pero buena práctica) */
        .btn-base i:last-child {
            margin-left: auto;
        }

        /* CASO 2: Icono a la IZQUIERDA (<- Catálogo) */
        .btn-base:has(> i:first-child),
        .btn-base:has(> svg:first-child) {
            padding-left: 0.35em;
            /* Flush icono */
            padding-right: 1.5em;
            /* Aire texto */
        }

        /* Slot del Icono (Cápsula Lateral) */
        .btn-base i,
        .btn-base svg {
            /* El slot ocupa casi toda la altura del botón */
            width: 2.1em;
            height: 2.1em;

            padding: 0.55em;
            /* Icono centrado con aire dentro del slot */
            background-color: rgba(255, 255, 255, 0.2);
            /* Contraste fuerte como en la ref */
            border-radius: 50%;
            stroke-width: 2.5px;
            flex-shrink: 0;
            display: block;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
            font-size: var(--font-sm);
            /* Ligeramente más grande para balance */
            letter-spacing: 0.05em;
        }

        .btn-primary:hover {
            background: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:hover i {
            background-color: rgba(0, 0, 0, 0.2);
            transform: rotate(-15deg) scale(1.05);
            /* Micro-interacción dinámica */
        }

        /* Sidebar Links e Iconografía */
        .sidebar-label-l1 {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            /* Padding uniforme */
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--secondary);
            /* Sin márgenes extraños, solo flujo natural */
        }

        #sidebar-menu>.sidebar-label-l1:first-child {
            margin-top: 0;
            /* El primero va pegado arriba */
        }

        .sidebar-subtitle-context {
            font-size: var(--font-sm);
            color: #64748b;
            /* Slate 500 para diferenciar de links */
            font-weight: 500;
            padding: 4px 12px;
            /* Menos altura que un link clickeable */
            margin: 4px 8px 2px 0;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            /* Compacto */
            margin: 2px 0 2px 0;
            /* Sin margen lateral, el padre controla el padding */
            font-size: var(--font-sm);
            font-weight: 500;
            color: #334155;
            /* Slate 700 */
            text-decoration: none;
            cursor: pointer;
            border-radius: 6px;
            /* Estilo Figma: Rectángulo redondeado consistente */
            transition: all 0.15s ease;
            position: relative;
        }

        /* AJUSTE ÓPTICO DE TEXTO (Optical Center Fix) */
        .sidebar-link span,
        .sidebar-item-accordion span {
            line-height: 1;
            /* Reset de altura de línea para evitar espacios fantasma */
            margin-top: 1.5px;
            /* Empuje óptico hacia abajo para centrar con el icono */
            display: inline-block;
            /* Necesario para que margin-top funcione bien */
        }

        .sidebar-link:hover {
            background: var(--slate-100);
            color: var(--secondary);
        }

        .sidebar-link.active {
            background: #e2e8f0;
            /* Slate 200: Sombreado más acentuado */
            color: var(--secondary);
            font-weight: 700;
        }

        .sidebar-link i,
        .sidebar-item-accordion i {
            width: 20px;
            /* Ancho fijo: Columna de Iconos */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            text-align: center;
        }

        /* Botón Acordeón (Estilo Homologado a Link) */
        .sidebar-item-accordion {
            width: 100%;
            display: flex;
            justify-content: start;
            align-items: center;
            gap: 12px;
            /* Mismo gap que sidebar-link */
            padding: 8px 12px;
            /* Mismo padding */
            /* Mismo padding */
            margin: 2px 0 2px 0;
            font-size: var(--font-sm);
            font-weight: 500;
            color: #334155;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .sidebar-item-accordion:hover {
            background: var(--slate-100);
            color: var(--secondary);
        }

        /* Jerarquía de Línea Vertical (Items dentro de Acordeón) */
        .sidebar-accordion-content {
            display: none;
            /* Por defecto oculto (State Management) */
            border-left: 1px solid var(--slate-200);
            margin-left: 22px;
            /* (12px padding + 10px mitad icono) */
            padding-left: 14px;
            margin-bottom: 8px;
        }

        .sidebar-accordion-content.is-open {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .sidebar-link.child-link {
            min-height: 36px;
            padding-top: 6px;
            padding-bottom: 6px;
            font-size: var(--font-sm);
            color: var(--slate-500);
            border-radius: var(--radius-sm);
        }

        .sidebar-link.child-link.active {
            color: #10b981;
            background: #f0fdf4;
            font-weight: 700;
        }

        /* Estilo de Cabecera para N2 con hijos */
        .sidebar-n2-parent {
            padding: var(--space-s) 0 var(--space-xs) 0;
            /* Estandarizado: 8px top, 4px bottom */
            font-size: var(--font-sm);
            font-weight: 800;
            color: var(--slate-400);
            letter-spacing: 0.05em;
        }

        /* Data Displays: Jerarquía H1-H5 */
        .catalog-card {
            background: white;
            border-radius: var(--radius-lg);
            border: 1px solid var(--slate-200);
            padding: var(--p-card);
            box-shadow: var(--shadow-sm);
        }

        .data-grid-container,
        .notes-container {
            border-radius: var(--radius-md);
            /* Unificado */
            border: 1px solid #e0e0e0;
            /* Unificado */
            background: white;
            margin-top: 0.5rem;
            /* Pegado al título */
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .notes-container {
            padding: 1rem;
            /* Padding interno para notas */
        }

        .data-grid {
            border-collapse: collapse;
            width: 100%;
        }

        .data-grid th {
            background: white;
            padding: var(--p-table-cell);
            text-align: left;
            font-size: var(--font-sm);
            font-weight: 500;
            color: #5f6368;
            /* Gris de Etiquetas Google */
            text-transform: none;
            border-bottom: 1px solid #747775;
            /* Header más fuerte (Google v3) */
        }

        .data-grid td {
            padding: var(--p-table-cell);
            border-bottom: 1px solid #c7c7c7;
            /* Línea de fila visible y definida */
            font-size: var(--font-sm);
            color: #202124;
            vertical-align: middle;
        }

        .data-grid tr:last-child td {
            border-bottom: none;
        }

        .data-grid tr:hover td {
            background-color: var(--slate-100);
            cursor: pointer;
        }

        .data-grid th.text-right,
        .data-grid td.text-right {
            text-align: right;
            padding-right: 24px;
        }

        /* Ajuste para el nombre del producto (Negrita suave como Drive) */
        .product-name {
            font-weight: 500;
            color: #202124;
        }

        /* BARRA DE PROGRESO SUPERIOR (Estilo YouTube/GitHub) */
        .top-progress-bar {
            position: absolute;
            /* Cambiado a Absolute dentro del header */
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            z-index: 200;
            width: 0;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 1px 4px rgba(16, 185, 129, 0.4);
            /* Transición solo para opacidad y cierre */
            transition: opacity 0.3s ease;
        }


        @keyframes progressLoading {
            0% {
                width: 0%;
            }

            10% {
                width: 15%;
            }

            30% {
                width: 45%;
            }

            60% {
                width: 75%;
            }

            100% {
                width: 95%;
            }
        }

        .top-progress-bar.loading {
            opacity: 1;
            /* Animación de 2.5s que se queda en el 95% (forwards) */
            animation: progressLoading 2.5s cubic-bezier(0.2, 0.5, 0.2, 1) forwards;
        }

        .top-progress-bar.complete {
            width: 100% !important;
            opacity: 0;
            font-weight: 500;
            transition: all 0.2s;
        }

        /* 
           MATH BUTTONS: Alineación Óptica Avanzada 
           Referencia: Technology Checkmark Image
        */
        .btn-math {
            --py: 0.65rem;
            /* Padding vertical base (ajustable) */
            --font-size: 0.875rem;
            /* o var(--font-sm) */

            /* Fórmula Mágica: Calcula el padding lateral basado en la geometría de la fuente */
            /* 1lh = Line Height, 1cap = Cap Height (Altura de mayúscula) */
            /* Fallback para 1cap si no soportado: 0.7em */
            --px: calc(var(--py) + (1.5em - 0.7em) / 2);

            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            /* Espacio entre texto e icono */

            font-size: var(--font-size);
            line-height: 1.5;
            /* 1lh */
            padding: var(--py) var(--px);

            border-radius: 0.5rem;
            /*Rounded-lg*/
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.01em;
        }

        /* Icono a la derecha: Ajuste matemático para equidistancia al borde */
        /* Margen negativo para anular el exceso de px y dejar solo py de espacio visual */
        .btn-math.icon-right i,
        .btn-math.icon-right svg {
            margin-right: calc(var(--py) - var(--px));
            /* A veces el gap suma, así que ajustamos sutilmente */
            margin-left: 0.25rem;
        }

        /* Icono a la izquierda */
        .btn-math.icon-left i,
        .btn-math.icon-left svg {
            margin-left: calc(var(--py) - var(--px));
            margin-right: 0.25rem;
        }

        /* Variantes de Color (Abstracción) */
        /* Variantes de Color para Botones Matemáticos */
        .btn-emerald {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
        }

        .btn-emerald:hover {
            background-color: #059669;
            /* emerald-600 */
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(16, 185, 129, 0.3);
        }

        .btn-slate {
            background-color: var(--slate-200);
            color: var(--slate-600);
        }

        .btn-slate:hover {
            background-color: #cbd5e1;
            /* slate-300 */
            color: var(--slate-800);
        }

        .btn-emerald-soft {
            background-color: #d1fae5;
            /* emerald-100 */
            color: #065f46;
            /* emerald-800 */
        }

        .btn-emerald-soft:hover {
            background-color: #a7f3d0;
            /* emerald-200 */
        }

        /* Botón Oscuro -> Verde (Estilo "Como Antes" + Math) */
        .btn-dark-pill {
            background-color: var(--secondary);
            /* Dark default */
            color: white;
            border-radius: 9999px;
            /* Pill shape (redondeado como antes) */
            box-shadow: 0 4px 6px -1px rgba(15, 23, 42, 0.1);
        }

        .btn-dark-pill:hover {
            background-color: var(--primary);
            /* Green on hover */
            box-shadow: 0 6px 12px -2px rgba(16, 185, 129, 0.3);
            /* Green glow */
            transform: translateY(-1px);
        }

        /* RENDERIZADOR SEMÁNTICO (Clases para JS) */


        .section-container {
            margin-top: 3rem;
            /* Reduced from 5rem */
        }

        .section-title-l1 {
            font-size: 1.75rem;
            /* Mobile first: 28px */
            font-weight: 900;
            color: var(--secondary);
            margin-bottom: 0.5rem;
            line-height: 1;
            letter-spacing: -0.05em;
        }

        @media (min-width: 768px) {
            .section-title-l1 {
                font-size: 2.25rem;
                /* Desktop: 36px */
            }
        }

        .section-desc-l1 {
            font-size: var(--font-sm);
            color: #64748b;
            font-weight: 500;
            margin-left: 0;
            padding-left: var(--align-offset);
            /* 24px Exactos */
            margin-bottom: 1.5rem;
            /* Compactado de 2rem */
            max-width: 90%;
            /* Ampliado para aprovechar ventana */
            line-height: 1.6;
        }

        .group-container {
            margin-bottom: 1.5rem;
            /* Compactado de 2rem */
            margin-left: 0;
            padding-left: var(--align-offset);
            /* 24px Exactos */
        }

        .group-header {
            margin-bottom: 0.75rem;
            /* Compactado de 1rem */
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--slate-100);
            margin-right: 2rem;
        }

        .group-title {
            font-size: 1.125rem;
            /* 18px Estandarizado */
            font-weight: 500;
            /* No Bold */
            color: var(--secondary);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Subtítulos Intermedios (Contextuales) - ESTILO LIMPIO */
        .subtitulo-container {
            margin-bottom: 1.5rem;
            padding-left: var(--align-offset);
            /* 24px Exactos */
            margin-top: -0.5rem;
        }

        .subtitulo-title {
            font-size: 1.125rem;
            /* 18px Estandarizado */
            font-weight: 500;
            /* No Bold */
            color: var(--secondary);
            margin-bottom: 0.25rem;
            letter-spacing: 0.05em;
            /* Removed uppercase */
            opacity: 0.9;
        }

        .subtitulo-desc {
            font-size: var(--font-sm);
            color: #64748b;
            line-height: 1.6;
            max-width: 90%;
            /* Ampliado para aprovechar ventana */
            font-weight: 500;
        }

        .l2-container {
            margin-bottom: 2rem;
            margin-top: 2rem;
            /* Proximidad mejorada: Antes 4rem */
            scroll-margin-top: 8rem;
        }

        .l2-title {
            font-size: 1.875rem;
            font-weight: 900;
            color: var(--secondary);
            margin-bottom: 0.25rem;
            /* Pegado a su contenido */
        }

        .distributor-card {
            background: linear-gradient(135deg, #065f46 0%, #10b981 100%);
            color: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            margin-top: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 1024px) {
            .main-sidebar {
                position: fixed;
                left: 0;
                transform: translateX(-100%);
                z-index: 200;
                height: 100vh;
                top: 0;
                box-shadow: 20px 0 50px rgba(0, 0, 0, 0.1);
            }

            .main-sidebar.open {
                transform: translateX(0);
            }

            .data-grid thead {
                display: none;
            }

            .data-grid td {
                display: block;
                text-align: right;
                padding: 0.75rem 1rem;
                position: relative;
                border-bottom: 1px solid var(--slate-50);
            }

            .data-grid td::before {
                content: attr(data-label);
                position: absolute;
                left: 1rem;
                font-weight: 800;
                color: var(--slate-400);
                font-size: 0.6rem;
            }

            .data-grid td:first-child {
                text-align: left;
                padding-bottom: 1.25rem;
                background: var(--slate-50);
            }
        }

        .professional-only {
            display: none !important;
        }

        body.professional-mode .professional-only {
            display: table-cell !important;
        }

        @media (max-width: 1024px) {
            body.professional-mode .professional-only {
                display: block !important;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.7s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none !important;
        }

        /* Ajuste Dinámico para Sidebar cuando hay Banner */
        body.has-banner .main-sidebar {
            top: calc(var(--header-h) + 48px);
            /* 80px + altura aprox banner */
        }

        @media (max-width: 1024px) {
            body.has-banner .main-sidebar {
                top: 0;
                /* En móvil el sidebar es overlay completo */
            }
        }

        /* //#endregion */

        /* //#region Componentes Estandarizados */
        .search-container {
            position: relative;
            margin-bottom: var(--space-m);
        }

        .search-input {
            width: 100%;
            padding: var(--space-s) var(--space-m) var(--space-s) 2.5rem;
            background: var(--slate-100);
            border: var(--border-width-std) solid var(--border-color-soft);
            border-radius: var(--radius-sm);
            font-size: var(--font-sm);
            font-weight: 500;
            outline: none;
            transition: all 0.2s;
            color: var(--secondary);
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            background: white;
        }

        /* SEARCH DROPDOWN (Predictivo) */
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color-soft);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }

        .search-dropdown:not(.hidden) {
            display: block;
        }

        .search-result-item {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--slate-50);
            transition: background-color 0.2s;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background-color: var(--slate-50);
        }

        .search-highlight {
            color: var(--primary);
            font-weight: bold;
        }

        /* COMPONENTES ATÓMICOS */
        .user-greeting {
            margin-left: var(--space-xl);
            display: flex;
            align-items: center;
            gap: var(--space-s);
            padding: var(--space-xs) var(--space-m);
            background: var(--slate-50);
            border-radius: var(--radius-full);
            border: var(--border-width-std) solid var(--slate-100);
        }

        .user-greeting span {
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--secondary);
            letter-spacing: -0.01em;
        }

        .logout-btn {
            color: var(--slate-400);
            transition: color 0.2s;
        }

        .logout-btn:hover {
            color: var(--secondary);
        }

        .category-divider {
            height: 1px;
            background: var(--border-color-soft);
            margin-bottom: var(--space-s);
            margin-left: calc(-1 * var(--p-sidebar));
            width: var(--sidebar-w);
        }

        .contact-card {
            background: white;
            padding: 1.5rem;
            /* Equivalent to p-6 */
            border-radius: var(--radius-md);
            border: 1px solid var(--slate-100);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            height: 100%;
            /* Ensure uniform height in grid */
            position: relative;
            overflow: hidden;
        }

        .contact-card:hover {
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.12);
            /* Modern soft shadow */
            transform: translateY(-4px);
            border-color: var(--emerald-200);
        }

        /* Decorative top accent on hover */
        .contact-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
            transform-origin: left;
        }

        .contact-card:hover::before {
            transform: scaleX(1);
        }

        .contact-card-icon {
            width: 2.75rem;
            height: 2.75rem;
            background: var(--slate-50);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate-400);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .contact-card:hover .contact-card-icon {
            background: var(--emerald-50);
            color: var(--primary);
        }

        /* //#endregion */
        /* YOUTUBE FACADE (Mejora de rendimiento) */
        .youtube-facade {
            position: relative;
            cursor: pointer;
            overflow: hidden;
            background-color: #000;
            border-radius: inherit;
            /* Heredar borde del contenedor */
        }

        .youtube-facade img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s;
        }

        .youtube-facade:hover img {
            opacity: 0.8;
        }

        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 68px;
            height: 48px;
            background-color: rgba(33, 33, 33, 0.8);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .play-button::before {
            content: "";
            border-style: solid;
            border-width: 10px 0 10px 18px;
            border-color: transparent transparent transparent white;
        }

        .youtube-facade:hover .play-button {
            background-color: #f00;
            /* YouTube Red */
        }

        /* RENDERIZADOR DE LISTAS DINÁMICAS (PILLS) */
        .special-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .list-pill {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: default;
        }

        .list-pill::before {
            content: '';
            width: 6px;
            height: 6px;
            background-color: var(--primary);
            border-radius: 50%;
            flex-shrink: 0;
        }

        .list-pill:hover {
            background: white;
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }

        /* ESTILOS DE NOTAS INTELIGENTES (Smart Grid Notes) */
        .note-text {
            font-size: var(--font-sm);
            color: #4b5563;
            /* slate-600 */
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .note-grid-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px 24px;
            /* Gap vertical 8px, Horizontal 24px */
            list-style: none;
            padding: 0;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .note-grid-list li {
            position: relative;
            padding-left: 14px;
            font-size: var(--font-xs);
            /* 11px aprox según tokens, o hardcodeamos 12px si muy chico */
            font-size: 12px;
            color: #334155;
            /* slate-700 */
            font-weight: 500;
            display: flex;
            align-items: flex-start;
        }

        .note-grid-list li::before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--primary);
            /* Verde */
            font-weight: bold;
            font-size: 1.2em;
            line-height: 1;
            top: 0px;
        }
    </style>
</head>

<body>
    <!-- //#region 3. ESTRUCTURA DE INTERFAZ (HTML) -->

    <div class="app-layout">
        <!-- HEADER GLOBAL FIXED -->
        <header class="main-header">
            <div class="header-content px-10 w-full flex justify-between items-center h-full">
                <!-- IZQUIERDA: Identidad + Toggle -->
                <div class="flex items-center gap-4">
                    <!-- Logo Principal (Traído del Sidebar) -->
                    <a href="#" onclick="Navigation.goTo('catalog')"
                        class="flex items-center gap-3 transition-opacity hover:opacity-80">
                        <img src="img/logo-mundo-homeopatico.webp" alt="Logo" class="h-10 w-auto"
                            onerror="this.src='https://placehold.co/120x40?text=MH LOGO'">
                        <h1 class="font-black text-xl tracking-tight text-secondary leading-none">Mundo<br>Homeopático
                        </h1>
                    </a>

                    <!-- Toggle Móvil -->
                    <button onclick="UIHandlers.toggleSidebar()" class="btn-mobile-toggle md:hidden ml-4">
                        <i data-lucide="menu"></i>
                    </button>
                </div>

                <!-- DERECHA: Navegación Superior -->
                <div class="flex items-center gap-6">
                    <!-- Saludo User -->
                    <div id="userGreeting"
                        class="hidden flex items-center gap-2 text-sm font-medium text-slate-600 animate-fade-in">
                        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                        <span id="greetingText"></span>
                    </div>

                    <!-- Botón Navegación (Math Optimized + Dark Pill) -->
                    <button id="navToggleButton" onclick="Navigation.toggle()"
                        class="btn-math btn-dark-pill icon-right">
                        <span id="navButtonText">Contacto</span>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- Barra de Progreso Global (Adherida al header) -->
            <div id="topProgressBar" class="top-progress-bar"></div>
        </header>

        <!-- SIDEBAR FIXED -->
        <aside id="mainSidebar" class="main-sidebar pb-10">


            <!-- VISTA: CATÁLOGO -->
            <div id="sidebar-catalog-view" class="flex flex-col h-full animate-fade-in">
                <!-- Zona Superior: Buscador y Accesos -->
                <div class="flex-shrink-0">
                    <div class="search-container relative">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="mainSearch" placeholder="Buscar..."
                            class="search-input w-full pl-10 pr-4 py-3 bg-white border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all shadow-sm hover:border-slate-400"
                            autocomplete="off">
                        <!-- Dropdown de Resultados Predictivos -->
                        <div id="searchDropdown" class="search-dropdown hidden animate-fade-in"></div>
                    </div>
                </div>

                <button onclick="UIHandlers.showPasswordModal()"
                    class="btn-math btn-slate icon-left w-full justify-start mt-4 mb-4">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span>Distribuidores</span>
                </button>

                <div class="category-divider flex-shrink-0"></div>

                <!-- Zona de Navegación (Scrollable) -->
                <nav id="sidebar-menu" class="space-y-1 flex-grow"></nav>
            </div>

            <!-- VISTA: CONTACTO (CONTEXTUAL) -->
            <div id="sidebar-contact-view" class="hidden flex-col h-full animate-fade-in">
                <!-- CTA Card: Diseñada para ocupar el mismo espacio vertical que (Buscador + Botón Login) -->
                <div class="flex-shrink-0 mb-6">
                    <div class="distributor-promo-card p-5 bg-emerald-50/50 border border-emerald-100/60 rounded-xl">
                        <h3 class="font-bold text-lg text-emerald-900 mb-1">Sé distribuidor</h3>
                        <p class="text-xs text-emerald-700/80 mb-4 leading-relaxed">Únete a nuestra red de aliados
                            certificados.</p>

                        <!-- SLOT 2: Botón WhatsApp (Alineado) -->
                        <a id="btn-whatsapp-sidebar" href="https://wa.me/573176680750" target="_blank"
                            class="btn-math btn-emerald w-full justify-center shadow-sm">
                            <i data-lucide="message-circle" class="w-4 h-4"></i>
                            <span>WhatsApp</span>
                        </a>
                    </div>
                </div>

                <div class="category-divider"></div>

                <!-- Menú de Navegación de Contacto -->
                <nav class="space-y-1 flex-grow overflow-y-auto">
                    <div class="sidebar-label-l1 mt-4">Nuestras sedes</div>
                    <a href="#headquarters" class="sidebar-link group"
                        onclick="document.querySelector('.bg-gradient-to-br')?.scrollIntoView({behavior:'smooth'})">
                        <i data-lucide="map-pin"
                            class="w-4 h-4 text-slate-400 group-hover:text-primary transition-colors"></i>
                        <span>Sedes principales</span>
                    </a>
                    <a href="#distributors" class="sidebar-link group"
                        onclick="document.getElementById('distributors-grid')?.scrollIntoView({behavior:'smooth'})">
                        <i data-lucide="store"
                            class="w-4 h-4 text-slate-400 group-hover:text-primary transition-colors"></i>
                        <span>Distribuidores</span>
                    </a>
                </nav>
            </div>

            <!-- Pie de Autoría (Común a ambas vistas) -->
            <div id="author-credit"
                class="sidebar-footer mt-auto pt-6 opacity-0 transition-opacity duration-1000 flex-shrink-0">
                <p class="text-[9px] font-black text-slate-300 tracking-[0.3em] text-center leading-loose">
                    Desarrollado por<br>
                    <a id="author-link" href="#" target="_blank"
                        class="text-slate-400 hover:text-emerald-500 transition-colors font-bold border-b border-transparent hover:border-emerald-500"></a>
                </p>
            </div>
        </aside>

        <!-- WRAPPER DE CONTENIDO (Offset por Header y Sidebar) -->
        <div class="main-content-wrapper">
            <!-- Barra de Progreso Global -->
            <div id="bannerWrapper" class="banner-wrapper collapsed">
                <div
                    class="w-full px-10 py-3.5 flex items-center gap-4 text-amber-900 text-[10px] font-black tracking-widest animate-fade-in">
                    <i data-lucide="megaphone" class="w-4 h-4 flex-shrink-0 text-amber-500"></i>
                    <p id="bannerText" class="flex-grow text-center"></p>
                    <button onclick="UIHandlers.closeBanner()"
                        class="p-2 hover:bg-amber-100 rounded-full transition-colors">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- PANEL CENTRAL SPA -->
            <!-- Fix Footer: Flex Column para empujar footer -->
            <main id="view-catalog" class="flex-grow p-6 lg:p-10 min-w-0 flex flex-col">
                <div class="mb-6 animate-fade-in">
                    <h2 class="text-4xl md:text-6xl font-black tracking-tighter mb-3 text-secondary">Catálogo de
                        productos</h2>
                    <p class="text-slate-400 font-medium text-sm">Catálogo 2026</p>
                </div>
                <!-- Contenedor crece para ocupar espacio -->
                <div id="tables-container" class="space-y-32 flex-grow">
                    <div class="h-64 bg-white rounded-[3rem] animate-pulse border border-slate-100 mb-10"></div>
                </div>
            </main>

            <main id="view-contact" class="hidden flex-grow p-6 lg:p-10 min-w-0 flex flex-col">
                <div class="mb-6 animate-fade-in">
                    <h2 class="text-4xl md:text-6xl font-black tracking-tighter mb-3 text-secondary">Sedes y Contacto
                    </h2>
                    <p class="text-slate-400 font-medium text-sm">Red nacional de distribución</p>
                </div>

                <div class="flex-grow">
                    <section id="videoSection" class="mb-16 scroll-mt-24">
                        <div class="mb-6">
                            <h3 class="text-2xl md:text-3xl font-black text-secondary tracking-tight mb-2">Excelencia en
                                la
                                elaboración
                                homeopática</h3>
                            <p class="section-desc-l1">Procesos secuenciales
                                limpios y fórmulas innovadoras bajo estándares farmacéuticos internacionales.</p>
                        </div>
                        <div id="videoContainer"
                            class="aspect-video w-full rounded-[2rem] bg-slate-200 overflow-hidden shadow-2xl border-4 border-white animate-fade-in">
                            <!-- Aquí se inyectará el iframe si es necesario, o placeholder -->
                            <div class="w-full h-full flex items-center justify-center text-slate-400 bg-slate-100">
                                <i data-lucide="play" class="w-12 h-12 opacity-50"></i>
                            </div>
                        </div>
                    </section>

                    <section id="distributorsSection" class="scroll-mt-24 mb-16">
                        <h3 class="text-2xl font-black text-secondary mb-8 tracking-tight flex items-center gap-3">
                            <i data-lucide="map-pin" class="text-primary"></i> Sedes principales
                        </h3>
                        <div id="distributors-grid" class="grid md:grid-cols-2 gap-6">
                            <!-- Dinámico: RenderEngine llenará esto -->
                        </div>
                    </section>

                    <section id="faqSection" class="mt-16 mb-16">
                        <h3 class="text-2xl font-black text-secondary mb-8 tracking-tight">Preguntas frecuentes</h3>
                        <div id="faq-container" class="grid gap-4 w-full">
                            <!-- Dinámico: RenderEngine llenará esto -->
                        </div>
                    </section>
                </div>
            </main>

            <!-- FOOTER GLOBAL UNIFICADO (Fuera del padding del main) -->
            <footer class="mt-auto border-t border-slate-200 bg-white py-6 px-10">
                <div class="w-full flex flex-col md:flex-row justify-between items-center gap-8">
                    <!-- Bloque Izquierdo: Copyright -->
                    <div class="flex items-center gap-4 text-slate-400">
                        <img src="img/logo-mundo-homeopatico.webp" alt="Logo"
                            class="h-8 opacity-40 grayscale hover:grayscale-0 transition-all cursor-pointer">
                        <div class="text-left">
                            <p class="text-[11px] font-bold tracking-tight">Mundo Homeopático © 2026</p>
                            <p class="text-[10px] text-slate-400 hidden md:block">Precios sujetos a cambios.</p>
                        </div>
                    </div>

                    <!-- Bloque Derecho: Redes -->
                    <div class="flex justify-center gap-6">
                        <a href="https://wa.me/573176680750" target="_blank" title="WhatsApp"
                            class="text-slate-400 hover:text-emerald-500 transition-colors transform hover:scale-110">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                        </a>
                        <a href="https://www.instagram.com/mundohomeopatico" target="_blank" title="Instagram"
                            class="text-slate-400 hover:text-pink-500 transition-colors transform hover:scale-110">
                            <i data-lucide="instagram" class="w-5 h-5"></i>
                        </a>
                        <a href="https://www.mhmundohomeopatico.com" target="_blank" title="Sitio Web"
                            class="text-slate-400 hover:text-secondary transition-colors transform hover:scale-110">
                            <i data-lucide="globe" class="w-5 h-5"></i>
                        </a>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    <!-- //#endregion -->

    <!-- //#region 4. LÓGICA DE NEGOCIO (JS) -->
    <!-- MODAL DE ACCESO PROFESIONAL (Distribuidores) -->
    <div id="passwordModal"
        class="hidden fixed inset-0 z-[2000] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-[2rem] p-10 max-w-md w-full shadow-2xl border border-slate-100 mx-4">
            <div class="text-center mb-8">
                <div
                    class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="lock" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-black text-secondary tracking-tight">Acceso restringido</h3>
                <p class="text-slate-400 text-sm font-medium mt-2">Ingrese su contraseña de distribuidor para ver
                    precios de farmacia.</p>
            </div>

            <div class="space-y-4">
                <div class="relative">
                    <i data-lucide="key-round" class="absolute left-4 top-4 w-5 h-5 text-slate-300"></i>
                    <input type="password" id="professionalPassword" placeholder="Contraseña..."
                        class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-emerald-500/10 focus:border-emerald-500 transition-all font-medium"
                        onkeyup="if(event.key==='Enter') UIHandlers.validateLogin()">
                </div>

                <div class="flex gap-3 pt-4">
                    <button onclick="UIHandlers.closeModal()"
                        class="flex-1 py-4 px-6 bg-slate-100 text-slate-600 font-bold rounded-2xl hover:bg-slate-200 transition-all">
                        Cancelar
                    </button>
                    <button onclick="UIHandlers.validateLogin()"
                        class="flex-[2] py-4 px-6 bg-emerald-500 text-white font-bold rounded-2xl shadow-lg shadow-emerald-500/20 hover:bg-emerald-600 hover:-translate-y-0.5 transition-all">
                        Acceder
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay Móvil -->
    <div id="mobileOverlay" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[150] md:hidden"
        onclick="UIHandlers.toggleSidebar()"></div>

    <script>

        const APP_CONFIG = {
            SHEETS: {
                PRICES: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=1411473006&single=true&output=csv',
                NAV: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=1582460222&single=true&output=csv',
                AUTH: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=1372762576&single=true&output=csv',
                AUTHOR: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=2047819342&single=true&output=csv',
                VIDEO: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=1360742312&single=true&output=csv',
                BANNER: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=593525669&single=true&output=csv',
                FAQ: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=1434563192&single=true&output=csv',
                DIST: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRuBTyqnC5oSy0leK7NCf-Bnde5BFfv4URIZckAI78TenSLVx-09IKjTEvO67SPK8DAsc8fdwVABGQC/pub?gid=486540156&single=true&output=csv'
            },
            PROXY: 'https://corsproxy.io/?',
            PROXY_BACKUP: 'https://corsproxy.io/?',
            ICONS: {
                CATEGORY: {
                    "lineamh": "microscope",
                    "homeopatia": "leaf",
                    "oligoelementos": "atom",
                    "exclusivos": "star",
                    "farmacia": "flask-conical"
                },
                ITEM: {
                    "esenciasflorales": "flower-2",
                    "oligoelementos": "atom",
                    "oligoelementosk7": "atom",
                    "alimentosfuncionales": "apple",
                    "cbd": "droplets",
                    "aceitesesenciales": "sparkles",
                    "oficinales": "flask-conical",
                    "multipotenias": "layers",
                    "magistrales": "scroll"
                }
            }
        };

        const STATE = { prices: [], nav: [], faq: [], dist: [], currentView: 'catalog', isPro: localStorage.getItem('mh_pro_v2') === 'true', userName: localStorage.getItem('mh_user_v2') || '' };

        const escapeHtml = (unsafe) => {
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        const Formatters = {
            formatPhone(phone) {
                if (!phone) return '';
                const cleaned = String(phone).replace(/\D/g, '');
                if (cleaned.length === 10) {
                    return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)} ${cleaned.slice(6)}`;
                }
                return String(phone);
            },
            whatsapp(phone) {
                if (!phone) return '';
                const cleaned = String(phone).replace(/\D/g, '');
                if (cleaned.startsWith('57')) return cleaned;
                if (cleaned.length === 10) return '57' + cleaned;
                return cleaned;
            }
        };

        const UIHandlers = {
            isInteracting: false,
            isManualScroll: false,
            interactionTimeout: null,

            init() {
                if (STATE.isPro) document.body.classList.add('professional-mode');
                this.updateGreeting();

                // Configurar Buscador con Debounce
                const inp = document.getElementById('mainSearch');
                if (inp) {
                    let searchTimeout;
                    inp.addEventListener('input', (e) => {
                        const q = e.target.value.toLowerCase().trim();
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(() => this.search(q), 150);
                    });

                    // Cerrar dropdown al hacer click fuera
                    document.addEventListener('click', (e) => {
                        if (!inp.parentElement.contains(e.target)) {
                            this.toggleDropdown(false);
                        }
                    });

                    // Reactivar dropdown al hacer focus si hay texto
                    inp.addEventListener('focus', () => {
                        if (inp.value.trim().length > 0) this.search(inp.value.toLowerCase().trim());
                    });
                }
            },

            // BÚSQUEDA PRO ENFOCADA (Títulos y Productos SOLAMENTE)
            search(q) {
                if (q.length === 0) {
                    // Restaurar todo
                    document.querySelectorAll('.catalog-card').forEach(c => c.classList.remove('hidden'));
                    document.querySelectorAll('tr').forEach(tr => tr.style.display = '');
                    this.toggleDropdown(false);
                    document.getElementById('noResultsMessage')?.remove();
                    return;
                }

                const matches = [];
                let hasResults = false;

                // 1. Mapa de Coincidencias por Sección (Para mostrar/ocultar contenedores padre)
                const visibleSections = new Set();

                // 2. Búsqueda eficiente en los DATOS (STATE.prices)
                // Esto es mucho más rápido y preciso que buscar en el DOM
                STATE.prices.forEach(p => {
                    if (!p) return;

                    // Criterios de Búsqueda Estrictos (Solo Títulos y Producto)
                    const textCriterias = [
                        p.producto,
                        p.nivel_1,
                        p.nivel_2,
                        p.nivel_3 // Títulos de categorías
                    ];

                    const isMatch = textCriterias.some(t => t && t.toLowerCase().includes(q));

                    if (isMatch) {
                        // Guardar para el Dropdown
                        // Priorizamos mostrar el Producto si coincide, si no, la Categoría que coincidió
                        let matchName = p.producto;
                        let matchType = 'Producto';

                        if (!p.producto.toLowerCase().includes(q)) {
                            // Si no coincidió el producto, fue una categoría
                            matchName = [p.nivel_3, p.nivel_2, p.nivel_1].find(t => t && t.toLowerCase().includes(q)) || matchName;
                            matchType = 'Categoría';
                        }

                        // Añadir a resultados del dropdown (si no es duplicado conceptual)
                        matches.push({
                            id: p.id, // ID único del producto/fila
                            name: matchName,
                            section: p.nivel_3 || p.nivel_2 || 'Catálogo',
                            type: matchType
                        });

                        // Marcar ID para visualización
                        visibleSections.add(p.id);
                    }
                });

                // 3. Actualizar DOM basado en resultados
                // Primero ocultamos todo
                document.querySelectorAll('.catalog-card').forEach(card => card.classList.add('hidden'));

                // Luego mostramos lo relevante
                if (visibleSections.size > 0) {
                    hasResults = true;

                    // Recorrer todas las tablas y filas para filtrar
                    document.querySelectorAll('.catalog-card').forEach(card => {
                        let cardHasVisibleRows = false;

                        card.querySelectorAll('tbody tr').forEach(tr => {
                            // Hack: Obtenemos el ID del producto inyectado en un atributo data (si existiera) o inferimos
                            // Como no tenemos ID en el TR en este renderizado simple, buscamos por texto EXACTO del producto
                            const prodNameEl = tr.querySelector('.product-name div:first-child');
                            if (!prodNameEl) return;

                            const prodName = prodNameEl.textContent.trim();
                            // Buscar si este producto está en nuestra lista de matches (por nombre, ya que por ID es difícil sincronizar con el DOM actual)
                            const isRowMatch = matches.some(m => m.name === prodName && m.type === 'Producto');

                            // O si la categoría de la tarjeta coincidió (matches de tipo Categoría) -> mostrar todo el bloque
                            const sectionTitle = card.querySelector('h5')?.textContent || '';
                            const isSectionMatch = matches.some(m => m.type === 'Categoría' && sectionTitle.includes(m.name));

                            if (isRowMatch || isSectionMatch) {
                                tr.style.display = '';
                                cardHasVisibleRows = true;
                            } else {
                                tr.style.display = 'none';
                            }
                        });

                        if (cardHasVisibleRows) {
                            card.classList.remove('hidden');
                        }
                    });
                }

                // 4. Mensaje "Sin Resultados"
                const noResultsMsg = document.getElementById('noResultsMessage');
                if (!hasResults) {
                    if (!noResultsMsg) {
                        const msg = document.createElement('div');
                        msg.id = 'noResultsMessage';
                        msg.className = 'text-center p-8 text-slate-400 font-medium animate-fade-in';
                        msg.innerHTML = `<i data-lucide="search-x" class="w-12 h-12 mx-auto mb-2 opacity-50"></i><p>No encontramos coincidencias para "${escapeHtml(q)}"</p>`;
                        document.getElementById('tables-container').appendChild(msg);
                        if (window.lucide) window.lucide.createIcons();
                    }
                } else {
                    noResultsMsg?.remove();
                }

                // 5. Actualizar Dropdown (Deduplicado)
                // Filtramos duplicados para que el dropdown no muestre 50 veces "Arnica" si hay 50 presentaciones
                const seen = new Set();
                const uniqueMatches = [];
                matches.forEach(m => {
                    const key = m.name + m.section;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueMatches.push(m);
                    }
                });

                this.updateSearchDropdown(uniqueMatches, q);
            },

            // FUNCIONES DEL DROPDOWN PREDICTIVO
            toggleDropdown(show) {
                const d = document.getElementById('searchDropdown');
                if (d) show ? d.classList.remove('hidden') : d.classList.add('hidden');
            },

            updateSearchDropdown(items, query) {
                const dropdown = document.getElementById('searchDropdown');
                if (!dropdown) return;

                const limit = 6;
                const shown = items.slice(0, limit);

                if (shown.length === 0) {
                    this.toggleDropdown(false);
                    return;
                }

                let html = shown.map(item => {
                    const regex = new RegExp(`(${query})`, 'gi');
                    const highlightedName = item.name.replace(regex, '<span class="search-highlight">$1</span>');

                    return `<div class="search-result-item" onclick="UIHandlers.scrollToElement(this)">
                        <div class="text-[11px] font-bold text-slate-700 leading-tight pointer-events-none">${highlightedName}</div>
                        <div class="hidden item-name">${item.name}</div>
                    </div>`;
                }).join('');

                if (items.length > limit) {
                    html += `<div class="p-2 text-[10px] text-center text-emerald-600 font-bold bg-emerald-50 cursor-default">
                        +${items.length - limit} resultados más...
                    </div>`;
                }

                dropdown.innerHTML = html;
                this.toggleDropdown(true);
            },

            scrollToElement(sender) {
                const targetName = sender.querySelector('.item-name')?.textContent;
                if (!targetName) return;

                // Buscar el elemento en el DOM visible
                // Preferimos una fila de tabla (tbody tr) que contenga el nombre exacto
                const rows = Array.from(document.querySelectorAll('tbody tr'));
                const targetEl = rows.find(r => {
                    const nameDiv = r.querySelector('.product-name div:first-child');
                    return nameDiv && nameDiv.textContent === targetName;
                });

                if (targetEl) {
                    this.toggleDropdown(false);
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight visual
                    targetEl.classList.add('bg-emerald-100');
                    setTimeout(() => targetEl.classList.remove('bg-emerald-100'), 2000);

                    if (window.innerWidth < 1024) this.toggleSidebar();
                } else {
                    // Fallback: Si es una categoría, buscar el título
                    const headers = Array.from(document.querySelectorAll('h5'));
                    const targetHeader = headers.find(h => h.textContent.includes(targetName));
                    if (targetHeader) {
                        this.toggleDropdown(false);
                        targetHeader.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        if (window.innerWidth < 1024) this.toggleSidebar();
                    }
                }
            },

            updateGreeting() {
                const hour = new Date().getHours();
                const greet = hour < 12 ? "Buenos días" : hour < 18 ? "Buenas tardes" : "Buenas noches";
                const gt = document.getElementById('greetingText');
                if (gt) gt.textContent = `${greet}${STATE.userName ? ', ' + STATE.userName : ''}`;
                document.getElementById('userGreeting')?.classList.toggle('hidden', !STATE.isPro);
            },
            toggleSidebar: () => {
                document.getElementById('mainSidebar').classList.toggle('open');
                document.getElementById('mobileOverlay').classList.toggle('hidden');
            },

            // LÓGICA DE ACORDEÓN PURA Y SIMPLE
            toggleAccordion: (btn) => {
                // Búsqueda ROBUSTA del contenido del acordeón
                const content = btn.parentElement.querySelector('.sidebar-accordion-content');
                const isOpen = content.classList.contains('is-open');

                // Pausar Observer para evitar conflicto de scroll
                UIHandlers.isInteracting = true;

                // 1. Cerrar todos los acordeones (Comportamiento Exclusivo)
                document.querySelectorAll('.sidebar-accordion-content').forEach(nav => {
                    nav.classList.remove('is-open');
                });
                document.querySelectorAll('.sidebar-item-accordion').forEach(b => {
                    b.querySelector('.lucide-chevron-down')?.classList.remove('rotate-180');
                    b.classList.remove('bg-slate-100', 'text-secondary');
                });

                // 2. Si estaba cerrado, abrir SOLO este
                if (!isOpen) {
                    content.classList.add('is-open');
                    btn.querySelector('.lucide-chevron-down')?.classList.add('rotate-180');
                    btn.classList.add('bg-slate-100', 'text-secondary');

                    // Scroll suave eliminado para evitar "pestañeo" visual
                    // La interacción es más natural si el menú no salta bajo el puntero
                }

                // 3. Refrescar iconos
                if (window.lucide) window.lucide.createIcons();

                // 4. Reactivar Observer tras la transición
                clearTimeout(UIHandlers.interactionTimeout);
                UIHandlers.interactionTimeout = setTimeout(() => {
                    UIHandlers.isInteracting = false;
                }, 1000);
            },

            closeBanner: () => {
                const wrapper = document.getElementById('bannerWrapper');
                if (wrapper) wrapper.classList.add('collapsed');
                localStorage.setItem('mh_banner_closed', 'true');
                document.body.classList.remove('has-banner');
            },
            showPasswordModal: () => document.getElementById('passwordModal').classList.remove('hidden'),
            closeModal: () => document.getElementById('passwordModal').classList.add('hidden'),
            validateLogin: async () => {
                const passInput = document.getElementById('professionalPassword');
                const pass = passInput.value.trim();

                // Feedback de carga
                const btn = passInput.parentElement.querySelector('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="animate-pulse">Verificando...</span>';

                try {
                    // ESTRATEGIA HÍBRIDA: Memoria (Rápida) -> Red (Fallback)
                    let auth = STATE.auth;

                    // Si por alguna razón no cargó al inicio, intentamos cargarla ahora
                    if (!auth || auth.length === 0) {
                        try {
                            auth = await DataService.fetchCSV(APP_CONFIG.SHEETS.AUTH);
                            STATE.auth = auth; // Guardar para futuro
                        } catch (err) { console.warn("Fallo carga auth on-demand", err); }
                    }

                    // ESCENARIO 1: Modo Offline / Bloqueo Local / Base Vacía
                    if (!auth || auth.length === 0) {
                        console.warn("⚠️ Base de datos de usuarios no disponible. Usando mecanismo offline.");

                        if (pass === 'MH2026') {
                            localStorage.setItem('mh_pro_v2', 'true');
                            localStorage.setItem('mh_user_v2', 'Administrador Offline');
                            location.reload();
                        } else {
                            alert("MODO OFFLINE: Conexión limitada. Por favor use la clave maestra o recargue la página cuando tenga mejor señal.");
                            btn.innerHTML = originalText;
                        }
                        return;
                    }

                    // ESCENARIO 2: Validación en Memoria (Instantánea)
                    // Búsqueda insensible a mayúsculas/minúsculas
                    const user = auth.find(r => {
                        const p = (r.password || r.clave || r.contrasena || r.contraseña || "").toString().trim();
                        return p.toLowerCase() === pass.toLowerCase();
                    });

                    if (user || pass === 'MH2026') {
                        localStorage.setItem('mh_pro_v2', 'true');
                        localStorage.setItem('mh_user_v2', user?.nombre || user?.usuario || 'Administrador');
                        location.reload();
                    } else {
                        // Pequeño delay artificial para deterred fuerza bruta y dar peso a la UI
                        setTimeout(() => {
                            alert("La contraseña ingresada no es válida.");
                            btn.innerHTML = originalText;
                            passInput.value = "";
                            passInput.focus();
                        }, 500);
                    }

                } catch (e) {
                    console.error("Error Auth Crítico:", e);
                    alert("Error verificando credenciales. Intente nuevamente.");
                    btn.innerHTML = originalText;
                }
            },
            logout: () => { localStorage.clear(); location.reload(); },

            // NAVEGACIÓN MANUAL (SIMPLE)
            initNavigation() {
                // Delegación de eventos estándar
                document.addEventListener('click', (e) => {
                    const link = e.target.closest('.sidebar-link[data-tid]');
                    if (link) {
                        e.preventDefault();
                        const tid = link.getAttribute('data-tid');

                        // Scroll directo sin complicaciones
                        const targetId = `sec-${tid}`;
                        // Búsqueda EXACTA por ID. Eliminamos fallback 'fuzzy' para evitar conflictos de nombres parecidos.
                        let target = document.getElementById(targetId);

                        if (target) {
                            // Ajuste Dinámico para el header fijo
                            const headerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-h')) || 80;
                            const elementPosition = target.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerH - 20; // 20px extra de aire

                            window.scrollTo({
                                top: offsetPosition,
                                behavior: "smooth"
                            });

                            // FEEDBACK VISUAL: Resaltar la sección destino
                            // Esto confirma al usuario que "Especiales" o "Cuidado Capilar" ha sido localizado
                            target.classList.add('bg-emerald-50/50', 'transition-colors', 'duration-500');
                            setTimeout(() => {
                                target.classList.remove('bg-emerald-50/50');
                            }, 1500);
                        }

                        // UX Básico: Marcar activo inmediatamente
                        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');

                        // En móvil cerrar sidebar
                        if (window.innerWidth < 1024) UIHandlers.toggleSidebar();
                    }
                });
            },

            // FAQ ACORDEÓN EXCLUSIVO (Lógica migrada de proyecto modular)
            toggleFaq(button) {
                const content = button.nextElementSibling;
                const icon = button.querySelector('[data-lucide="chevron-down"]');
                const isHidden = content.classList.contains('hidden');

                // 1. Cerrar TODOS los items primero
                document.querySelectorAll('.faq-answer-container').forEach(c => c.classList.add('hidden'));
                document.querySelectorAll('.faq-trigger [data-lucide="chevron-down"]').forEach(i => i.style.transform = 'rotate(0deg)');
                document.querySelectorAll('.faq-trigger').forEach(b => b.setAttribute('aria-expanded', 'false'));

                // 2. Abrir SOLO el seleccionado si estaba cerrado
                if (isHidden) {
                    content.classList.remove('hidden');
                    if (icon) icon.style.transform = 'rotate(180deg)';
                    button.setAttribute('aria-expanded', 'true');
                }
            },

            // CONTROL DE BARRA DE CARGA
            showLoading(active) {
                const bar = document.getElementById('topProgressBar');
                if (!bar) return;

                if (active) {
                    bar.classList.remove('complete');
                    // Forzar reflow para reiniciar la animación si se llama seguido
                    void bar.offsetWidth;
                    bar.classList.add('loading');
                } else {
                    bar.classList.remove('loading');
                    bar.classList.add('complete');

                    // Resetear después de la animación de desaparición
                    setTimeout(() => {
                        bar.classList.remove('complete');
                        bar.style.width = '0';
                    }, 500);
                }
            },

            // CARGA DIFERIDA DE VIDEO (Click-to-Load)
            loadVideo(btn, videoId) {
                const container = btn.closest('.youtube-facade');
                if (!container) return;

                // Reemplazar fachada con iframe real
                container.innerHTML = `<iframe class="w-full h-full" 
                    src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" 
                    frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen></iframe>`;
            },

        };

        const Navigation = {
            toggle() {
                // Lógica de Toggle simplificada
                if (STATE.currentView === 'catalog') this.goTo('contact');
                else this.goTo('catalog');
            },
            goTo(viewId) {
                // Actualizar Estado
                STATE.currentView = viewId;

                // Referencias DOM
                const views = {
                    catalog: document.getElementById('view-catalog'),
                    contact: document.getElementById('view-contact')
                };
                const sidebars = {
                    catalog: document.getElementById('sidebar-catalog-view'),
                    contact: document.getElementById('sidebar-contact-view')
                };
                const btn = document.getElementById('navToggleButton');

                // Hard-Switch de Vistas
                // Cambiar visibilidad de vistas y sidebars
                if (viewId === 'contact') {
                    views.catalog.classList.add('hidden');
                    views.contact.classList.remove('hidden');
                    sidebars.catalog.classList.add('hidden');
                    sidebars.contact.classList.remove('hidden');
                } else {
                    views.contact.classList.add('hidden');
                    views.catalog.classList.remove('hidden');
                    sidebars.contact.classList.add('hidden');
                    sidebars.catalog.classList.remove('hidden');
                }

                // Actualizar Botón (Solo texto para evitar saltos)
                const navButtonText = document.getElementById('navButtonText');
                if (navButtonText) {
                    navButtonText.textContent = (viewId === 'contact') ? 'Catálogo' : 'Contacto';
                }

                // Actualizar ícono si fuera necesario (aquí es el mismo, pero lo mantenemos robusto)
                if (window.lucide) window.lucide.createIcons();

                // Refrescar iconos tras inyectar nuevo HTML
                if (window.lucide) window.lucide.createIcons();

                document.getElementById('mainSidebar').classList.remove('open');
                document.getElementById('mobileOverlay').classList.add('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        const DataService = {
            // Lista de Proxies para Failover (Rotación)
            proxies: [
                url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                url => `https://thingproxy.freeboard.io/fetch/${url}`
            ],

            async fetchCSV(url) {
                // Estrategia: Sequential Failover con Timeout
                for (let i = 0; i < this.proxies.length; i++) {
                    const proxyFn = this.proxies[i];
                    const fetchUrl = proxyFn(url);

                    try {
                        console.log(`📡 Conectando vía Proxy ${i + 1}...`);
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 12000); // 12s Timeout generoso

                        const response = await fetch(fetchUrl, { signal: controller.signal });
                        clearTimeout(timeoutId);

                        if (!response.ok) throw new Error(`HTTP ${response.status}`);

                        const text = await response.text();

                        // Validación básica (evitar páginas de error de proxy disfrazadas de 200 OK)
                        if (!text || text.length < 50 || text.includes('<!DOCTYPE html>')) {
                            throw new Error('Respuesta inválida (posible error de proxy)');
                        }

                        return this.parseCSV(text);

                    } catch (error) {
                        console.warn(`⚠️ Falló Proxy ${i + 1}:`, error.message);
                        if (i === this.proxies.length - 1) {
                            console.error('❌ Todos los proxies fallaron. Verifica conexión.');
                            return [];
                        }
                    }
                }
                return [];
            },

            parseCSV(str) {
                const arr = [];
                let quote = false;
                let col = 0, row = 0;
                let c = 0;

                // Pre-allocating rows
                arr[row] = [];
                arr[row][col] = "";

                for (c = 0; c < str.length; c++) {
                    let cc = str[c], nc = str[c + 1];
                    arr[row] = arr[row] || [];
                    arr[row][col] = arr[row][col] || "";

                    if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
                    if (cc == '"') { quote = !quote; continue; }
                    if (cc == ',' && !quote) { ++col; continue; }
                    if (cc == '\r' && !quote && nc == '\n') { ++row; col = 0; ++c; continue; }
                    if (cc == '\n' && !quote) { ++row; col = 0; continue; }
                    if (cc == '\r' && !quote) { ++row; col = 0; continue; }
                    arr[row][col] += cc;
                }

                // Normalización de cabeceras
                const headers = arr[0].map(h => {
                    let clean = h.trim().toLowerCase().replace(/\s+/g, '_').replace(/^"|"$/g, '');
                    if (clean === 'tablas_id') return 'tabla_id'; // Compatibilidad
                    return clean;
                });

                return arr.slice(1).filter(r => r.length > 1).map(row => {
                    const obj = {};
                    headers.forEach((h, i) => {
                        let val = row[i] || "";
                        // Limpieza extra de comillas envolventes si parser falló un poco
                        if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                        obj[h] = val.trim();
                    });
                    return obj;
                });
            },

            normalizeYT(url) {
                if (!url) return '';
                const id = url.match(/(?:v=|\/embed\/|youtu\.be\/|\/v\/|\/e\/|watch\?v%3D)([^#\&\?]*).*/);
                return id ? `https://www.youtube.com/embed/${id[1]}` : url;
            },

            slugify(text) {
                if (!text) return "unknown";
                return text.toString()
                    .replace(/\u00FC|\u00DC/g, 'u') // Manual 'ü' replacement for safety
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '')
                    .trim();
            }
        };

        const RenderEngine = {
            renderAll() {
                this.renderCatalog();
                this.renderContactItems();
                this.renderFAQ();
                if (window.lucide) window.lucide.createIcons();
            },
            renderCatalog() {
                try {
                    const sidebar = document.getElementById('sidebar-menu');
                    const panel = document.getElementById('tables-container');
                    if (!sidebar || !panel) return;

                    // 1. CAPTURA DE ESTADO PREVIO (Persistencia Acordeones)
                    const openGroups = new Set();
                    document.querySelectorAll('.sidebar-item-accordion').forEach(btn => {
                        if (btn.querySelector('.rotate-180') || btn.getAttribute('aria-expanded') === 'true') {
                            const label = btn.querySelector('span')?.textContent.trim();
                            if (label) openGroups.add(label);
                        }
                    });

                    // 2. FASE DE ARQUITECTO: CONSTRUIR LA JERARQUÍA
                    const tree = this.buildHierarchy(STATE.nav);

                    let sHtml = '';
                    let pHtml = '';

                    // 3. FASE DE PINTOR: RENDERIZADO RECURSIVO
                    tree.forEach(section => {
                        // Header Sección
                        sHtml += `<div class="sidebar-label-l1">${section.title}</div>`;

                        pHtml += `<div class="section-container">
                                    <h2 class="section-title-l1">${section.displayTitle}</h2>
                                    <p class="section-desc-l1">${section.desc}</p>`;

                        // Iterar hijos (Subtítulos, Grupos, Items)
                        section.children.forEach(node => {

                            // SUBTÍTULO
                            if (node.type === 'subtitle') {
                                sHtml += `<div class="sidebar-subtitle-context">${node.title}</div>`;
                                pHtml += `<div class="subtitulo-container">
                                            <h3 class="subtitulo-title">${node.title}</h3>
                                            ${node.desc ? `<p class="subtitulo-desc">${node.desc}</p>` : ''}
                                          </div>`;
                            }

                            // AGRUPADOR (Accordion)
                            else if (node.type === 'group') {
                                const isOpen = openGroups.has(node.title);
                                const openClass = isOpen ? 'is-open' : '';
                                const rotateClass = isOpen ? 'rotate-180' : '';
                                const activeClass = isOpen ? 'bg-slate-100 text-secondary' : '';

                                // Sidebar: Botón Acordeón
                                sHtml += `<div class="mb-1">
                                    <button class="sidebar-item-accordion group ${activeClass}" aria-expanded="${isOpen}" onclick="UIHandlers.toggleAccordion(this)">
                                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-300 group-hover:text-primary transition-colors ${rotateClass}"></i>
                                        <span class="text-left tracking-wide">${node.title}</span>
                                    </button>
                                    <nav class="mt-1 sidebar-accordion-content space-y-1 ${openClass}">`;

                                node.items.forEach(item => {
                                    sHtml += `<a href="#sec-${item.id}" data-tid="${item.id}" class="sidebar-link child-link">${item.label}</a>`;
                                });
                                sHtml += `</nav></div>`;

                                // Panel: Contenedor Grupo
                                pHtml += `<div class="group-container">
                                            <div class="group-header">
                                                <h3 class="group-title">${node.title}</h3>
                                                <p class="text-xs text-slate-500 font-medium max-w-3xl">${node.desc}</p>
                                            </div>`;
                                node.items.forEach(item => {
                                    pHtml += this.renderItemPanel(item);
                                });
                                pHtml += `</div>`;
                            }

                            // ITEM SUELTO
                            else if (node.type === 'item') {
                                const iconSlug = DataService.slugify(node.label).replace(/-/g, '');
                                const matchedKey = Object.keys(APP_CONFIG.ICONS.ITEM).find(k => iconSlug.includes(k) || k.includes(iconSlug));
                                const iconName = APP_CONFIG.ICONS.ITEM[matchedKey] || "circle";

                                sHtml += `<div class="mb-1 space-y-1 mt-2">
                                            <a href="#sec-${node.id}" data-tid="${node.id}" class="sidebar-link group">
                                                <i data-lucide="${iconName}" class="w-4 h-4 text-slate-400 group-hover:text-primary transition-colors"></i>
                                                <span>${node.label}</span>
                                            </a>
                                          </div>`;
                                pHtml += this.renderItemPanel(node);
                            }
                        });

                        pHtml += `</div>`; // Cierre section-container
                    });

                    // 4. INYECCIÓN FINAL
                    if (sHtml === '') {
                        panel.innerHTML = `<div class="p-20 text-center animate-fade-in text-slate-400">Cargando catálogo...</div>`;
                        // Si falló algo grave silenciosamente, forzamos recarga segura
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        sidebar.innerHTML = sHtml;
                        panel.innerHTML = pHtml;
                        this.initObserver();
                    }

                } catch (err) {
                    console.error("Error Crítico UI:", err);
                    document.getElementById('tables-container').innerHTML = `<div class="p-8 text-center text-red-500">Error de Sistema: ${err.message}</div>`;
                }
            },

            // --- FASE 1: EL ARQUITECTO (Construcción Jerárquica corregida) ---
            buildHierarchy(rows) {
                const tree = [];

                // Estados persistentes del recorrido
                let activeSection = null;
                let activeSubtitle = null;
                let activeGroup = null;

                rows.forEach(row => {
                    const l1 = (row.nivel_1 || "").trim();
                    if (!l1) return;

                    // 1. NIVEL 1 (SECCIÓN)
                    // Si cambia la sección, reseteamos ABSOLUTAMENTE TODO
                    if (!activeSection || activeSection.rawTitle !== l1) {
                        activeSection = {
                            type: 'section',
                            title: l1.charAt(0).toUpperCase() + l1.slice(1).toLowerCase(),
                            rawTitle: l1,
                            displayTitle: row.nivel_1_titulo || l1,
                            desc: row.nivel_1_descripcion || '',
                            children: []
                        };
                        tree.push(activeSection);

                        // Reset de hijos
                        activeSubtitle = null;
                        activeGroup = null;
                    }

                    // 2. NIVEL SUBTÍTULO
                    const sub = (row.subtitulo || "").trim();
                    // Si hay subtítulo y es diferente al activo, creamos uno nuevo
                    if (sub && sub !== 'undefined') {
                        if (!activeSubtitle || activeSubtitle.title !== sub) {
                            activeSubtitle = {
                                type: 'subtitle',
                                title: sub,
                                desc: row.subtitulo_descripcion || ''
                            };
                            activeSection.children.push(activeSubtitle);

                            // IMPORTANTE: Cambio de subtítulo implica resetear grupo
                            activeGroup = null;
                        }
                    } else if (!sub) {
                        // Si la fila NO tiene subtítulo, limpiamos el estado activo
                        activeSubtitle = null;
                        // Opcional: ¿Debería resetear grupo? Depende de si un grupo puede cruzar fronteras de subtítulos vacíos.
                        // Por seguridad asumimos que sí.
                    }

                    // 3. NIVEL AGRUPADOR (ACORDEÓN)
                    const agp = (row.agrupador || "").trim();
                    if (agp) {
                        // Si hay grupo y es diferente al activo, creamos uno nuevo
                        if (!activeGroup || activeGroup.title !== agp) {
                            activeGroup = {
                                type: 'group',
                                title: agp,
                                desc: row.agrupador_descripcion || '',
                                items: []
                            };
                            activeSection.children.push(activeGroup);
                        }
                    } else {
                        // Si no hay grupo, el item va suelto
                        activeGroup = null;
                    }

                    // 4. NIVEL ITEM (HOJA)
                    const titleShort = row.nivel_3 || row.nivel_2 || "Item";
                    const rawId = row.tabla_id || (agp || sub || l1) + "-" + titleShort;
                    const cleanId = DataService.slugify(rawId);

                    const itemNode = {
                        type: 'item',
                        id: cleanId,
                        label: titleShort,
                        originalRow: row,
                        tablaId: row.tabla_id
                    };

                    // Asignación: Si hay grupo activo, va al grupo. Si no, directo a la sección.
                    if (activeGroup) {
                        activeGroup.items.push(itemNode);
                    } else {
                        activeSection.children.push(itemNode);
                    }
                });

                return tree;
            },

            // --- HELPER DE RENDERIZADO VISUAL ---
            renderItemPanel(node) {
                const row = node.originalRow;

                // Filtrado de Precios ESTRICTO (Igualdad exacta con tabla_id)
                let precios = [];
                if (row.tabla_id) {
                    const target = row.tabla_id.toLowerCase().trim();
                    precios = STATE.prices.filter(p => (p.tabla_id || "").toLowerCase().trim() === target);
                } else {
                    // Fallback LEGACY: Solo si no hay tabla_id explícito
                    // Usamos slugify para coincidencia aproximada, pero esto no debería ocurrir en data nueva
                    const filterName = node.label.toLowerCase();
                    precios = STATE.prices.filter(p => (p.tabla_id || "").toLowerCase().includes(DataService.slugify(filterName)));
                }

                let html = `<div id="sec-${node.id}" class="l2-container mb-10">`;

                // Título del Item Nivel 2 (si existe)
                const dispTitle = row.nivel_2_titulo || row.nivel_2;
                if (dispTitle) {
                    html += `<h4 class="l2-title">${dispTitle}</h4>
                             <p class="text-sm text-slate-400 font-medium mb-4">${row.nivel_2_descripcion || ''}</p>`;
                }

                html += this.createTable(row, precios);
                html += `</div>`;
                return html;
            },

            createTable(meta, items) {
                // NOTA: El ID de sección se maneja en renderItemPanel. Esta función solo genera la tabla.

                // LÓGICA DE PARSEO DE NOTAS AVANZADO (Smart Grid + Blocks)
                const rawNotas = items.map(i => i.notas).filter(n => n && n.trim().length > 0);

                // Procesamiento de Bloques HTML
                const processedBlocks = [];

                rawNotas.forEach(raw => {
                    // 1. Separar por Bloques (^)
                    // El símbolo ^ actúa como un "Enter" fuerte, separando párrafos o listas
                    const blocks = raw.split('^').map(b => b.trim()).filter(b => b.length > 0);

                    blocks.forEach(block => {
                        // 2. Detectar Listas (|)
                        if (block.includes('|')) {
                            // Es una lista: Separamos items por pipe
                            const listItems = block.split('|').map(i => i.trim()).filter(i => i.length > 0);

                            if (listItems.length > 0) {
                                // Renderizar como Grid List
                                const listHtml = `<ul class="note-grid-list">
                                    ${listItems.map(item => `<li>${item}</li>`).join('')}
                                </ul>`;
                                processedBlocks.push(listHtml);
                            }
                        } else {
                            // Es texto normal: Renderizar como párrafo
                            processedBlocks.push(`<p class="note-text">${block}</p>`);
                        }
                    });
                });

                // Deduplicar bloques idénticos (por si varios productos tienen la misma nota base)
                const uniqueBlocks = [...new Set(processedBlocks)];

                const showTitle = !!meta.nivel_3;
                const titleLong = meta.nivel_3_titulo || meta.nivel_3;

                return `<section class="mb-8">
                    ${showTitle ? `<h5 class="text-xl font-black text-secondary mb-3 section-title-n3">${titleLong}</h5>
                                   <p class="text-xs text-slate-400 mb-6 font-bold tracking-tight">${meta.nivel_3_descripcion || ''}</p>` : ''}

                    ${items.length ? `<div class="data-grid-container">
                        <table class="data-grid">
                            <thead>
                                <tr>
                                    <th class="pl-6">Producto</th>
                                    <th class="text-right professional-only text-emerald-600">Precio farmacia</th>
                                    <th class="text-right pr-6">Precio público</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(p => `
                                <tr class="hover:bg-slate-100 transition-colors">
                                    <td class="pl-6 product-name">
                                        <div class="font-medium text-secondary text-sm">${p.producto}</div>
                                        <div class="text-[10px] text-slate-400 font-bold tracking-tight">${p.presentacion || ''}</div>
                                    </td>
                                    <td class="text-right professional-only font-bold text-emerald-600" data-label="Farmacia">${this.formatPrice(p.precio_farmacia)}</td>
                                    <td class="text-right font-black text-secondary pr-6" data-label="Público">${this.formatPrice(p.precio_publico)}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>` : '<p class="text-xs text-slate-400 italic pl-4">Catálogo en actualización</p>'}

                    ${uniqueBlocks.length ? `<div class="mt-4 notes-container">
                        <p class="text-[11px] font-black text-slate-700 tracking-widest mb-3"><i data-lucide="info" class="w-3.5 h-3.5 inline mr-1 text-emerald-500"></i> Información adicional:</p>
                        <div class="space-y-4">
                            ${uniqueBlocks.join('')}
                        </div>
                    </div>` : ''}
                </section>`;
            },

            renderContactItems() {
                const distContainer = document.getElementById('distributors-grid');
                if (!distContainer) return;

                if (!STATE.dist.length) {
                    distContainer.innerHTML = '<p class="text-slate-400 italic col-span-2 text-center">Cargando la red de distribuidores...</p>';
                    return;
                }

                // Helper local para Title Case
                const toTitleCase = (str) => {
                    return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                };

                // 1. Separar Sede Principal y Distribuidores
                const headquarters = [];
                const distributors = [];

                STATE.dist.forEach(d => {
                    // Detectar sede principal por nombre (insensible a mayúsculas)
                    if (d.sede && d.sede.toLowerCase().includes('principal')) {
                        headquarters.push(d);
                    } else {
                        distributors.push(d);
                    }
                });

                let html = '';

                // 2. Renderizar Sede Principal (Diseño Destacado Premium)
                if (headquarters.length > 0) {
                    // LÓGICA DE ACTUALIZACIÓN DEL SIDEBAR (Punto 11)
                    // Tomamos la primera sede principal como la "Oficial" para el sidebar
                    const mainHQ = headquarters[0];
                    const mainWA = mainHQ.whatsapp_1; // Asumimos columna whatsapp_1

                    if (mainWA) {
                        const btnSidebar = document.getElementById('btn-whatsapp-sidebar');
                        if (btnSidebar) {
                            const cleanNum = Formatters.whatsapp(mainWA);
                            const msg = encodeURIComponent("Hola Mundo Homeopático, requiero información sobre distribución y precios.");
                            btnSidebar.href = `https://wa.me/${cleanNum}?text=${msg}`;
                        }
                    }

                    headquarters.forEach(hq => {
                        // Lógica de Logos Personalizados (Punto 8)
                        let logoName = 'logo-mundo-homeopatico'; // Default
                        const sedeLower = hq.sede.toLowerCase();

                        if (sedeLower.includes('cafetero')) logoName = 'logo-mundo-homeopatico';
                        else if (sedeLower.includes('atlantica') || sedeLower.includes('atlántica')) logoName = 'logo-biomedic';
                        else if (sedeLower.includes('santander')) logoName = 'logo-mundo-homeopatico';
                        else if (sedeLower.includes('cordoba') || sedeLower.includes('córdoba')) logoName = 'logo-eco-natural';

                        html += `<div class="col-span-1 md:col-span-2 mb-8 animate-fade-in">
                            <div class="bg-gradient-to-br from-emerald-50 to-white border border-emerald-100 rounded-lg p-8 relative overflow-hidden group hover:shadow-lg transition-all">
                                <!-- Decoración de fondo -->
                                <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-100 rounded-full blur-3xl -mr-16 -mt-16 opacity-50"></div>
                                
                                <div class="relative z-10 flex flex-col md:flex-row gap-8 items-start">
                                    <div class="flex-shrink-0 bg-white p-4 rounded-lg shadow-sm border border-emerald-50">
                                        <img src="img/${logoName}.webp" alt="Logo Sede" class="w-20 h-20 object-contain" onerror="this.src='https://placehold.co/80x80?text=MH'">
                                    </div>
                                    <div class="flex-grow">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-[10px] font-black capitalize tracking-wide rounded-full">Sede principal</span>
                                            <h4 class="text-2xl font-black text-secondary tracking-tight">${toTitleCase(hq.sede)}</h4>
                                        </div>
                                        
                                        <!-- UBICACIÓN FÍSICA AÑADIDA -->
                                        ${hq.direccion ?
                                `<p class="flex items-center gap-2 text-slate-500 mb-4 font-medium">
                                            <i data-lucide="map-pin" class="w-4 h-4 text-emerald-500"></i> ${hq.direccion}
                                         </p>` : ''}
                                        
                                        <div class="flex flex-wrap gap-3 mt-6">
                                            ${this.generateContactButtons(hq)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    });
                }

                // 3. Renderizar Distribuidores (Business Card Moderno)
                distributors.forEach(d => {
                    html += `<div class="contact-card group animate-fade-in">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="contact-card-icon">
                                <i data-lucide="store" class="w-5 h-5 transition-colors"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-base text-secondary leading-tight mb-1">${toTitleCase(d.sede)}</h4>
                                <p class="text-[11px] font-bold text-emerald-600 capitalize tracking-wide">${(d.departamento || 'Colombia').toLowerCase()}</p>
                            </div>
                        </div>
                        
                        <div class="space-y-2 mb-4 flex-grow">
                            ${d.direccion ? `<p class="text-sm text-slate-500 flex items-start gap-2 leading-relaxed">
                                <i data-lucide="map-pin" class="w-3.5 h-3.5 mt-1 flex-shrink-0 opacity-40"></i>
                                <span>${d.direccion}</span>
                            </p>` : ''}
                            ${d.horarios ? `<p class="text-xs text-slate-400 flex items-start gap-2 leading-relaxed">
                                <i data-lucide="clock" class="w-3.5 h-3.5 mt-0.5 flex-shrink-0 opacity-40"></i>
                                <span>${d.horarios}</span>
                            </p>` : ''}
                        </div>

                        <div class="flex flex-wrap gap-2 pt-4 border-t border-slate-50 mt-auto">
                            ${this.generateContactButtons(d)}
                        </div>
                    </div>`;
                });

                distContainer.innerHTML = html;
            },

            // Helper para generar botones inteligentes (WhatsApp vs Teléfono vs Fijo)
            generateContactButtons(data) {
                let buttons = '';

                // WhatsApps (Iteramos hasta 4 columnas posibles)
                [1, 2, 3, 4].forEach(i => {
                    const wa = data[`whatsapp_${i}`];
                    if (wa) {
                        buttons += `<a href="https://wa.me/${Formatters.whatsapp(wa)}" target="_blank"
        class="inline-flex items-center gap-2 px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-bold hover:bg-emerald-100 transition-colors transform hover:-translate-y-0.5">
            <i data-lucide="message-circle" class="w-3.5 h-3.5"></i> ${Formatters.formatPhone(wa)}
                        </a>`;
                    }
                });

                // Móviles (Llamada directa)
                [1, 2].forEach(i => {
                    const mob = data[`movil_${i}`];
                    if (mob) {
                        buttons += `<a href="tel:${mob}" class="inline-flex items-center gap-2 px-3 py-1.5 bg-slate-50 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-100 transition-colors">
            <i data-lucide="smartphone" class="w-3.5 h-3.5"></i> ${Formatters.formatPhone(mob)}
                        </a>`;
                    }
                });

                // Fijos (Solo visualización)
                [1, 2].forEach(i => {
                    const fix = data[`telefono_fijo_${i}`];
                    if (fix) {
                        buttons += `<div class="inline-flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-100 text-slate-400 rounded-lg text-xs font-medium cursor-default">
            <i data-lucide="phone" class="w-3.5 h-3.5"></i> ${fix}
                        </div>`;
                    }
                });

                return buttons;
            },

            renderFAQ() {
                const faqCont = document.getElementById('faq-container');
                if (faqCont && STATE.faq.length) {
                    // FAQ CONTROLADO: Botones + JS para comportamiento exclusivo
                    faqCont.innerHTML = STATE.faq.map((f, index) => {
                        const q = f.pregunta || f.Pregunta || f.PREGUNTA || "Pregunta pendiente";
                        const a = f.respuesta || f.Respuesta || f.RESPUESTA || "Respuesta en proceso...";
                        return `<div class="bg-white rounded-lg border border-slate-100 overflow-hidden transition-all duration-300 hover:shadow-md">
                            <button onclick="UIHandlers.toggleFaq(this)" class="faq-trigger w-full flex justify-between items-center p-6 text-left" aria-expanded="false">
                                <span class="font-bold text-sm text-secondary pr-4">${q}</span>
                                <i data-lucide="chevron-down" class="w-5 h-5 text-slate-300 transition-transform duration-300 flex-shrink-0"></i>
                            </button>
                            <div class="faq-answer-container hidden px-6 pb-6 pt-0">
                                <div class="text-xs text-slate-500 font-medium leading-relaxed border-t border-slate-50 pt-4 animate-fade-in">
                                    ${a}
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                } else if (faqCont) {
                    faqCont.innerHTML = '<p class="text-slate-400 italic">Cargando preguntas frecuentes...</p>';
                }
            },
            formatPrice: (v) => {
                if (!v || v === '-') return '-';
                const str = String(v).replace(/\D/g, '');
                return str ? `$ ${parseInt(str).toLocaleString('es-CO')} ` : '-';
            },
            initObserver() {
                // OBSERVER MEJORADO: Margen ajustado para detectar mejor el centro de la pantalla
                const obs = new IntersectionObserver((es) => {
                    // SI ES SCROLL MANUAL O INTERACCIÓN EN SIDEBAR, IGNORAR AL OBSERVER
                    if (UIHandlers.isManualScroll || UIHandlers.isInteracting) return;

                    es.forEach(e => {
                        if (e.isIntersecting) {
                            // Quitar active de todo
                            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                            // Poner active al correspondiente
                            const link = document.querySelector(`.sidebar - link[data - tid="${e.target.id.replace('sec-', '')}"]`);
                            if (link) {
                                link.classList.add('active');
                                // ELIMINADO: Auto-apertura de acordeón desde el Observer.
                                // Causa conflicto cuando el usuario explora el menú mientras ve otra sección.
                            }
                        }
                    });
                }, {
                    root: null, // viewport
                    rootMargin: '-20% 0px -60% 0px', // Zona activa en el centro-superior de la pantalla
                    threshold: 0
                });

                document.querySelectorAll('section[id]').forEach(s => obs.observe(s));
            }
        };



        document.addEventListener('DOMContentLoaded', async () => {

            UIHandlers.init();
            UIHandlers.initNavigation(); // Activar el nuevo motor de clicks

            // Sincronización Inteligente: Cargar Caché -> Renderizar -> Fetch Background -> Actualizar
            const keys = {
                prices: 'mh_cache_prices',
                nav: 'mh_cache_nav',
                faq: 'mh_cache_faq',
                dist: 'mh_cache_dist'
            };

            // Flag para evitar doble render
            let hasRenderedFromCache = false;

            // 1. Renderizado Inmediato desde Caché (si existe)
            try {
                const cachedPrices = localStorage.getItem(keys.prices);
                const cachedNav = localStorage.getItem(keys.nav);
                const cachedFaq = localStorage.getItem(keys.faq);
                const cachedDist = localStorage.getItem(keys.dist);

                if (cachedPrices && cachedNav) {
                    STATE.prices = JSON.parse(cachedPrices);
                    STATE.nav = JSON.parse(cachedNav);
                    STATE.faq = cachedFaq ? JSON.parse(cachedFaq) : [];
                    STATE.dist = cachedDist ? JSON.parse(cachedDist) : [];
                    console.log('⚡ Renderizado inicial (Caché)');
                    RenderEngine.renderAll();
                    hasRenderedFromCache = true;
                }
            } catch (e) { console.error('Error leyendo caché', e); }

            // 2. Fetch Background (Estrategia Stale-While-Revalidate)
            // Carga de recursos secundarios (no bloqueantes)
            DataService.fetchCSV(APP_CONFIG.SHEETS.AUTHOR).then(d => {
                if (d && d[0]) {
                    const l = document.getElementById('author-link');
                    l.textContent = d[0].nombre || ""; l.href = d[0].url || "#";
                    document.getElementById('author-credit').classList.remove('opacity-0');
                }
            });
            DataService.fetchCSV(APP_CONFIG.SHEETS.BANNER).then(d => {
                if (localStorage.getItem('mh_banner_closed') === 'true') return;

                const bannerTextEl = document.getElementById('bannerText');
                if (d && d[0] && d[0].mensaje && bannerTextEl) {
                    const bw = document.getElementById('bannerWrapper');
                    bannerTextEl.textContent = d[0].mensaje;
                    bw.classList.remove('collapsed');
                    document.body.classList.add('has-banner');
                }
            });
            DataService.fetchCSV(APP_CONFIG.SHEETS.VIDEO).then(d => {
                if (d && d[0] && d[0].url) {
                    const videoId = d[0].url.split('v=')[1]?.split('&')[0] || d[0].url.split('/').pop();
                    if (!videoId) return;

                    // Renderizar FACHADA (Imagen + Botón) en lugar de Iframe pesado
                    const container = document.getElementById('videoContainer');
                    if (container) {
                        container.innerHTML = `
            <div class="youtube-facade w-full h-full group" onclick="UIHandlers.loadVideo(this, '${videoId}')">
                <img src="https://img.youtube.com/vi/${videoId}/maxresdefault.jpg" alt="Video de Calidad"
                    onerror="this.src='https://img.youtube.com/vi/${videoId}/hqdefault.jpg'"> <!-- Fallback a HQ si no hay MaxRes -->
                    <div class="play-button shadow-2xl"></div>
            </div>`;
                    }
                }
            });

            try {
                // Activar Barra de Carga Real
                UIHandlers.showLoading(true);

                const [p, n, f, dist, auth] = await Promise.all([
                    DataService.fetchCSV(APP_CONFIG.SHEETS.PRICES),
                    DataService.fetchCSV(APP_CONFIG.SHEETS.NAV),
                    DataService.fetchCSV(APP_CONFIG.SHEETS.FAQ),
                    DataService.fetchCSV(APP_CONFIG.SHEETS.DIST),
                    DataService.fetchCSV(APP_CONFIG.SHEETS.AUTH)
                ]);

                // Actualizar Estado y Caché
                if (p.length) { STATE.prices = p; localStorage.setItem(keys.prices, JSON.stringify(p)); }
                if (n.length) { STATE.nav = n; localStorage.setItem(keys.nav, JSON.stringify(n)); }
                if (f.length) { STATE.faq = f; localStorage.setItem(keys.faq, JSON.stringify(f)); }
                if (dist.length) { STATE.dist = dist; localStorage.setItem(keys.dist, JSON.stringify(dist)); }
                if (auth && auth.length) { STATE.auth = auth; console.log('🔐 Accesos cargados'); }

                // Finalizar Barra de Carga
                UIHandlers.showLoading(false);

                // Actualizar UI con datos frescos SOLO si no había caché
                if (p.length && n.length) {
                    console.log('📦 Caché actualizada (silencioso)');
                    // Solo re-renderizamos si es primera visita (sin caché previa)
                    if (!hasRenderedFromCache) {
                        RenderEngine.renderAll();
                    }
                } else if (!hasRenderedFromCache) {
                    // Solo alertamos si no teníamos nada que mostrar
                    alert("¡Atención! No se pudieron descargar los datos de Google Sheets. Verifica tu conexión a internet.");
                    console.error("Fetch fallido: p.length=" + p.length + ", n.length=" + n.length);
                }
            } catch (error) {
                console.error('Error en sincronización:', error);
                if (STATE.prices.length === 0) {
                    document.getElementById('tables-container').innerHTML = `<div class="p-8 text-center text-red-500 font-bold">Error de conexión. Intente recargar.</div>`;
                }
            }
        });
    </script>
</body>

</html>